[
    {
        "change_date": 1762249292318.0,
        "changed_by": {
            "id": "4d82ae0d-2047-4c83-ac8c-e2da04a3b5a0",
            "name": "Brave Gujral",
            "type_": "USER"
        },
        "created_by": {
            "id": "4d82ae0d-2047-4c83-ac8c-e2da04a3b5a0",
            "name": "Brave Gujral",
            "type_": "USER"
        },
        "creation_date": 1752758903178.0,
        "data_connection_id": "03736e95-3931-4eda-8dfe-fc16e11388bc",
        "description": null,
        "disabled": null,
        "display_name": "StockHistory - OracleFusion",
        "draft": null,
        "factory_id": "f1395ec5-cafb-4607-9390-9b4799f08bfb",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "sourceSystem",
                "value": "'Oracle_Fusion'"
            },
            {
                "name": "stockHistoryYears",
                "value": "2"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "StockHistory",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [],
                "foreign_key_names": [
                    "MaterialMasterPlant"
                ],
                "namespace": "custom",
                "property_names": [
                    "ID",
                    "Period",
                    "SourceSystemInstance",
                    "StockKeepingUnit",
                    "UnitPriceAmount",
                    "ValuatedStockAmount",
                    "ValuatedStockQuantity"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "StockHistoryAttributes",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "WITH\n    \"CTE_Reduce_Calendar\" AS (\n        SELECT\n            \"CELONIS_CALENDAR\".\"LastDayOfMonth\",\n            \"CELONIS_CALENDAR\".\"Year\",\n            LPAD(CAST(\"CELONIS_CALENDAR\".\"Month\" AS VARCHAR(2)), 2, '0') AS \"Month\"\n        FROM \"CELONIS_CALENDAR\"\n        GROUP BY\n            \"LastDayOfMonth\",\n            \"Year\",\n            \"Month\"\n    ),\n    \"CTE_Date_Range\" AS (\n        SELECT\n            \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"INVENTORY_ITEM_ID\",\n            \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"ORGANIZATION_ID\",\n            MIN(\"Reduce_Calendar\".\"LastDayOfMonth\") AS \"MinDate\"\n        FROM \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\" AS \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\"\n        LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n            ON \"Reduce_Calendar\".\"YEAR\" = YEAR(\"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"EndOfMonth\")\n            AND \"Reduce_Calendar\".\"Month\" = MONTH(\"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"EndOfMonth\")\n        GROUP BY \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"INVENTORY_ITEM_ID\",\n                 \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"ORGANIZATION_ID\"\n        ORDER BY 1, 2\n    ),\n    \"CTE_Calendar\" AS (\n        SELECT\n            \"Date_Range\".\"INVENTORY_ITEM_ID\",\n            \"Date_Range\".\"ORGANIZATION_ID\",\n            \"Reduce_Calendar\".\"LastDayOfMonth\" AS \"DateRange\",\n            \"Reduce_Calendar\".\"Year\"           AS \"Year\",\n            \"Reduce_Calendar\".\"Month\"          AS \"Month\"\n        FROM \"CTE_Date_Range\" AS \"Date_Range\"\n        LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n            ON \"Date_Range\".\"MinDate\" <= \"Reduce_Calendar\".\"LastDayOfMonth\"\n            AND \"Reduce_Calendar\".\"LastDayOfMonth\" < TIMESTAMPADD(month, 1, NOW())\n    ),\n    \"CTE_Calendar_Merge\" AS (\n        SELECT\n            COALESCE(\n                \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"StockHistoryID\",\n                \"Calendar\".\"INVENTORY_ITEM_ID\" \n                || '::' || \"Calendar\".\"ORGANIZATION_ID\" \n                || '::' || LAST_DAY(\"Calendar\".\"DateRange\")\n            )                                                                   AS \"StockHistoryID\",\n            CAST(\"Calendar\".\"DateRange\" AS TIMESTAMP)                           AS \"DateRange\",\n            \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"ValuatedStockQuantity\" AS \"ValuatedStockQuantity\",\n            \"MTL_SYSTEM_ITEMS_B\".\"ItemBasePEOListPricePerUnit\"                  AS \"UnitPriceAmount\",\n            \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"ValuatedStockQuantity\" \n            * \"MTL_SYSTEM_ITEMS_B\".\"ItemBasePEOListPricePerUnit\"                AS \"ValuatedStockAmount\",\n            \"GL_LEDGERS\".\"LedgerCurrencyCode\"                                   AS \"BaseCurrency\", \n            \"MTL_SYSTEM_ITEMS_B\".\"ItemBasePEOPrimaryUomCode\"                    AS \"QuantityUnit\",\n            \"Calendar\".\"ORGANIZATION_ID\" \n            || '::' || \"Calendar\".\"INVENTORY_ITEM_ID\"                           AS \"MaterialMasterPlant\",\n            <%=sourceSystem%>                                                   AS \"Client\"\n        FROM \"CTE_Calendar\" AS \"Calendar\"\n        INNER JOIN \"FscmTopModelAM_ScmExtractAM_EgpBiccExtractAM_ItemExtractPVO\" AS \"MTL_SYSTEM_ITEMS_B\"\n            ON \"Calendar\".\"INVENTORY_ITEM_ID\" = \"MTL_SYSTEM_ITEMS_B\".\"ItemBasePEOInventoryItemId\"\n            AND \"Calendar\".\"ORGANIZATION_ID\" = \"MTL_SYSTEM_ITEMS_B\".\"ItemBasePEOInventoryOrganizationId\"\n        LEFT JOIN \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\" AS \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\"\n            ON \"Calendar\".\"INVENTORY_ITEM_ID\" = \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"INVENTORY_ITEM_ID\"\n            AND \"Calendar\".\"ORGANIZATION_ID\" = \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"ORGANIZATION_ID\"\n            AND \"Calendar\".\"DateRange\" = \"INVENTORY_LEVELS_FUSION_CELONIS_CHANGELOG\".\"EndOfMonth\"\n      --  LEFT JOIN \"FscmTopModelAM_FinExtractAM_FunBiccExtractAM_BusinessUnitExtractPVO\" AS \"HR_ALL_ORGANIZATION_UNITS\"\n      --      ON \"Calendar\".\"ORGANIZATION_ID\" = \"HR_ALL_ORGANIZATION_UNITS\".\"ORGANIZATION_ID\"\n        LEFT JOIN \"FscmTopModelAM_InvOrgPublicViewAM_InventoryOrgParametersPVO\" AS \"ORG_ORGANIZATION_DEFINITIONS\"\n            ON \"Calendar\".\"ORGANIZATION_ID\" = \"ORG_ORGANIZATION_DEFINITIONS\".\"OrganizationId\"\n        LEFT JOIN \"FscmTopModelAM_FinExtractAM_GlBiccExtractAM_LedgerExtractPVO\" AS \"GL_LEDGERS\"\n            ON \"ORG_ORGANIZATION_DEFINITIONS\".\"OrgOrganizationDefinitionsPSetOfBooksId\" = \"GL_LEDGERS\".\"LedgerLedgerId\"\n    ),\n    -- Fill the gaps in the timeline with the previous value\n    \"CTE_FillGap\" AS (\n        -- Recreate months where no change was happening\n         SELECT \"Calendar_Merge\".\"StockHistoryID\"                          AS \"ID\",\n                CAST(\"Calendar_Merge\".\"DateRange\" AS TIMESTAMP)            AS \"CurrentPeriod\",\n                COALESCE(CAST(\"ValuatedStockQuantity\" AS FLOAT),\n                         CAST((LAST_VALUE(\"ValuatedStockQuantity\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS FLOAT), \n                         CAST((FIRST_VALUE(\"ValuatedStockQuantity\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING)) AS FLOAT),0\n                ,0)        --handling 0 values in case of no Onhand entries\n                                                                           AS \"ValuatedStockQuantity\",\n                COALESCE(CAST(\"ValuatedStockAmount\" AS FLOAT),\n                         CAST((LAST_VALUE(\"ValuatedStockAmount\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS FLOAT),\n                         CAST((FIRST_VALUE(\"ValuatedStockAmount\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING)) AS FLOAT),0\n                ,0)                                                        AS \"ValuatedStockAmount\",\n                \"Calendar_Merge\".\"UnitPriceAmount\"                         AS \"UnitPriceAmount\",\n                \"Calendar_Merge\".\"QuantityUnit\"                            AS \"QuantityUnit\",\n                \"Calendar_Merge\".\"MaterialMasterPlant\"                     AS \"MaterialMasterPlant\",\n                <%=sourceSystem%>                                          AS \"SourceSystemType\"\n          FROM \"CTE_Calendar_Merge\" AS \"Calendar_Merge\")\n-- Filter last two years\n-- This is needed in a seperate query that the LAST/FIRST_VALUE fills the empty rows\nSELECT <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"ID\"                  AS \"ID\",\n       \"Calendar_Merge\".\"CurrentPeriod\"                                    AS \"Period\",\n       \"Calendar_Merge\".\"ValuatedStockQuantity\"                            AS \"ValuatedStockQuantity\",\n       \"Calendar_Merge\".\"ValuatedStockAmount\"                              AS \"ValuatedStockAmount\",\n       \"Calendar_Merge\".\"UnitPriceAmount\"                                  AS \"UnitPriceAmount\",\n       \"Calendar_Merge\".\"QuantityUnit\"                                     AS \"StockKeepingUnit\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"MaterialMasterPlant\" AS \"MaterialMasterPlant\",\n       <%=sourceSystem%>                                                   AS \"SourceSystemInstance\"\nFROM \"CTE_FillGap\" AS \"Calendar_Merge\"\nWHERE \"CurrentPeriod\" >= TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%> - 1), NOW())"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    },
    {
        "change_date": 1761559005420.0,
        "changed_by": {
            "id": "ae9989fc-2640-4ab1-9754-cb31999ce77e",
            "name": "j.rosenbauer",
            "type_": "USER"
        },
        "created_by": {
            "id": "2202cbc9-7251-4630-bfb2-36812e688613",
            "name": "l.pigozzi",
            "type_": "USER"
        },
        "creation_date": 1749649899338.0,
        "data_connection_id": "8939ad05-4472-435c-a065-ed31be1b9fea",
        "description": null,
        "disabled": null,
        "display_name": "StockHistory - 00. SAP S/4 HANA Extraction Pool_S4H-HANA",
        "draft": null,
        "factory_id": "35817d36-e13c-4b3a-9b28-e745312e28f5",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "SI-Unit",
                "value": "'ST'"
            },
            {
                "name": "sourceSystem",
                "value": "'SAP_S4_HANA'"
            },
            {
                "name": "stockHistoryYears",
                "value": "2"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "StockHistory",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [],
                "foreign_key_names": [
                    "MaterialMasterPlant"
                ],
                "namespace": "custom",
                "property_names": [
                    "ID",
                    "Period",
                    "SourceSystemInstance",
                    "StockKeepingUnit",
                    "UnitPriceAmount",
                    "ValuatedStockAmount",
                    "ValuatedStockQuantity"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "StockHistoryAttributes",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "-- S/4 HANA only\nWITH\n    \"CTE_Reduce_Calendar\" AS (SELECT \"CELONIS_CALENDAR\".\"LastDayOfMonth\",\n                                     \"CELONIS_CALENDAR\".\"Year\",\n                                     LPAD(CAST(\"CELONIS_CALENDAR\".\"Month\" AS VARCHAR(2)), 2, '0') AS \"Month\"\n                              FROM \"CELONIS_CALENDAR\"\n                              GROUP BY \"LastDayOfMonth\", \"Year\", \"Month\"),\n    \"CTE_Date_Range_MBVMBEWHBASE\" AS (SELECT \"MBVMBEWHBASE\".\"MANDT\"                  AS \"MANDT\",\n                                      \"MBVMBEWHBASE\".\"MATNR\"                         AS \"MATNR\",\n                                      \"MBVMBEWHBASE\".\"BWKEY\"                         AS \"BWKEY\",\n                                      MIN(\"Reduce_Calendar\".\"LastDayOfMonth\")        AS \"MinDate\"\n                               FROM \"MBVMBEWHBASE\" AS \"MBVMBEWHBASE\"\n                                        LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                                  ON \"MBVMBEWHBASE\".\"LFGJA\" = \"Reduce_Calendar\".\"YEAR\"\n                                                      AND \"MBVMBEWHBASE\".\"LFMON\" = \"Reduce_Calendar\".\"Month\"\n                               WHERE NULLIF(\"MBVMBEWHBASE\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                               GROUP BY \"MBVMBEWHBASE\".\"MANDT\", \"MBVMBEWHBASE\".\"MATNR\", \"MBVMBEWHBASE\".\"BWKEY\"),\n    -- Based on the Calender take the end of the month to get the current period of a Material and Plant and create a\n    -- timeseries from the first month where a material movement was happening to the current date\n    \"CTE_Calendar\" AS (SELECT \"Date_Range_MBVMBEWHBASE\".\"MANDT\"                      AS \"MANDT\",\n                              \"Date_Range_MBVMBEWHBASE\".\"MATNR\"                      AS \"MATNR\",\n                              \"Date_Range_MBVMBEWHBASE\".\"BWKEY\"                      AS \"BWKEY\",\n                              CAST(\"Reduce_Calendar\".\"LastDayOfMonth\" AS TIMESTAMP)  AS \"DateRange\",\n                              \"Reduce_Calendar\".\"Year\"                               AS \"Year\",\n                              \"Reduce_Calendar\".\"Month\"                              AS \"Month\"\n                       FROM \"CTE_Date_Range_MBVMBEWHBASE\" AS \"Date_Range_MBVMBEWHBASE\"\n                                LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                          ON \"Date_Range_MBVMBEWHBASE\".\"MinDate\" <= \"Reduce_Calendar\".\"LastDayOfMonth\"\n                                              AND \"Reduce_Calendar\".\"LastDayOfMonth\" <= CAST(\n                                                      TIMESTAMPADD(DAY, -1, TIMESTAMPADD(MONTH, 1,\n                                                                                         CAST(YEAR(NOW()) || '-' || MONTH(NOW()) || '-01' AS DATE))) AS DATE)),\n    -- Union History and current Information into one table\n    \"CTE_MBEW_AGG\" AS (SELECT \"MBVMBEWHBASE\".\"MANDT\",\n                              \"MBVMBEWHBASE\".\"MATNR\",\n                              \"MBVMBEWHBASE\".\"BWKEY\",\n                              \"MBVMBEWHBASE\".\"LFGJA\",\n                              \"MBVMBEWHBASE\".\"LFMON\",\n                              \"MBVMBEWHBASE\".\"LBKUM\",\n                              \"MBVMBEWHBASE\".\"SALK3\",\n                              \"MBVMBEWHBASE\".\"VERPR\",\n                              \"MBVMBEWHBASE\".\"STPRS\",\n                              \"MBVMBEWHBASE\".\"PEINH\",\n                              \"MBVMBEWHBASE\".\"VPRSV\"\n                       FROM \"MBVMBEWHBASE\" AS \"MBVMBEWHBASE\"\n                       WHERE NULLIF(\"MBVMBEWHBASE\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                       UNION ALL\n                       SELECT \"MBVMBEWBASE\".\"MANDT\",\n                              \"MBVMBEWBASE\".\"MATNR\",\n                              \"MBVMBEWBASE\".\"BWKEY\",\n                              \"MBVMBEWBASE\".\"LFGJA\",\n                              \"MBVMBEWBASE\".\"LFMON\",\n                              \"MBVMBEWBASE\".\"LBKUM\",\n                              \"MBVMBEWBASE\".\"SALK3\",\n                              \"MBVMBEWBASE\".\"VERPR\",\n                              \"MBVMBEWBASE\".\"STPRS\",\n                              \"MBVMBEWBASE\".\"PEINH\",\n                              \"MBVMBEWBASE\".\"VPRSV\"\n                       FROM \"MBVMBEWBASE\" AS \"MBVMBEWBASE\"\n                       WHERE NULLIF(\"MBVMBEWBASE\".\"BWTAR\", '') IS NULL),    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n    -- Merge the CTE_Calendar Table with the Stock History Table and add the aggregation for consumption and replenishment from the material movement\n    \"CTE_Calendar_Merge_Temp\"\n        AS (SELECT DISTINCT \"Calendar\".\"MANDT\" || '::' || \"Calendar\".\"MATNR\" || '::' || \"Calendar\".\"BWKEY\"\n                   || '::' || \"Calendar\".\"Year\" || '::' || \"Calendar\".\"Month\"   AS \"StockHistoryID\",\n                   \"Calendar\".\"DateRange\"                                       AS \"CurrentPeriod\",\n                   \"MBEW_AGG\".\"MATNR\"                                           AS \"MaterialNumber\",\n                   \"MBEW_AGG\".\"LBKUM\"                                           AS \"ValuatedStockQuantity\",\n                   \"MBEW_AGG\".\"SALK3\"                                           AS \"ValuatedStockAmount\",\n                   CASE\n                       WHEN \"MBEW_AGG\".\"VPRSV\" = 'V' THEN COALESCE(\n                               \"MBEW_AGG\".\"VERPR\" / NULLIF(\"MBEW_AGG\".\"PEINH\", 0),\n                               \"MBEW_AGG\".\"VERPR\")\n                       WHEN \"MBEW_AGG\".\"VPRSV\" = 'S' THEN COALESCE(\n                               \"MBEW_AGG\".\"STPRS\" / NULLIF(\"MBEW_AGG\".\"PEINH\", 0),\n                               \"MBEW_AGG\".\"STPRS\")\n                       ELSE \"MBEW_AGG\".\"SALK3\" / NULLIF(\"MBEW_AGG\".\"LBKUM\", 0)\n                    END                                    AS \"UnitPriceAmount\",\n                    CASE\n                        WHEN \"T006\".\"DIMID\" != 'AAAADL'\n                            THEN \"T006D\".\"MSSIE\"\n                        WHEN \"T006\".\"DIMID\" = 'AAAADL'\n                            THEN \"MARM\".\"MEINH\"\n                    END                                                         AS \"StockKeepingUnit\",\n                   \"Calendar\".\"MANDT\" || '::' || \"Calendar\".\"MATNR\" || '::' || \"Calendar\".\"BWKEY\"                      AS \"MaterialMasterPlant_ID\",\n                   \"Calendar\".\"MANDT\"                                           AS \"Client\"\n            FROM \"CTE_Calendar\" AS \"Calendar\"\n                     LEFT JOIN \"CTE_MBEW_AGG\" AS \"MBEW_AGG\"\n                               ON \"Calendar\".\"MANDT\" = \"MBEW_AGG\".\"MANDT\"\n                                   AND \"Calendar\".\"MATNR\" = \"MBEW_AGG\".\"MATNR\"\n                                   AND \"Calendar\".\"BWKEY\" = \"MBEW_AGG\".\"BWKEY\"\n                                   AND \"Calendar\".\"Year\" = \"MBEW_AGG\".\"LFGJA\"\n                                   AND \"Calendar\".\"Month\" = \"MBEW_AGG\".\"LFMON\"\n                     LEFT JOIN \"T001K\" AS \"T001K\"\n                               ON \"MBEW_AGG\".\"MANDT\" = \"T001K\".\"MANDT\"\n                                   AND \"MBEW_AGG\".\"BWKEY\" = \"T001K\".\"BWKEY\"\n                     LEFT JOIN \"T001\" AS \"T001\"\n                               ON \"T001K\".\"MANDT\" = \"T001\".\"MANDT\"\n                                   AND \"T001K\".\"BUKRS\" = \"T001\".\"BUKRS\"\n                     LEFT JOIN \"MARA\" AS \"MARA\"\n                               ON \"MARA\".\"MANDT\" = \"Calendar\".\"MANDT\"\n                                   AND \"MARA\".\"MATNR\" = \"Calendar\".\"MATNR\"\n                     LEFT JOIN \"T006\" AS \"T006\"\n                               ON \"MARA\".\"MANDT\" = \"T006\".\"MANDT\"\n                                   AND \"MARA\".\"MEINS\" = \"T006\".\"MSEHI\"\n                     LEFT JOIN \"T006D\" AS \"T006D\"\n                               ON \"T006\".\"MANDT\" = \"T006D\".\"MANDT\"\n                                   AND \"T006\".\"DIMID\" = \"T006D\".\"DIMID\"\n                     LEFT JOIN \"MARM\" AS \"MARM\"\n                               ON \"MARA\".\"MANDT\" = \"MARM\".\"MANDT\"\n                                   AND \"MARA\".\"MATNR\" = \"MARM\".\"MATNR\"\n                                   AND \"MARM\".\"MEINH\" = <%=SI-Unit%>\n                     ),\n-- Recreate months where no change was happening\n    \"CTE_Calendar_Merge\" AS (SELECT \"Calendar_Merge\".\"StockHistoryID\"                     AS \"ID\",\n                                    \"Calendar_Merge\".\"CurrentPeriod\"                      AS \"CurrentPeriod\",\n                                    COALESCE(CAST(\"ValuatedStockQuantity\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"ValuatedStockQuantity\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"ValuatedStockQuantity\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                     AS \"ValuatedStockQuantity\",\n                                    COALESCE(CAST(\"ValuatedStockAmount\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"ValuatedStockAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"ValuatedStockAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                     AS \"ValuatedStockAmount\",\n                                    COALESCE(CAST(\"UnitPriceAmount\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"UnitPriceAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"UnitPriceAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                     AS \"UnitPriceAmount\",\n                                    \"Calendar_Merge\".\"StockKeepingUnit\"                             AS \"StockKeepingUnit\",\n                                    \"Calendar_Merge\".\"MaterialMasterPlant_ID\"                       AS \"MaterialMasterPlant_ID\",\n                                    \"Calendar_Merge\".\"Client\"                                       AS \"Client\"\n                             FROM \"CTE_Calendar_Merge_Temp\" AS \"Calendar_Merge\")\n-- Filter last two years\nSELECT <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"ID\"                           AS \"ID\",\n       \"Calendar_Merge\".\"CurrentPeriod\"                                             AS \"Period\",\n       \"Calendar_Merge\".\"ValuatedStockQuantity\"                                     AS \"ValuatedStockQuantity\",\n       \"Calendar_Merge\".\"ValuatedStockAmount\"                                       AS \"ValuatedStockAmount\",\n       \"Calendar_Merge\".\"UnitPriceAmount\"                                           AS \"UnitPriceAmount\",\n       \"Calendar_Merge\".\"StockKeepingUnit\"                                          AS \"StockKeepingUnit\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"MaterialMasterPlant_ID\"       AS \"MaterialMasterPlant\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"Client\"                       AS \"SourceSystemInstance\"\nFROM \"CTE_Calendar_Merge\" AS \"Calendar_Merge\"\nWHERE \"CurrentPeriod\" >= TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%> - 1), NOW())\n/*\nWITH \"CTE_Reduce_Calendar\" AS (SELECT \"CELONIS_CALENDAR\".\"LastDayOfMonth\",\n                                     \"CELONIS_CALENDAR\".\"Year\",\n                                     LPAD(CAST(\"CELONIS_CALENDAR\".\"Month\" AS VARCHAR(2)), 2, '0') AS \"Month\"\n                              FROM \"CELONIS_CALENDAR\"\n                              GROUP BY \"LastDayOfMonth\", \"Year\", \"Month\"),\n    -- Determine relevant start dates for StockHistory\n    \"CTE_Date_Range_MBVMBEWHBASE\" AS (SELECT \n                                  \"MARC\".\"MANDT\" AS \"MANDT\",\n                                  \"MARC\".\"MATNR\" AS \"MATNR\",\n                                  \"MARC\".\"WERKS\" AS \"BWKEY\",\n                                  COALESCE(\n                                    \"CTE_Date_Range_MBVMBEWHBASE_Historic\".\"MaxDate\",\n                                    \"CTE_Date_Range_MBVMBEWHBASE_Recent\".\"MinDate\"\n                                  ) AS \"ConsolidatedDate\"\n                                FROM \"MARC\" AS \"MARC\"\n                                LEFT JOIN (\n                                  SELECT\n                                    \"MBVMBEWHBASE\".\"MANDT\"   AS \"MANDT\",\n                                    \"MBVMBEWHBASE\".\"MATNR\"   AS \"MATNR\",\n                                    \"MBVMBEWHBASE\".\"BWKEY\"   AS \"BWKEY\",\n                                    CAST(MAX(\"Reduce_Calendar\".\"LastDayOfMonth\") AS DATE) AS \"MaxDate\"\n                                  FROM \"MBVMBEWHBASE\" AS \"MBVMBEWHBASE\"\n                                      LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                        ON \"MBVMBEWHBASE\".\"LFGJA\" = \"Reduce_Calendar\".\"YEAR\"\n                                          AND \"MBVMBEWHBASE\".\"LFMON\" = \"Reduce_Calendar\".\"Month\"\n                                      WHERE NULLIF(\"MBVMBEWHBASE\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                                          AND \"LastDayOfMonth\" <= TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%>  - 1), NOW())\n                                      GROUP BY \"MBVMBEWHBASE\".\"MANDT\", \"MBVMBEWHBASE\".\"MATNR\", \"MBVMBEWHBASE\".\"BWKEY\"\n                                  )AS \"CTE_Date_Range_MBVMBEWHBASE_Historic\"\n                                  ON \"MARC\".\"MANDT\" = \"CTE_Date_Range_MBVMBEWHBASE_Historic\".\"MANDT\"\n                                    AND \"MARC\".\"MATNR\" = \"CTE_Date_Range_MBVMBEWHBASE_Historic\".\"MATNR\"\n                                    AND \"MARC\".\"WERKS\" = \"CTE_Date_Range_MBVMBEWHBASE_Historic\".\"BWKEY\"\n                                LEFT JOIN (\n                                  SELECT\n                                    \"MBVMBEWHBASE\".\"MANDT\"   AS \"MANDT\",\n                                    \"MBVMBEWHBASE\".\"MATNR\"   AS \"MATNR\",\n                                    \"MBVMBEWHBASE\".\"BWKEY\"   AS \"BWKEY\",\n                                    CAST(MIN(\"Reduce_Calendar\".\"LastDayOfMonth\") AS DATE) AS \"MinDate\"\n                                  FROM \"MBVMBEWHBASE\" AS \"MBVMBEWHBASE\"\n                                  LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                    ON \"MBVMBEWHBASE\".\"LFGJA\" = \"Reduce_Calendar\".\"YEAR\"\n                                      AND \"MBVMBEWHBASE\".\"LFMON\" = \"Reduce_Calendar\".\"Month\"\n                                  WHERE NULLIF(\"MBVMBEWHBASE\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                                    AND \"LastDayOfMonth\" > TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%>  - 1), NOW())\n                                  GROUP BY \"MBVMBEWHBASE\".\"MANDT\", \"MBVMBEWHBASE\".\"MATNR\", \"MBVMBEWHBASE\".\"BWKEY\") AS \"CTE_Date_Range_MBVMBEWHBASE_Recent\"\n                                  ON \"MARC\".\"MANDT\" = \"CTE_Date_Range_MBVMBEWHBASE_Recent\".\"MANDT\"\n                                    AND \"MARC\".\"MATNR\" = \"CTE_Date_Range_MBVMBEWHBASE_Recent\".\"MATNR\"\n                                    AND \"MARC\".\"WERKS\" = \"CTE_Date_Range_MBVMBEWHBASE_Recent\".\"BWKEY\"\n                              ),\n    -- Based on the Calender take the end of the month to get the current period of a Material and Plant and create a\n    -- timeseries from the first month where a material movement was happening to the current date\n    \"CTE_Calendar\" AS (SELECT \"Date_Range_MBVMBEWHBASE\".\"MANDT\"                            AS \"MANDT\",\n                              \"Date_Range_MBVMBEWHBASE\".\"MATNR\"                            AS \"MATNR\",\n                              \"Date_Range_MBVMBEWHBASE\".\"BWKEY\"                            AS \"BWKEY\",\n                              CAST(\"Reduce_Calendar\".\"LastDayOfMonth\" AS TIMESTAMP) AS \"DateRange\",\n                              CAST(\"Reduce_Calendar\".\"Year\" AS VARCHAR)             AS \"Year\",\n                              CAST(\"Reduce_Calendar\".\"Month\" AS VARCHAR)            AS \"Month\"\n                       FROM \"CTE_Date_Range_MBVMBEWHBASE\" AS \"Date_Range_MBVMBEWHBASE\"\n                                LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                          ON \"Date_Range_MBVMBEWHBASE\".\"ConsolidatedDate\" <= CAST(\"Reduce_Calendar\".\"LastDayOfMonth\" AS DATE)\n                                              AND CAST(\"Reduce_Calendar\".\"LastDayOfMonth\" AS DATE) <= CAST(\n                                                      TIMESTAMPADD(DAY, -1, TIMESTAMPADD(MONTH, 1,\n                                                                                         CAST(CAST(YEAR(NOW()) AS VARCHAR)\n                                                                                              || '-'\n                                                                                              || CAST(MONTH(NOW()) AS VARCHAR)\n                                                                                              || '-01' AS DATE))) AS DATE)),\n    -- Determine StockKeepingUnit\n    \"CTE_QuanityConversion\" AS (SELECT \"MARA\".\"MANDT\",\n                                         \"MARA\".\"MATNR\",\n                                         CASE\n                                             WHEN \"T006\".\"DIMID\" != 'AAAADL'\n                                                 THEN \"T006D\".\"MSSIE\"\n                                             WHEN \"T006\".\"DIMID\" = 'AAAADL'\n                                                 THEN \"MARM\".\"MEINH\"\n                                             END        AS \"MEINS\"\n                                  FROM \"MARA\" AS \"MARA\"\n                                           LEFT JOIN \"T006\" AS \"T006\"\n                                                     ON \"MARA\".\"MANDT\" = \"T006\".\"MANDT\"\n                                                         AND \"MARA\".\"MEINS\" = \"T006\".\"MSEHI\"\n                                           LEFT JOIN \"T006D\" AS \"T006D\"\n                                                     ON \"T006\".\"MANDT\" = \"T006D\".\"MANDT\"\n                                                         AND \"T006\".\"DIMID\" = \"T006D\".\"DIMID\"\n                                           LEFT JOIN \"MARM\" AS \"MARM\"\n                                                     ON \"MARA\".\"MANDT\" = \"MARM\".\"MANDT\"\n                                                         AND \"MARA\".\"MATNR\" = \"MARM\".\"MATNR\"\n                                                         AND \"MARM\".\"MEINH\" = <%=SI-Unit%>\n                                  WHERE \"T006\".\"MANDT\" IS NOT NULL\n                                    AND \"MARM\".\"MANDT\" IS NOT NULL),\n    -- Union History and current Information into one table\n    \"CTE_MBVMBEWBASE_AGG\" AS (SELECT \"MBVMBEWHBASE\".\"MANDT\",\n                              \"MBVMBEWHBASE\".\"MATNR\",\n                              \"MBVMBEWHBASE\".\"BWKEY\",\n                              CAST(\"MBVMBEWHBASE\".\"LFGJA\" AS VARCHAR) AS \"LFGJA\",\n                              CAST(\"MBVMBEWHBASE\".\"LFMON\" AS VARCHAR) AS \"LFMON\",\n                              \"MBVMBEWHBASE\".\"LBKUM\",\n                              \"MBVMBEWHBASE\".\"SALK3\",\n                              \"MBVMBEWHBASE\".\"VERPR\",\n                              \"MBVMBEWHBASE\".\"STPRS\",\n                              \"MBVMBEWHBASE\".\"PEINH\",\n                              \"MBVMBEWHBASE\".\"VPRSV\"\n                       FROM \"MBVMBEWHBASE\" AS \"MBVMBEWHBASE\"\n                       WHERE NULLIF(\"MBVMBEWHBASE\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                       UNION ALL\n                       SELECT \"MBVMBEWBASE\".\"MANDT\",\n                              \"MBVMBEWBASE\".\"MATNR\",\n                              \"MBVMBEWBASE\".\"BWKEY\",\n                              CAST(\"MBVMBEWBASE\".\"LFGJA\" AS VARCHAR) AS \"LFGJA\",\n                              CAST(\"MBVMBEWBASE\".\"LFMON\" AS VARCHAR) AS \"LFMON\",\n                              \"MBVMBEWBASE\".\"LBKUM\",\n                              \"MBVMBEWBASE\".\"SALK3\",\n                              \"MBVMBEWBASE\".\"VERPR\",\n                              \"MBVMBEWBASE\".\"STPRS\",\n                              \"MBVMBEWBASE\".\"PEINH\",\n                              \"MBVMBEWBASE\".\"VPRSV\"\n                       FROM \"MBVMBEWBASE\" AS \"MBVMBEWBASE\"\n                       WHERE NULLIF(\"MBVMBEWBASE\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                       ),\n    -- Merge the CTE_Calendar Table with the Stock History Table \n    \"CTE_Calendar_Merge_Temp\"\n        AS (SELECT DISTINCT \"Calendar\".\"MANDT\" || '::' || \"Calendar\".\"MATNR\" || '::' || \"Calendar\".\"BWKEY\"\n                   || '::' || \"Calendar\".\"Year\" || '::' || \"Calendar\".\"Month\"                       AS \"StockHistoryID\",\n                   \"Calendar\".\"DateRange\"                                                           AS \"CurrentPeriod\",\n                   \"MBVMBEWBASE_AGG\".\"MATNR\"                                                        AS \"MaterialNumber\",\n                   \"MBVMBEWBASE_AGG\".\"LBKUM\"                                                        AS \"ValuatedStockQuantity\",\n                   \"MBVMBEWBASE_AGG\".\"SALK3\"                                                        AS \"ValuatedStockAmount\",\n                   CASE\n                       WHEN \"MBVMBEWBASE_AGG\".\"VPRSV\" = 'V' THEN COALESCE(\n                               \"MBVMBEWBASE_AGG\".\"VERPR\" / NULLIF(\"MBVMBEWBASE_AGG\".\"PEINH\", 0),\n                               \"MBVMBEWBASE_AGG\".\"VERPR\")\n                       WHEN \"MBVMBEWBASE_AGG\".\"VPRSV\" = 'S' THEN COALESCE(\n                               \"MBVMBEWBASE_AGG\".\"STPRS\" / NULLIF(\"MBVMBEWBASE_AGG\".\"PEINH\", 0),\n                               \"MBVMBEWBASE_AGG\".\"STPRS\")\n                       ELSE \"MBVMBEWBASE_AGG\".\"SALK3\" / NULLIF(\"MBVMBEWBASE_AGG\".\"LBKUM\", 0)\n                       END                                                                          AS \"UnitPriceAmount\",\n                   \"T001\".\"WAERS\"                                                                   AS \"BaseCurrency\",\n                   \"MSEG_AGG\".\"MEINS\"                                                               AS \"StockKeepingUnit\",\n                   \"Calendar\".\"MANDT\" || '::' || \"Calendar\".\"MATNR\" || '::' || \"Calendar\".\"BWKEY\"   AS \"MaterialMasterPlant_ID\",\n                   \"Calendar\".\"MANDT\"                                                               AS \"Client\"\n            FROM (SELECT *\n                  FROM \"CTE_Calendar\"\n                  ORDER BY \"MANDT\", \"MATNR\", \"BWKEY\", \"year\", \"Month\") AS \"Calendar\"\n                     LEFT JOIN (SELECT *\n                                FROM \"CTE_MBVMBEWBASE_AGG\"\n                                ORDER BY \"MANDT\", \"MATNR\", \"BWKEY\", \"LFGJA\", \"LFMON\") AS \"MBVMBEWBASE_AGG\"\n                               ON \"Calendar\".\"MANDT\" = \"MBVMBEWBASE_AGG\".\"MANDT\"\n                                  AND \"Calendar\".\"MATNR\" = \"MBVMBEWBASE_AGG\".\"MATNR\"\n                                  AND \"Calendar\".\"BWKEY\" = \"MBVMBEWBASE_AGG\".\"BWKEY\"\n                                  AND \"Calendar\".\"Year\" = \"MBVMBEWBASE_AGG\".\"LFGJA\"\n                                  AND \"Calendar\".\"Month\" = \"MBVMBEWBASE_AGG\".\"LFMON\"\n                     LEFT JOIN \"T001K\" AS \"T001K\"\n                               ON \"MBVMBEWBASE_AGG\".\"MANDT\" = \"T001K\".\"MANDT\"\n                                   AND \"MBVMBEWBASE_AGG\".\"BWKEY\" = \"T001K\".\"BWKEY\"\n                     LEFT JOIN \"T001\" AS \"T001\"\n                               ON \"T001K\".\"MANDT\" = \"T001\".\"MANDT\"\n                                   AND \"T001K\".\"BUKRS\" = \"T001\".\"BUKRS\"\n                     LEFT JOIN \"CTE_QuanityConversion\" AS \"MSEG_AGG\"\n                               ON \"Calendar\".\"MANDT\" = \"MSEG_AGG\".\"MANDT\"\n                                   AND \"Calendar\".\"MATNR\" = \"MSEG_AGG\".\"MATNR\"),\n-- Recreate months where no change was happening\n    \"CTE_Calendar_Merge\" AS (SELECT \"Calendar_Merge\".\"StockHistoryID\"                               AS \"ID\",\n                                    \"Calendar_Merge\".\"CurrentPeriod\"                                AS \"CurrentPeriod\",\n                                    COALESCE(CAST(\"Calendar_Merge\".\"ValuatedStockQuantity\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"Calendar_Merge\".\"ValuatedStockQuantity\") IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"Calendar_Merge\".\"MaterialMasterPlant_ID\" ORDER BY \"Calendar_Merge\".\"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"Calendar_Merge\".\"ValuatedStockQuantity\") IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"Calendar_Merge\".\"MaterialMasterPlant_ID\" ORDER BY \"Calendar_Merge\".\"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                               AS \"ValuatedStockQuantity\",\n                                    COALESCE(CAST(\"Calendar_Merge\".\"ValuatedStockAmount\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"Calendar_Merge\".\"ValuatedStockAmount\") IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"Calendar_Merge\".\"MaterialMasterPlant_ID\" ORDER BY \"Calendar_Merge\".\"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"Calendar_Merge\".\"ValuatedStockAmount\") IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"Calendar_Merge\".\"MaterialMasterPlant_ID\" ORDER BY \"Calendar_Merge\".\"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                               AS \"ValuatedStockAmount\",\n                                    COALESCE(CAST(\"Calendar_Merge\".\"UnitPriceAmount\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"Calendar_Merge\".\"UnitPriceAmount\") IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"Calendar_Merge\".\"MaterialMasterPlant_ID\" ORDER BY \"Calendar_Merge\".\"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"Calendar_Merge\".\"UnitPriceAmount\") IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"Calendar_Merge\".\"MaterialMasterPlant_ID\" ORDER BY \"Calendar_Merge\".\"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                               AS \"UnitPriceAmount\",\n                                    \"Calendar_Merge\".\"StockKeepingUnit\"                             AS \"StockKeepingUnit\",\n                                    \"Calendar_Merge\".\"MaterialMasterPlant_ID\"                       AS \"MaterialMasterPlant_ID\",\n                                    \"Calendar_Merge\".\"Client\"                                       AS \"Client\"\n                             FROM \"CTE_Calendar_Merge_Temp\" AS \"Calendar_Merge\")\n-- Filter last two years\nSELECT <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"ID\"                           AS \"ID\",\n       \"Calendar_Merge\".\"CurrentPeriod\"                                             AS \"Period\",\n       \"Calendar_Merge\".\"ValuatedStockQuantity\"                                     AS \"ValuatedStockQuantity\",\n       \"Calendar_Merge\".\"ValuatedStockAmount\"                                       AS \"ValuatedStockAmount\",\n       \"Calendar_Merge\".\"UnitPriceAmount\"                                           AS \"UnitPriceAmount\",\n       \"Calendar_Merge\".\"StockKeepingUnit\"                                          AS \"StockKeepingUnit\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"MaterialMasterPlant_ID\"       AS \"MaterialMasterPlant\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"Client\"                       AS \"SourceSystemInstance\"\nFROM \"CTE_Calendar_Merge\" AS \"Calendar_Merge\"\nWHERE \"Calendar_Merge\".\"CurrentPeriod\" >= TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%> - 1), NOW())\n*/"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    },
    {
        "change_date": 1761569818443.0,
        "changed_by": {
            "id": "ae9989fc-2640-4ab1-9754-cb31999ce77e",
            "name": "j.rosenbauer",
            "type_": "USER"
        },
        "created_by": {
            "id": "2202cbc9-7251-4630-bfb2-36812e688613",
            "name": "l.pigozzi",
            "type_": "USER"
        },
        "creation_date": 1749630787130.0,
        "data_connection_id": "42d53587-d7fa-45cf-8403-26770d8029d0",
        "description": "",
        "disabled": null,
        "display_name": "StockHistory transformation - 00. Central Extraction Pool_Oracle-ebs - 1",
        "draft": null,
        "factory_id": "793958b9-8341-460b-b018-9237a64eeeec",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "sourceSystem",
                "value": "'Oracle_EBS'"
            },
            {
                "name": "stockHistoryYears",
                "value": "2"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "StockHistory",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [],
                "foreign_key_names": [
                    "MaterialMasterPlant"
                ],
                "namespace": "custom",
                "property_names": [
                    "ID",
                    "Period",
                    "SourceSystemInstance",
                    "StockKeepingUnit",
                    "UnitPriceAmount",
                    "ValuatedStockAmount",
                    "ValuatedStockQuantity"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "StockHistoryAttributes",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "WITH\n    \"CTE_Reduce_Calendar\" AS (\n        SELECT\n            \"CELONIS_CALENDAR\".\"LastDayOfMonth\",\n            \"CELONIS_CALENDAR\".\"Year\",\n            LPAD(CAST(\"CELONIS_CALENDAR\".\"Month\" AS VARCHAR(2)), 2, '0') AS \"Month\"\n        FROM \"CELONIS_CALENDAR\"\n        GROUP BY\n            \"LastDayOfMonth\",\n            \"Year\",\n            \"Month\"\n    ),\n    \"CTE_Date_Range\" AS (\n        SELECT\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"INVENTORY_ITEM_ID\",\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"ORGANIZATION_ID\",\n            MIN(\"Reduce_Calendar\".\"LastDayOfMonth\") AS \"MinDate\"\n        FROM\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\" AS \"INVENTORY_LEVELS_CELONIS_CHANGELOG\"\n        LEFT JOIN\n            \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n            ON \"Reduce_Calendar\".\"YEAR\" = YEAR(\"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"EndOfMonth\")\n            AND \"Reduce_Calendar\".\"Month\" = MONTH(\"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"EndOfMonth\")\n        GROUP BY\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"INVENTORY_ITEM_ID\",\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"ORGANIZATION_ID\"\n        ORDER BY 1, 2\n    ),\n    \"CTE_Calendar\" AS (\n        SELECT\n            \"Date_Range\".\"INVENTORY_ITEM_ID\",\n            \"Date_Range\".\"ORGANIZATION_ID\",\n            \"Reduce_Calendar\".\"LastDayOfMonth\" AS \"DateRange\",\n            \"Reduce_Calendar\".\"Year\" AS \"Year\",\n            \"Reduce_Calendar\".\"Month\" AS \"Month\"\n        FROM\n            \"CTE_Date_Range\" AS \"Date_Range\"\n        LEFT JOIN\n            \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n            ON \"Date_Range\".\"MinDate\" <= \"Reduce_Calendar\".\"LastDayOfMonth\"\n            AND \"Reduce_Calendar\".\"LastDayOfMonth\" < TIMESTAMPADD(month, 1, NOW())\n    ),\n    \"CTE_Material_Cost\" AS (\n        SELECT\n            \"CST_ITEM_COSTS\".\"ORGANIZATION_ID\",\n            \"CST_ITEM_COSTS\".\"INVENTORY_ITEM_ID\",\n            \"CST_ITEM_COSTS\".\"ITEM_COST\" AS \"UnitPriceAmount\"\n        FROM \"CST_ITEM_COSTS\" AS \"CST_ITEM_COSTS\"\n        INNER JOIN \"CST_COST_TYPES\" AS \"CST_COST_TYPES\"\n            ON \"CST_COST_TYPES\".\"COST_TYPE_ID\" = \"CST_ITEM_COSTS\".\"COST_TYPE_ID\"\n                AND \"CST_COST_TYPES\".\"COST_TYPE_ID\" = 1\n    ),\n    \"CTE_Calendar_Merge\" AS (\n        SELECT\n            COALESCE(\n                \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"StockHistoryID\",\n                \"Calendar\".\"INVENTORY_ITEM_ID\" || '::' || \"Calendar\".\"ORGANIZATION_ID\" || '::' || LAST_DAY(\"Calendar\".\"DateRange\")\n            )                                                                                                                       AS \"StockHistoryID\",\n            CAST(\"Calendar\".\"DateRange\" AS TIMESTAMP)                                                                               AS \"DateRange\",\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"ValuatedStockQuantity\"                                                            AS \"ValuatedStockQuantity\",\n            \"Unit_Price_Calc\".\"UnitPriceAmount\"                                                                                     AS \"UnitPriceAmount\",-- Evaluation based on cost\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"ValuatedStockQuantity\" * \"UnitPriceAmount\"                                        AS \"ValuatedStockAmount\",-- Evaluation based on cost\n            -- \"MTL_SYSTEM_ITEMS_B\".\"LIST_PRICE_PER_UNIT\"                                                                           AS \"UnitPriceAmount\",-- Evaluation based on list price\n            -- \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"ValuatedStockQuantity\" * \"MTL_SYSTEM_ITEMS_B\".\"LIST_PRICE_PER_UNIT\"            AS \"ValuatedStockAmount\",-- Evaluation based on list price\n            \"GL_LEDGERS\".\"CURRENCY_CODE\"                                                                                            AS \"BaseCurrency\", \n            \"MTL_SYSTEM_ITEMS_B\".\"PRIMARY_UOM_CODE\"                                                                                 AS \"QuantityUnit\",\n            \"Calendar\".\"ORGANIZATION_ID\" || '::' || \"Calendar\".\"INVENTORY_ITEM_ID\"                                                  AS \"MaterialMasterPlant\",\n            <%=sourceSystem%> AS \"Client\"\n        FROM \"CTE_Calendar\" AS \"Calendar\"\n        INNER JOIN\n            \"MTL_SYSTEM_ITEMS_B\" AS \"MTL_SYSTEM_ITEMS_B\"\n            ON \"Calendar\".\"INVENTORY_ITEM_ID\" = \"MTL_SYSTEM_ITEMS_B\".\"INVENTORY_ITEM_ID\"\n            AND \"Calendar\".\"ORGANIZATION_ID\" = \"MTL_SYSTEM_ITEMS_B\".\"ORGANIZATION_ID\"\n        LEFT JOIN\n            \"INVENTORY_LEVELS_CELONIS_CHANGELOG\" AS \"INVENTORY_LEVELS_CELONIS_CHANGELOG\"\n            ON \"Calendar\".\"INVENTORY_ITEM_ID\" = \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"INVENTORY_ITEM_ID\"\n            AND \"Calendar\".\"ORGANIZATION_ID\" = \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"ORGANIZATION_ID\"\n            AND \"Calendar\".\"DateRange\" = \"INVENTORY_LEVELS_CELONIS_CHANGELOG\".\"EndOfMonth\"\n        LEFT JOIN\n            \"CTE_Material_Cost\" AS \"Unit_Price_Calc\" ON \"Calendar\".\"INVENTORY_ITEM_ID\" = \"Unit_Price_Calc\".\"INVENTORY_ITEM_ID\"\n            AND \"Calendar\".\"ORGANIZATION_ID\" = \"Unit_Price_Calc\".\"ORGANIZATION_ID\"\n        LEFT JOIN \"HR_ALL_ORGANIZATION_UNITS\" AS \"HR_ALL_ORGANIZATION_UNITS\"\n            ON \"Calendar\".\"ORGANIZATION_ID\" = \"HR_ALL_ORGANIZATION_UNITS\".\"ORGANIZATION_ID\"\n        LEFT JOIN \"ORG_ORGANIZATION_DEFINITIONS\" AS \"ORG_ORGANIZATION_DEFINITIONS\"\n            ON \"Calendar\".\"ORGANIZATION_ID\" = \"ORG_ORGANIZATION_DEFINITIONS\".\"ORGANIZATION_ID\"\n        LEFT JOIN \"GL_LEDGERS\" AS \"GL_LEDGERS\"\n            ON \"ORG_ORGANIZATION_DEFINITIONS\".\"SET_OF_BOOKS_ID\" = \"GL_LEDGERS\".\"LEDGER_ID\"\n    ),\n    -- Fill the gaps in the timeline with the previous value\n    \"CTE_FillGap\" AS (\n        -- Recreate months where no change was happening\n         SELECT \"Calendar_Merge\".\"StockHistoryID\"                          AS \"ID\",\n                CAST(\"Calendar_Merge\".\"DateRange\" AS TIMESTAMP)            AS \"CurrentPeriod\",\n                COALESCE(CAST(\"ValuatedStockQuantity\" AS FLOAT),\n                         CAST((LAST_VALUE(\"ValuatedStockQuantity\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS FLOAT), \n                         CAST((FIRST_VALUE(\"ValuatedStockQuantity\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING)) AS FLOAT),0\n                ,0)        --handling 0 values in case of no Onhand entries\n                                                                           AS \"ValuatedStockQuantity\",\n                COALESCE(CAST(\"ValuatedStockAmount\" AS FLOAT),\n                         CAST((LAST_VALUE(\"ValuatedStockAmount\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS FLOAT),\n                         CAST((FIRST_VALUE(\"ValuatedStockAmount\") IGNORE NULLS\n                              OVER (PARTITION BY \"MaterialMasterPlant\" ORDER BY \"DateRange\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING)) AS FLOAT),0\n                ,0)                                                        AS \"ValuatedStockAmount\",\n                \"Calendar_Merge\".\"UnitPriceAmount\"                         AS \"UnitPriceAmount\",\n                \"Calendar_Merge\".\"QuantityUnit\"                            AS \"QuantityUnit\",\n                \"Calendar_Merge\".\"MaterialMasterPlant\"                     AS \"MaterialMasterPlant\",\n                <%=sourceSystem%>                                          AS \"SourceSystemType\"\n          FROM \"CTE_Calendar_Merge\" AS \"Calendar_Merge\")\n-- Filter last two years\n-- This is needed in a seperate query that the LAST/FIRST_VALUE fills the empty rows\nSELECT <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"ID\"                  AS \"ID\",\n       \"Calendar_Merge\".\"CurrentPeriod\"                                    AS \"Period\",\n       \"Calendar_Merge\".\"ValuatedStockQuantity\"                            AS \"ValuatedStockQuantity\",\n       \"Calendar_Merge\".\"ValuatedStockAmount\"                              AS \"ValuatedStockAmount\",\n       \"Calendar_Merge\".\"UnitPriceAmount\"                                  AS \"UnitPriceAmount\",\n       \"Calendar_Merge\".\"QuantityUnit\"                                     AS \"StockKeepingUnit\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"MaterialMasterPlant\" AS \"MaterialMasterPlant\",\n       <%=sourceSystem%>                                                   AS \"SourceSystemInstance\"\nFROM \"CTE_FillGap\" AS \"Calendar_Merge\"\nWHERE\n    \"CurrentPeriod\" >= TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%> - 1), NOW())\n"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    },
    {
        "change_date": 1761558607288.0,
        "changed_by": {
            "id": "ae9989fc-2640-4ab1-9754-cb31999ce77e",
            "name": "j.rosenbauer",
            "type_": "USER"
        },
        "created_by": {
            "id": "2202cbc9-7251-4630-bfb2-36812e688613",
            "name": "l.pigozzi",
            "type_": "USER"
        },
        "creation_date": 1749635105867.0,
        "data_connection_id": "b9f449da-3a15-43d8-89e3-0e87e54fb5af",
        "description": null,
        "disabled": null,
        "display_name": "StockHistory - 00. Central Extraction Pool_TS1",
        "draft": null,
        "factory_id": "d5ef84f1-e553-49a6-bc24-0b83c78f875e",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "SI-Unit",
                "value": "'ST'"
            },
            {
                "name": "sourceSystem",
                "value": "'SAP_ECC'"
            },
            {
                "name": "stockHistoryYears",
                "value": "2"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "StockHistory",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [],
                "foreign_key_names": [
                    "MaterialMasterPlant"
                ],
                "namespace": "custom",
                "property_names": [
                    "ID",
                    "Period",
                    "SourceSystemInstance",
                    "StockKeepingUnit",
                    "UnitPriceAmount",
                    "ValuatedStockAmount",
                    "ValuatedStockQuantity"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "StockHistoryAttributes",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "WITH\n    \"CTE_Reduce_Calendar\" AS (SELECT \"CELONIS_CALENDAR\".\"LastDayOfMonth\",\n                                     \"CELONIS_CALENDAR\".\"Year\",\n                                     LPAD(CAST(\"CELONIS_CALENDAR\".\"Month\" AS VARCHAR(2)), 2, '0') AS \"Month\"\n                              FROM \"CELONIS_CALENDAR\"\n                              GROUP BY \"LastDayOfMonth\", \"Year\", \"Month\"),\n    \"CTE_Date_Range_MBEWH\" AS (SELECT \"MBEWH\".\"MANDT\"                         AS \"MANDT\",\n                                      \"MBEWH\".\"MATNR\"                         AS \"MATNR\",\n                                      \"MBEWH\".\"BWKEY\"                         AS \"BWKEY\",\n                                      MIN(\"Reduce_Calendar\".\"LastDayOfMonth\") AS \"MinDate\"\n                               FROM \"MBEWH\" AS \"MBEWH\"\n                                        LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                                  ON \"MBEWH\".\"LFGJA\" = \"Reduce_Calendar\".\"YEAR\"\n                                                      AND \"MBEWH\".\"LFMON\" = \"Reduce_Calendar\".\"Month\"\n                               WHERE NULLIF(\"MBEWH\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                               GROUP BY \"MBEWH\".\"MANDT\", \"MBEWH\".\"MATNR\", \"MBEWH\".\"BWKEY\"),\n    -- Based on the Calender take the end of the month to get the current period of a Material and Plant and create a\n    -- timeseries from the first month where a material movement was happening to the current date\n    \"CTE_Calendar\" AS (SELECT \"Date_Range_MBEWH\".\"MANDT\"                            AS \"MANDT\",\n                              \"Date_Range_MBEWH\".\"MATNR\"                            AS \"MATNR\",\n                              \"Date_Range_MBEWH\".\"BWKEY\"                            AS \"BWKEY\",\n                              CAST(\"Reduce_Calendar\".\"LastDayOfMonth\" AS TIMESTAMP) AS \"DateRange\",\n                              \"Reduce_Calendar\".\"Year\"                              AS \"Year\",\n                              \"Reduce_Calendar\".\"Month\"                             AS \"Month\"\n                       FROM \"CTE_Date_Range_MBEWH\" AS \"Date_Range_MBEWH\"\n                                LEFT JOIN \"CTE_Reduce_Calendar\" AS \"Reduce_Calendar\"\n                                          ON \"Date_Range_MBEWH\".\"MinDate\" <= \"Reduce_Calendar\".\"LastDayOfMonth\"\n                                              AND \"Reduce_Calendar\".\"LastDayOfMonth\" <= CAST(\n                                                      TIMESTAMPADD(DAY, -1, TIMESTAMPADD(MONTH, 1,\n                                                                                         CAST(YEAR(NOW()) || '-' || MONTH(NOW()) || '-01' AS DATE))) AS DATE)),\n    -- Union History and current Information into one table\n    \"CTE_MBEW_AGG\" AS (SELECT \"MBEWH\".\"MANDT\",\n                              \"MBEWH\".\"MATNR\",\n                              \"MBEWH\".\"BWKEY\",\n                              \"MBEWH\".\"LFGJA\",\n                              \"MBEWH\".\"LFMON\",\n                              \"MBEWH\".\"LBKUM\",\n                              \"MBEWH\".\"SALK3\",\n                              \"MBEWH\".\"VERPR\",\n                              \"MBEWH\".\"STPRS\",\n                              \"MBEWH\".\"PEINH\",\n                              \"MBEWH\".\"VPRSV\"\n                       FROM \"MBEWH\" AS \"MBEWH\"\n                       WHERE NULLIF(\"MBEWH\".\"BWTAR\", '') IS NULL    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n                       UNION ALL\n                       SELECT \"MBEW\".\"MANDT\",\n                              \"MBEW\".\"MATNR\",\n                              \"MBEW\".\"BWKEY\",\n                              \"MBEW\".\"LFGJA\",\n                              \"MBEW\".\"LFMON\",\n                              \"MBEW\".\"LBKUM\",\n                              \"MBEW\".\"SALK3\",\n                              \"MBEW\".\"VERPR\",\n                              \"MBEW\".\"STPRS\",\n                              \"MBEW\".\"PEINH\",\n                              \"MBEW\".\"VPRSV\"\n                       FROM \"MBEW\" AS \"MBEW\"\n                       WHERE NULLIF(\"MBEW\".\"BWTAR\", '') IS NULL),    -- SAP stores the final valuated stock in the records where \"BWTAR\" is NULL, combining with other types lead to wrong numbers\n    -- Merge the CTE_Calendar Table with the Stock History Table and add the aggregation for consumption and replenishment from the material movement\n    \"CTE_Calendar_Merge_Temp\"\n        AS (SELECT DISTINCT \"Calendar\".\"MANDT\" || '::' || \"Calendar\".\"MATNR\" || '::' || \"Calendar\".\"BWKEY\"\n                   || '::' || \"Calendar\".\"Year\" || '::' || \"Calendar\".\"Month\"   AS \"StockHistoryID\",\n                   \"Calendar\".\"DateRange\"                                       AS \"CurrentPeriod\",\n                   \"MBEW_AGG\".\"MATNR\"                                           AS \"MaterialNumber\",\n                   \"MBEW_AGG\".\"LBKUM\"                                           AS \"ValuatedStockQuantity\",\n                   \"MBEW_AGG\".\"SALK3\"                                           AS \"ValuatedStockAmount\",\n                   CASE\n                       WHEN \"MBEW_AGG\".\"VPRSV\" = 'V' THEN COALESCE(\n                               \"MBEW_AGG\".\"VERPR\" / NULLIF(\"MBEW_AGG\".\"PEINH\", 0),\n                               \"MBEW_AGG\".\"VERPR\")\n                       WHEN \"MBEW_AGG\".\"VPRSV\" = 'S' THEN COALESCE(\n                               \"MBEW_AGG\".\"STPRS\" / NULLIF(\"MBEW_AGG\".\"PEINH\", 0),\n                               \"MBEW_AGG\".\"STPRS\")\n                       ELSE \"MBEW_AGG\".\"SALK3\" / NULLIF(\"MBEW_AGG\".\"LBKUM\", 0)\n                    END                                    AS \"UnitPriceAmount\",\n                    CASE\n                        WHEN \"T006\".\"DIMID\" != 'AAAADL'\n                            THEN \"T006D\".\"MSSIE\"\n                        WHEN \"T006\".\"DIMID\" = 'AAAADL'\n                            THEN \"MARM\".\"MEINH\"\n                    END                                                         AS \"StockKeepingUnit\",\n                   \"Calendar\".\"MANDT\" || '::' || \"Calendar\".\"MATNR\" || '::' || \"Calendar\".\"BWKEY\"                      AS \"MaterialMasterPlant_ID\",\n                   \"Calendar\".\"MANDT\"                                           AS \"Client\"\n            FROM \"CTE_Calendar\" AS \"Calendar\"\n                     LEFT JOIN \"CTE_MBEW_AGG\" AS \"MBEW_AGG\"\n                               ON \"Calendar\".\"MANDT\" = \"MBEW_AGG\".\"MANDT\"\n                                   AND \"Calendar\".\"MATNR\" = \"MBEW_AGG\".\"MATNR\"\n                                   AND \"Calendar\".\"BWKEY\" = \"MBEW_AGG\".\"BWKEY\"\n                                   AND \"Calendar\".\"Year\" = \"MBEW_AGG\".\"LFGJA\"\n                                   AND \"Calendar\".\"Month\" = \"MBEW_AGG\".\"LFMON\"\n                     LEFT JOIN \"T001K\" AS \"T001K\"\n                               ON \"MBEW_AGG\".\"MANDT\" = \"T001K\".\"MANDT\"\n                                   AND \"MBEW_AGG\".\"BWKEY\" = \"T001K\".\"BWKEY\"\n                     LEFT JOIN \"T001\" AS \"T001\"\n                               ON \"T001K\".\"MANDT\" = \"T001\".\"MANDT\"\n                                   AND \"T001K\".\"BUKRS\" = \"T001\".\"BUKRS\"\n                     LEFT JOIN \"MARA\" AS \"MARA\"\n                               ON \"MARA\".\"MANDT\" = \"Calendar\".\"MANDT\"\n                                   AND \"MARA\".\"MATNR\" = \"Calendar\".\"MATNR\"\n                     LEFT JOIN \"T006\" AS \"T006\"\n                               ON \"MARA\".\"MANDT\" = \"T006\".\"MANDT\"\n                                   AND \"MARA\".\"MEINS\" = \"T006\".\"MSEHI\"\n                     LEFT JOIN \"T006D\" AS \"T006D\"\n                               ON \"T006\".\"MANDT\" = \"T006D\".\"MANDT\"\n                                   AND \"T006\".\"DIMID\" = \"T006D\".\"DIMID\"\n                     LEFT JOIN \"MARM\" AS \"MARM\"\n                               ON \"MARA\".\"MANDT\" = \"MARM\".\"MANDT\"\n                                   AND \"MARA\".\"MATNR\" = \"MARM\".\"MATNR\"\n                                   AND \"MARM\".\"MEINH\" = <%=SI-Unit%>\n                     ),\n-- Recreate months where no change was happening\n    \"CTE_Calendar_Merge\" AS (SELECT \"Calendar_Merge\".\"StockHistoryID\"                     AS \"ID\",\n                                    \"Calendar_Merge\".\"CurrentPeriod\"                      AS \"CurrentPeriod\",\n                                    COALESCE(CAST(\"ValuatedStockQuantity\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"ValuatedStockQuantity\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"ValuatedStockQuantity\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                     AS \"ValuatedStockQuantity\",\n                                    COALESCE(CAST(\"ValuatedStockAmount\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"ValuatedStockAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"ValuatedStockAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                     AS \"ValuatedStockAmount\",\n                                    COALESCE(CAST(\"UnitPriceAmount\" AS FLOAT),\n                                             CAST(LAST_VALUE(\"UnitPriceAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS FLOAT),\n                                             CAST(FIRST_VALUE(\"UnitPriceAmount\"  ) IGNORE NULLS    -- Months without data will be NULL and will get populated through \"IGNORE NULLS\"\n                                                  OVER (PARTITION BY \"MaterialMasterPlant_ID\" ORDER BY \"CurrentPeriod\" DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS FLOAT)\n                                    )                                                     AS \"UnitPriceAmount\",\n                                    \"Calendar_Merge\".\"StockKeepingUnit\"                             AS \"StockKeepingUnit\",\n                                    \"Calendar_Merge\".\"MaterialMasterPlant_ID\"                       AS \"MaterialMasterPlant_ID\",\n                                    \"Calendar_Merge\".\"Client\"                                       AS \"Client\"\n                             FROM \"CTE_Calendar_Merge_Temp\" AS \"Calendar_Merge\")\n-- Filter last two years\nSELECT <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"ID\"                           AS \"ID\",\n       \"Calendar_Merge\".\"CurrentPeriod\"                                             AS \"Period\",\n       \"Calendar_Merge\".\"ValuatedStockQuantity\"                                     AS \"ValuatedStockQuantity\",\n       \"Calendar_Merge\".\"ValuatedStockAmount\"                                       AS \"ValuatedStockAmount\",\n       \"Calendar_Merge\".\"UnitPriceAmount\"                                           AS \"UnitPriceAmount\",\n       \"Calendar_Merge\".\"StockKeepingUnit\"                                          AS \"StockKeepingUnit\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"MaterialMasterPlant_ID\"       AS \"MaterialMasterPlant\",\n       <%=sourceSystem%> || '::' || \"Calendar_Merge\".\"Client\"                       AS \"SourceSystemInstance\"\nFROM \"CTE_Calendar_Merge\" AS \"Calendar_Merge\"\nWHERE \"CurrentPeriod\" >= TIMESTAMPADD(MONTH, (-12 * <%=stockHistoryYears%> - 1), NOW())"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    }
]