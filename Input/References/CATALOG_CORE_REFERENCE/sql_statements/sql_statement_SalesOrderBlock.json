[
    {
        "change_date": 1758528527868.0,
        "changed_by": {
            "id": "9009518c-e25c-4997-b8d1-49ec38885680",
            "name": "Pooja Singh Dohare",
            "type_": "USER"
        },
        "created_by": {
            "id": "4d82ae0d-2047-4c83-ac8c-e2da04a3b5a0",
            "name": "Brave Gujral",
            "type_": "USER"
        },
        "creation_date": 1752756260285.0,
        "data_connection_id": "03736e95-3931-4eda-8dfe-fc16e11388bc",
        "description": null,
        "disabled": null,
        "display_name": "SalesOrderBlock - OracleFusion",
        "draft": null,
        "factory_id": "f506dcd0-e060-4afc-b860-846a9705ae97",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "LanguageKey",
                "value": "'US'"
            },
            {
                "name": "sourceSystem",
                "value": "'\u00d3racle_Fusion'"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "SalesOrderBlock",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [],
                "foreign_key_names": [
                    "BlockedBy",
                    "ReleasedBy",
                    "SalesOrder"
                ],
                "namespace": "custom",
                "property_names": [
                    "BlockExecutionType",
                    "BlockFromSalesOrder",
                    "BlockType",
                    "CreationTime",
                    "FirstBlockReason",
                    "ID",
                    "LatestBlockReason",
                    "LatestBlockReasonText",
                    "ReleaseExecutionType",
                    "ReleaseReason",
                    "ReleaseTime",
                    "ReleaseType",
                    "SourceSystemInstance"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "SalesOrderBlockAttributes",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "SELECT \n    <%=sourceSystem%> || '::' ||  \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldInstanceId\"        AS \"ID\",\n    \"DOO_HOLD_INSTANCES\".\"HoldInstanceCreationDate\"                                        AS \"CreationTime\",\n    CASE\n        WHEN \"DOO_HOLD_CODES_B\".\"HoldHoldCode\" IN ('DOO_CREDIT_CHECK', 'HOLD_FOR_CREDIT_CHECK')\n            THEN 'CreditBlock'\n        WHEN \"DOO_HOLD_CODES_B\".\"HoldHoldCode\" IN ('HOLD_FOR_SCHEDULING','HOLD_FOR_SHIPPING_INSTRUCTIONS')\n            THEN 'DeliveryBlock'\n        WHEN \"DOO_HOLD_CODES_B\".\"HoldHoldCode\" = 'DOO_INVOICE_CREATE'\n            THEN 'BillingBlock'\n    END                                                                                    AS \"BlockType\",\n    \"DOO_HOLD_CODES_B\".\"HoldHoldCode\"                                                      AS \"FirstBlockReason\",\n    CASE\n        WHEN \"DOO_HOLD_INSTANCES\".\"HoldInstanceActiveFlag\" = 'Y'\n            THEN \"DOO_HOLD_CODES_B\".\"HoldHoldCode\" \n    END                                                                                    AS \"LatestBlockReason\",\n    CASE\n        WHEN \"DOO_HOLD_INSTANCES\".\"HoldInstanceActiveFlag\" = 'Y'\n            THEN \"DOO_HOLD_CODES_B\".\"HoldTranslationHoldDescription\" \n    END                                                                                    AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' ||  \"DOO_HOLD_INSTANCES\".\"HoldInstanceCreatedBy\"             AS \"BlockedBy\",\n    'Automatic'                                                                            AS \"BlockExecutionType\",\n    NULL                                                                                   AS \"BlockFromSalesOrder\",\n    \"DOO_HOLD_INSTANCES\".\"HoldInstanceReleaseDate\"                                         AS \"ReleaseTime\",\n    CASE\n        WHEN \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldReleaseReasonCode\" LIKE '%CREDIT%'\n            THEN 'CreditBlock'\n        WHEN (\"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldReleaseReasonCode\" LIKE '%SCHEDULING%' OR\n            \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldReleaseReasonCode\" LIKE '%SHIPPING%')\n            THEN 'DeliveryBlock'\n        WHEN \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldReleaseReasonCode\" LIKE '%INVOICE%'\n            THEN 'BillingBlock'\n    END                                                                                    AS \"ReleaseType\",\n    \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldReleaseReasonCode\"                               AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' ||  \"DOO_HOLD_INSTANCES\".\"HoldInstanceReleaseUserId\"         AS \"ReleasedBy\",\n    CASE\n        WHEN \"DOO_HOLD_INSTANCES\".\"HoldInstanceReleaseUserId\" IS NOT NULL\n            THEN 'Manual'\n        WHEN \"DOO_HOLD_INSTANCES\".\"HoldInstanceReleaseUserId\" IS NULL\n            AND \"DOO_HOLD_INSTANCES\".\"HoldInstanceActiveFlag\" = 'N'\n            THEN 'Automatic'\n        END                                                                                AS \"ReleaseExecutionType\",\n    <%=sourceSystem%>                                                                      AS \"SourceSystemInstance\",\n    <%=sourceSystem%> || '::' || \"DOO_HOLD_INSTANCES\".\"HoldInstanceTransactionEntityId1\"   AS \"SalesOrder\"\nFROM \"FscmTopModelAM_ScmExtractAM_DooBiccExtractAM_HoldInstanceExtractPVO\" AS \"DOO_HOLD_INSTANCES\"\n    LEFT JOIN \"FscmTopModelAM_ScmExtractAM_DooBiccExtractAM_HoldCodeExtractPVO\" AS \"DOO_HOLD_CODES_B\"\n        ON \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldCodeId\" = \"DOO_HOLD_CODES_B\".\"HoldHoldCodeId\"\n                       AND \"DOO_HOLD_CODES_B\".\"HoldTranslationLanguage\" = <%=LanguageKey%> \n    LEFT JOIN \"FscmTopModelAM_ScmExtractAM_DooBiccExtractAM_HeaderExtractPVO\" AS \"DOO_HEADERS_ALL\"\n        ON \"DOO_HOLD_INSTANCES\".\"HoldInstanceTransactionEntityId1\" = \"DOO_HEADERS_ALL\".\"HeaderId\"\n    LEFT JOIN \"FscmTopModelAM_FinExtractAM_AnalyticsExtractServiceAM_LookupValuesTLExtractPVO\" AS \"FND_LOOKUP_VALUES\"\n        ON \"DOO_HOLD_INSTANCES\".\"HoldInstanceHoldReleaseReasonCode\" = \"FND_LOOKUP_VALUES\".\"LookupCode\"\n            AND \"FND_LOOKUP_VALUES\".\"LookupType\" = 'DOO_HLD_RELEASE_REASON'\n            AND \"FND_LOOKUP_VALUES\".\"ViewApplicationId\" = '0'\n            AND \"FND_LOOKUP_VALUES\".\"Language\" =  <%=LanguageKey%>\nWHERE \"DOO_HOLD_INSTANCES\".\"HoldInstanceTransactionEntityId1\" IS NOT NULL\n    AND \"DOO_HOLD_INSTANCES\".\"HoldInstanceTransactionEntityName1\" = 'DOO_ORDER_HEADERS_V'\n    AND \"DOO_HOLD_CODES_B\".\"HoldHoldCode\" IN\n    ('DOO_CREDIT_CHECK', 'HOLD_FOR_CREDIT_CHECK', 'HOLD_FOR_SCHEDULING', \n        'DOO_INVOICE_CREATE','HOLD_FOR_SHIPPING_INSTRUCTIONS')"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    },
    {
        "change_date": 1764062120012.0,
        "changed_by": {
            "id": "2202cbc9-7251-4630-bfb2-36812e688613",
            "name": "l.pigozzi",
            "type_": "USER"
        },
        "created_by": {
            "id": "4d82ae0d-2047-4c83-ac8c-e2da04a3b5a0",
            "name": "Brave Gujral",
            "type_": "USER"
        },
        "creation_date": 1749641059830.0,
        "data_connection_id": "42d53587-d7fa-45cf-8403-26770d8029d0",
        "description": null,
        "disabled": null,
        "display_name": "SalesOrderBlock - 00. Central Extraction Pool_Oracle-ebs",
        "draft": null,
        "factory_id": "179ad754-2723-435e-9717-c38abef19717",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "LanguageKey",
                "value": "'US'"
            },
            {
                "name": "sourceSystem",
                "value": "'Oracle_EBS'"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "SalesOrderBlock",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [],
                "foreign_key_names": [
                    "BlockedBy",
                    "ReleasedBy",
                    "SalesOrder"
                ],
                "namespace": "custom",
                "property_names": [
                    "BlockExecutionType",
                    "BlockFromSalesOrder",
                    "BlockType",
                    "CreationTime",
                    "FirstBlockReason",
                    "ID",
                    "LatestBlockReason",
                    "LatestBlockReasonText",
                    "ReleaseExecutionType",
                    "ReleaseReason",
                    "ReleaseTime",
                    "ReleaseType",
                    "SourceSystemInstance"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "SalesOrderBlockAttributes",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "WITH \"CTE_SalesOrderBlock\"\nAS\n--Credit Block\n( SELECT\n    <%=sourceSystem%> \n    || '::' || CAST(\"OE_ORDER_HOLDS_ALL\".\"ORDER_HOLD_ID\" AS VARCHAR(255)) AS \"ID\",\n    CAST(\"OE_ORDER_HOLDS_ALL\".\"CREATION_DATE\"AS TIMESTAMP)                AS \"CreationTime\",\n    'CreditBlock'                                                         AS \"BlockType\",\n    \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\"                                     AS \"FirstBlockReason\",\n    CASE\n        WHEN \"OE_ORDER_HOLDS_ALL\".\"RELEASED_FLAG\" = 'N' THEN\n            \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\"\n    END                                                                   AS \"LatestBlockReason\",\n    CASE\n        WHEN \"OE_ORDER_HOLDS_ALL\".\"RELEASED_FLAG\" = 'N' THEN\n            \"FND_LOOKUP_VALUES\".\"MEANING\"\n    END                                                                   AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"OE_ORDER_HOLDS_ALL\".\"CREATED_BY\"        AS \"BlockedBy\",\n    'Automatic'                                                           AS \"BlockExecutionType\",\n    NULL                                                                  AS \"BlockFromSalesOrder\",\n    CAST(\"OE_HOLD_RELEASES\".\"CREATION_DATE\" AS TIMESTAMP)                 AS \"ReleaseTime\",\n    CASE\n        WHEN \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" IS NOT NULL \n            THEN 'CreditBlock'\n    END                                                                   AS \"ReleaseType\",\n    \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\"                              AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"OE_HOLD_RELEASES\".\"CREATED_BY\"          AS \"ReleasedBy\",\n    CASE\n        WHEN \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" LIKE '%AUTOMATIC%'\n             OR \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" = 'OM_CLOSE'\n             OR \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" = 'OM_CANCEL' \n             THEN 'Automatic'\n        WHEN \"OE_ORDER_HOLDS_ALL\".\"RELEASED_FLAG\" = 'Y' \n             THEN 'Manual'\n    END                                                                    AS \"ReleaseExecutionType\",\n    <%=sourceSystem%>                                                      AS \"SourceSystemInstance\",\n    <%=sourceSystem%> || '::' || \"OE_ORDER_HOLDS_ALL\".\"HEADER_ID\"          AS \"SalesOrder\"\nFROM\n    \"OE_ORDER_HOLDS_ALL\" AS \"OE_ORDER_HOLDS_ALL\"\n         LEFT JOIN \"OE_HOLD_SOURCES_ALL\" AS \"OE_HOLD_SOURCES_ALL\"\n                   ON \"OE_ORDER_HOLDS_ALL\".\"HOLD_SOURCE_ID\" = \"OE_HOLD_SOURCES_ALL\".\"HOLD_SOURCE_ID\"\n                       AND \"OE_ORDER_HOLDS_ALL\".\"ORG_ID\" = \"OE_HOLD_SOURCES_ALL\".\"ORG_ID\"\n         LEFT JOIN \"OE_HOLD_DEFINITIONS\" AS \"OE_HOLD_DEFINITIONS\"\n                   ON \"OE_HOLD_SOURCES_ALL\".\"HOLD_ID\" = \"OE_HOLD_DEFINITIONS\".\"HOLD_ID\"\n         LEFT JOIN \"OE_HOLD_RELEASES\" AS \"OE_HOLD_RELEASES\"\n                   ON \"OE_ORDER_HOLDS_ALL\".\"HOLD_RELEASE_ID\" = \"OE_HOLD_RELEASES\".\"HOLD_RELEASE_ID\"\n         LEFT JOIN \"FND_LOOKUP_VALUES\" AS \"FND_LOOKUP_VALUES\"\n                   ON \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\" = \"FND_LOOKUP_VALUES\".\"LOOKUP_CODE\"\n                       AND \"FND_LOOKUP_VALUES\".\"ZD_EDITION_NAME\" = 'SET1' \n                       AND \"FND_LOOKUP_VALUES\".\"LOOKUP_TYPE\" = 'HOLD_TYPE'\n                       AND \"FND_LOOKUP_VALUES\".\"VIEW_APPLICATION_ID\" = '660'\n                       AND \"FND_LOOKUP_VALUES\".\"LANGUAGE\" = <%=LanguageKey%> \nWHERE \"OE_ORDER_HOLDS_ALL\".\"LINE_ID\" IS NULL\n  AND \"OE_HOLD_SOURCES_ALL\".\"HOLD_ENTITY_CODE\" != 'C'\n  AND \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\" = 'CREDIT'\n  UNION\n  --Billing and Delivery Block\n  SELECT\n    <%=sourceSystem%> \n    || '::' || CAST(\"OE_ORDER_HOLDS_ALL\".\"ORDER_HOLD_ID\" AS VARCHAR(255)) AS \"ID\",\n       CAST(\"OE_ORDER_HOLDS_ALL\".\"CREATION_DATE\" AS TIMESTAMP)            AS \"CreationTime\",\n       CASE\n           WHEN \"OE_HOLD_DEFINITIONS\".\"ACTIVITY_NAME\"\n               IN ('HEADER_INVOICE_INTERFACE', 'INVOICE_INTERFACE')\n               THEN 'BillingBlock'\n           ELSE 'DeliveryBlock'\n        END                                                               AS \"BlockType\",\n       \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\"                                  AS \"FirstBlockReason\",\n       CASE\n           WHEN \"OE_ORDER_HOLDS_ALL\".\"RELEASED_FLAG\" = 'N'\n               THEN \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\" \n        END                                                               AS \"LatestBlockReason\",\n       CASE\n           WHEN \"OE_ORDER_HOLDS_ALL\".\"RELEASED_FLAG\" = 'N'\n               THEN \"FND_LOOKUP_VALUES\".\"MEANING\" \n        END                                                               AS \"LatestBlockReasonText\",\n       <%=sourceSystem%> || '::' || \"OE_ORDER_HOLDS_ALL\".\"CREATED_BY\"     AS \"BlockedBy\",\n       CASE\n           WHEN \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\" = 'HOLD' \n               THEN 'Manual'\n           ELSE 'Automatic'\n           END                                                            AS \"BlockExecutionType\",\n       NULL                                                               AS \"BlockFromSalesOrder\",\n       CAST(\"OE_HOLD_RELEASES\".\"CREATION_DATE\" AS TIMESTAMP)              AS \"ReleaseTime\",\n       CASE\n           WHEN \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" IS NOT NULL\n                THEN\n                    CASE\n                        WHEN \"OE_HOLD_DEFINITIONS\".\"ACTIVITY_NAME\"\n                            IN ('HEADER_INVOICE_INTERFACE', 'INVOICE_INTERFACE')\n                            THEN 'BillingBlock'\n                        ELSE 'DeliveryBlock'\n                    END\n        END                                                               AS \"ReleaseType\",\n       \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\"                           AS \"ReleaseReason\",\n       <%=sourceSystem%> || '::' || \"OE_HOLD_RELEASES\".\"CREATED_BY\"       AS \"ReleasedBy_ID\",\n       CASE\n           WHEN \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" LIKE '%AUTOMATIC%'\n               OR \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" = 'OM_CLOSE'\n               OR \"OE_HOLD_RELEASES\".\"RELEASE_REASON_CODE\" = 'OM_CANCEL'\n               THEN 'Automatic'\n           WHEN \"OE_ORDER_HOLDS_ALL\".\"RELEASED_FLAG\" = 'Y'\n               THEN 'Manual'\n           END                                                            AS \"ReleaseExecutionType\",\n       <%=sourceSystem%>                                                  AS \"SourceSystemInstance\",\n       <%=sourceSystem%> || '::' || \"OE_ORDER_HOLDS_ALL\".\"HEADER_ID\"      AS \"SalesOrder\"\nFROM \"OE_ORDER_HOLDS_ALL\" AS \"OE_ORDER_HOLDS_ALL\"\n    LEFT JOIN \"OE_HOLD_SOURCES_ALL\" AS \"OE_HOLD_SOURCES_ALL\"\n        ON \"OE_ORDER_HOLDS_ALL\".\"HOLD_SOURCE_ID\" = \"OE_HOLD_SOURCES_ALL\".\"HOLD_SOURCE_ID\"\n            AND \"OE_ORDER_HOLDS_ALL\".\"ORG_ID\" = \"OE_HOLD_SOURCES_ALL\".\"ORG_ID\"\n    LEFT JOIN \"OE_HOLD_DEFINITIONS\" AS \"OE_HOLD_DEFINITIONS\"\n        ON \"OE_HOLD_SOURCES_ALL\".\"HOLD_ID\" = \"OE_HOLD_DEFINITIONS\".\"HOLD_ID\"\n    LEFT JOIN \"OE_HOLD_RELEASES\" AS \"OE_HOLD_RELEASES\"\n        ON \"OE_ORDER_HOLDS_ALL\".\"HOLD_RELEASE_ID\" = \"OE_HOLD_RELEASES\".\"HOLD_RELEASE_ID\"\n    LEFT JOIN \"FND_LOOKUP_VALUES\" AS \"FND_LOOKUP_VALUES\"\n        ON \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\" = \"FND_LOOKUP_VALUES\".\"LOOKUP_CODE\"\n            AND \"FND_LOOKUP_VALUES\".\"ZD_EDITION_NAME\" = 'SET1' \n            AND \"FND_LOOKUP_VALUES\".\"LOOKUP_TYPE\" = 'HOLD_TYPE'\n            AND \"FND_LOOKUP_VALUES\".\"VIEW_APPLICATION_ID\" = '660'\n            AND \"FND_LOOKUP_VALUES\".\"LANGUAGE\" = <%=LanguageKey%> \nWHERE \"OE_ORDER_HOLDS_ALL\".\"LINE_ID\" IS NULL\n  AND \"OE_HOLD_DEFINITIONS\".\"TYPE_CODE\" != 'CREDIT'\n  AND \"OE_HOLD_SOURCES_ALL\".\"HOLD_ENTITY_CODE\" != 'C'\n  AND \"OE_HOLD_DEFINITIONS\".\"ACTIVITY_NAME\" IN ('HEADER_INVOICE_INTERFACE', 'INVOICE_INTERFACE', 'LINE_SCHEDULING')\n )\nSELECT   \n\"ID\"                    AS \"ID\",\n\"CreationTime\"          AS \"CreationTime\",\n \"BlockType\"            AS \"BlockType\",\n\"FirstBlockReason\"\t    AS \"FirstBlockReason\",\n\"LatestBlockReason\"     AS \"LatestBlockReason\",\n\"LatestBlockReasonText\" AS \"LatestBlockReasonText\",\n\"BlockedBy\"             AS \"BlockedBy\",\n\"BlockExecutionType\"    AS \"BlockExecutionType\",\n\"BlockFromSalesOrder\"   AS \"BlockFromSalesOrder\",\n\"ReleaseTime\"           AS \"ReleaseTime\",\n\"ReleaseType\"           AS \"ReleaseType\",\n\"ReleaseReason\"         AS \"ReleaseReason\",\n\"ReleasedBy\"            AS \"ReleasedBy\",\n\"ReleaseExecutionType\"  AS \"ReleaseExecutionType\",\n\"SourceSystemInstance\"  AS \"SourceSystemInstance\",\n\"SalesOrder\"            AS \"SalesOrder\"\nFROM \"CTE_SalesOrderBlock\""
                    }
                ],
                "relationship_transformations": []
            }
        ]
    },
    {
        "change_date": 1762782265325.0,
        "changed_by": {
            "id": "bdec2b77-569a-4c86-86a1-73c0f6bbb6c4",
            "name": "Andi",
            "type_": "USER"
        },
        "created_by": {
            "id": "2202cbc9-7251-4630-bfb2-36812e688613",
            "name": "l.pigozzi",
            "type_": "USER"
        },
        "creation_date": 1749634858875.0,
        "data_connection_id": "b9f449da-3a15-43d8-89e3-0e87e54fb5af",
        "description": null,
        "disabled": null,
        "display_name": "SalesOrderBlock - 00. Central Extraction Pool_TS1",
        "draft": null,
        "factory_id": "e7691b49-5f68-47cf-a8d7-09bdf94f76cf",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "LanguageKey",
                "value": "'E'"
            },
            {
                "name": "sourceSystem",
                "value": "'SAP_ECC'"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "SalesOrderBlock",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [
                    {
                        "id": "CDPOS",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "WITH \"CTE_JoinTable\" AS (\n    SELECT\n        SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)      AS \"JoinID\",\n        \"CDPOS\".\"MANDANT\"                                      AS \"MANDANT\",\n        \"CDPOS\".\"OBJECTCLAS\"                                   AS \"OBJECTCLAS\",\n        \"CDPOS\".\"OBJECTID\"                                     AS \"OBJECTID\",\n        \"CDPOS\".\"FNAME\"                                        AS \"FNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                    AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                    AS \"VALUE_OLD\",\n        \"CDPOS\".\"TABNAME\"                                      AS \"TABNAME\",\n        \"CDHDR\".\"UDATE\"                                        AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                        AS \"UTIME\",\n        \"CDPOS\".\"CHNGIND\"                                      AS \"CHNGIND\",\n        \"CDHDR\".\"USERNAME\"                                     AS \"USERNAME\",\n        \"CDHDR\".\"TCODE\"                                        AS \"TCODE\",\n        \"CDHDR\".\"CHANGENR\"                                     AS \"CHANGENR\",\n        \"USR02\".\"USTYP\"                                        AS \"USTYP\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = 'VERKBELEG'\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK', 'VBUK')\n            AND \"CDPOS\".\"FNAME\" IN ('FAKSK', 'LIFSK', 'CMGST')\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                          AS \"BlockID\",\n            CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                INTERVAL '86399' SECOND)                                  AS \"BlockTime\",\n            CASE\n                WHEN \"JoinTable\".\"FNAME\" = 'FAKSK'\n                    THEN 'BillingBlock'\n                WHEN \"JoinTable\".\"FNAME\" = 'LIFSK'\n                    THEN 'DeliveryBlock'\n            END                                                           AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                        AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                       AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                       AS \"VALUE_OLD\",\n            \"JoinTable\".\"MANDANT\" || '::' || \"JoinTable\".\"USERNAME\"       AS \"BlockedBy\",\n            CASE\n                WHEN \"JoinTable\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                           AS \"BlockExecutionType\",\n            \"JoinTable\".\"TCODE\"                                           AS \"BlockOperationType\",\n            \"JoinTable\".\"CHANGENR\"                                        AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                                          AS \"SalesOrderID\",\n            \"JoinTable\".\"MANDANT\"                                         AS \"MANDANT\",\n            \"JoinTable\".\"OBJECTCLAS\"                                      AS \"OBJECTCLAS\",\n            \"JoinTable\".\"OBJECTID\"                                        AS \"OBJECTID\",\n            \"JoinTable\".\"FNAME\"                                           AS \"FNAME\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"CHNGIND\" = 'U'\n            AND \"JoinTable\".\"TABNAME\" = 'VBAK'\n            AND \"JoinTable\".\"FNAME\" IN ('FAKSK', 'LIFSK')\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n        UNION ALL\n        SELECT\n            \"JoinTable\".\"JoinID\"                                          AS \"BlockID\",\n            CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                INTERVAL '86399' SECOND)                                  AS \"BlockTime\",\n            'CreditBlock'                                                 AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                        AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                       AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                       AS \"VALUE_OLD\",\n            \"JoinTable\".\"MANDANT\" || '::' || \"JoinTable\".\"USERNAME\"       AS \"BlockedBy\",\n            CASE\n                WHEN \"JoinTable\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                           AS \"BlockExecutionType\",\n            \"JoinTable\".\"TCODE\"                                           AS \"BlockOperationType\",\n            \"JoinTable\".\"CHANGENR\"                                        AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                                          AS \"SalesOrderID\",\n            \"JoinTable\".\"MANDANT\"                                         AS \"MANDANT\",\n            \"JoinTable\".\"OBJECTCLAS\"                                      AS \"OBJECTCLAS\",\n            \"JoinTable\".\"OBJECTID\"                                        AS \"OBJECTID\",\n            \"JoinTable\".\"FNAME\"                                           AS \"FNAME\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"CHNGIND\" = 'U'\n            AND \"JoinTable\".\"TABNAME\" = 'VBUK'\n            AND \"JoinTable\".\"FNAME\" = 'CMGST'\n            AND (NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL OR \"JoinTable\".\"VALUE_OLD\" IN ('A', 'D'))\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n            AND \"JoinTable\".\"VALUE_NEW\" NOT IN ('A', 'D')\n    ),\n    \"CTE_MinBlock\" AS (\n        SELECT\n            \"JoinTable\".\"CHANGENR\"                                          AS \"CHANGENR\",\n            \"JoinTable\".\"JoinID\"                                            AS \"JoinID\",\n            \"JoinTable\".\"FNAME\"                                             AS \"FNAME\",\n            MIN(TIMESTAMPDIFF(SECOND, \"BlockFromChangelog\".\"BlockTime\",\n                CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                    COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                    \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                    INTERVAL '86399' SECOND)))                               AS \"LatestBlockSelector\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"BlockFromChangelog\"\n            ON \"JoinTable\".\"MANDANT\" = \"BlockFromChangelog\".\"MANDANT\"\n                AND \"JoinTable\".\"OBJECTCLAS\" = \"BlockFromChangelog\".\"OBJECTCLAS\"\n                AND \"JoinTable\".\"OBJECTID\" = \"BlockFromChangelog\".\"OBJECTID\"\n                AND \"JoinTable\".\"JoinID\" = \"BlockFromChangelog\".\"BlockID\"\n                AND CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                    COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                    \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                    INTERVAL '86399' SECOND)\n                    >= \"BlockFromChangelog\".\"BlockTime\"\n                AND \"JoinTable\".\"FNAME\" = \"BlockFromChangelog\".\"FNAME\"\n        GROUP BY \"JoinTable\".\"CHANGENR\", \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    )\nSELECT\n    <%=sourceSystem%>\n        || '::' || \"JoinTable\".\"JoinID\"\n        || '::' || COALESCE(\"BlockFromChangelog\".\"SystemBlockNumber\", '-1')\n        || '::'\n        || CASE\n            WHEN \"JoinTable\".\"FNAME\" = 'FAKSK'\n                THEN 'BillingBlock'\n            WHEN \"JoinTable\".\"FNAME\" = 'LIFSK'\n                THEN 'DeliveryBlock'\n            WHEN \"JoinTable\".\"FNAME\" = 'CMGST'\n                THEN 'CreditBlock'\n            END                                                              AS \"ObjectID\",\n    <%=sourceSystem%>\n        || '::' || \"JoinTable\".\"JoinID\" \n        || '::' || \"JoinTable\".\"TABNAME\"\n        || '::' || \"JoinTable\".\"FNAME\"\n        || '::' || \"JoinTable\".\"CHANGENR\"\n        || '::' || \"JoinTable\".\"CHNGIND\"                                     AS \"ID\",\n    CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n        CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n        \"JoinTable\".\"UTIME\") AS INTERVAL SECOND)                             AS \"Time\",\n    'LatestBlockReason'                                                      AS \"Attribute\",\n    \"JoinTable\".\"VALUE_OLD\"                                                  AS \"OldValue\",\n    \"JoinTable\".\"VALUE_NEW\"                                                  AS \"NewValue\",\n    <%=sourceSystem%>\n        || '::' || \"JoinTable\".\"MANDANT\" \n        || '::' || \"JoinTable\".\"USERNAME\"                                    AS \"ChangedBy\",\n    \"JoinTable\".\"TCODE\"                                                      AS \"OperationType\",\n    \"JoinTable\".\"CHANGENR\"                                                   AS \"OperationID\",\n    CASE\n        WHEN \"JoinTable\".\"USTYP\" IN ('B', 'C')\n            THEN 'Automatic'\n        ELSE 'Manual'\n        END                                                                  AS \"ExecutionType\"\nFROM \"CTE_JoinTable\" AS \"JoinTable\"\nLEFT JOIN \"CTE_MinBlock\" AS \"MinBlock\"\n    ON \"JoinTable\".\"CHANGENR\" = \"MinBlock\".\"CHANGENR\"\n        AND \"JoinTable\".\"JoinID\" = \"MinBlock\".\"JoinID\"\n        AND \"JoinTable\".\"FNAME\" = \"MinBlock\".\"FNAME\"\nLEFT JOIN \"CTE_BlockFromChangelog\" AS \"BlockFromChangelog\"\n    ON \"JoinTable\".\"MANDANT\" = \"BlockFromChangelog\".\"MANDANT\"\n        AND \"JoinTable\".\"OBJECTCLAS\" = \"BlockFromChangelog\".\"OBJECTCLAS\"\n        AND \"JoinTable\".\"OBJECTID\" = \"BlockFromChangelog\".\"OBJECTID\"\n        AND \"JoinTable\".\"JoinID\" = \"BlockFromChangelog\".\"BlockID\"\n        AND CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n            COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n            \"JoinTable\".\"UTIME\") AS INTERVAL SECOND), INTERVAL '86399' SECOND)\n            >= \"BlockFromChangelog\".\"BlockTime\"\n        AND \"JoinTable\".\"FNAME\" = \"BlockFromChangelog\".\"FNAME\"\n        AND TIMESTAMPDIFF(SECOND, \"BlockFromChangelog\".\"BlockTime\",\n            CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                INTERVAL '86399' SECOND))\n            = \"MinBlock\".\"LatestBlockSelector\"\nWHERE \"JoinTable\".\"CHNGIND\" = 'U'\n    AND (\n        (\n            \"JoinTable\".\"TABNAME\" = 'VBAK'\n            AND \"JoinTable\".\"FNAME\" IN ('FAKSK', 'LIFSK')\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n        )\n        OR (\n            \"JoinTable\".\"TABNAME\" = 'VBUK'\n            AND \"JoinTable\".\"FNAME\" = 'CMGST'\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL AND \"JoinTable\".\"VALUE_OLD\" NOT IN ('A', 'D')\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL AND \"JoinTable\".\"VALUE_NEW\" NOT IN ('A', 'D')\n        )\n    )"
                    }
                ],
                "foreign_key_names": [
                    "BlockedBy",
                    "ReleasedBy",
                    "SalesOrder"
                ],
                "namespace": "custom",
                "property_names": [
                    "BlockExecutionType",
                    "BlockFromSalesOrder",
                    "BlockType",
                    "CreationTime",
                    "FirstBlockReason",
                    "ID",
                    "LatestBlockReason",
                    "LatestBlockReasonText",
                    "ReleaseExecutionType",
                    "ReleaseReason",
                    "ReleaseTime",
                    "ReleaseType",
                    "SourceSystemInstance"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "BillingBlock",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "/*\n1. CTE_Releases: All recorded Release Events (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NULL)\n2. CTE_Changes: All recorded changes of the BlockingField (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NOT NULL)\n3. CTE_BlockFromChangelog: All recorded Block sets (except the ones during creation) (OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL)\n4. CTE_ImplicitActiveBlocks: Block field is NOT NULL (-> we know there is a block) and no entries in BlocksFromChangeLog\n5. CTE_FirstAction: Aggregate Changelog per ObjectID. Keep the earliest entry.\n6. CTE_ImplicitInactiveBlocks: FirstAction for a specific ObjectID is either a Release or a Change -> Implicit Block\n7. CTE_Block: UNION of 3, 4 and 6 */\n/*\nRecreated Information: Joined relevant information from CDPOS (change doc Item) and CDHDR (change doc Header)\nto build a base table with all fields needed to build the CTE tables to capture all relevant changes to block statues.\n */\nWITH \"CTE_JoinTable\" AS (\n    SELECT\n        SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)                       AS \"JoinID\",\n        CAST(\"CDHDR\".\"UDATE\" AS DATE) +\n            COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"CDHDR\".\"UTIME\" AS DATE),\n            \"CDHDR\".\"UTIME\") AS INTERVAL SECOND),\n            INTERVAL '86399' SECOND)                                            AS \"JoinTime\",\n        \"CDHDR\".\"MANDANT\"                                                       AS \"MANDANT\",\n        \"CDHDR\".\"UDATE\"                                                         AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                                         AS \"UTIME\",\n        \"CDPOS\".\"FNAME\"                                                         AS \"FNAME\",\n        \"CDPOS\".\"TABNAME\"                                                       AS \"TABNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                                     AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                                     AS \"VALUE_OLD\",\n        \"CDHDR\".\"MANDANT\" || '::' || \"CDHDR\".\"USERNAME\"                         AS \"JoinUserID\",\n        CASE\n            WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                THEN 'Automatic'\n            ELSE 'Manual'\n        END                                                                     AS \"JoinExecutionType\",\n        \"CDHDR\".\"TCODE\"                                                         AS \"JoinOperationType\",\n        \"CDHDR\".\"CHANGENR\"                                                      AS \"JoinSystemNumber\",\n        \"CDPOS\".\"OBJECTCLAS\"                                                    AS \"OBJECTCLAS\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK')\n            AND \"CDPOS\".\"FNAME\" IN ('FAKSK')\n            AND \"CDPOS\".\"OBJECTCLAS\" = 'VERKBELEG'\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n/* Recreated Information : Capture release of blocks (Billing block from VBAK, Condition on scenarios where VALUE_OLD IS NOT NULL,\nand VALUE_NEW IS NULL  */\n    \"CTE_Releases\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"ReleasesID\",\n            \"JoinTable\".\"JoinTime\"                                                                                                  AS \"ReleaseTime\",\n            \"JoinTable\".\"MANDANT\"                                                                                                   AS \"MANDANT\",\n            'BillingBlock'                                                                                                          AS \"ReleaseType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                                                                                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                                                                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                                                                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                                                                                AS \"ReleasedBy_ID\",\n            \"JoinTable\".\"JoinExecutionType\"                                                                                         AS \"ReleaseExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                                                                                         AS \"ReleaseOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                                                                                          AS \"SystemReleaseNumber\",\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"SalesOrderID\",\n            ROW_NUMBER()\n            OVER (PARTITION BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\" ORDER BY \"JoinTable\".\"UDATE\" ASC, \"JoinTable\".\"UTIME\" ASC) AS \"ReleaseRN\" /* assigns a sequential number (\"ReleaseRN\") to each record, ordered chronologically by date and time, \n            but restarts the numbering for every unique combination of \"JoinID\" and \"FNAME\" */\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NULL\n    ),\n/* Recreated Information : Captures all changes occurring to blocks (Excluding setting of block at creation or at a later stage , and release of block).\nMust meet condition of scenario: VALUE_OLD AND VALUE_NEW IS NOT NULL  */\n    \"CTE_Changes\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"ID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"ChangeTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'BillingBlock'                         AS \"ChangeType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"ChangeBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"ChangeExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"ChangeOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"ChangeID\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: All recorded Block sets (except the ones during creation)\nMust meet condition of scenario: OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL */\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'BillingBlock'                         AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"BlockedBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"BlockExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"BlockOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: Based on VBAK , captures sales orders which are currently blocked, uses the prior CTE tables to ensure that this sales order\nhas no change entries. Queries each block type seperately, and unions all together.\nMust meet condition of scenario: Block field is NOT NULL (actively blocked) and no entries in BlocksFromChangeLog */\n    \"CTE_ImplicitActiveBlock\" AS (\n        SELECT\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"BlockID\",\n            CAST(\"VBAK\".\"ERDAT\" AS DATE) +\n                CAST(TIMESTAMPDIFF(SECOND, CAST(\"VBAK\".\"ERZET\" AS DATE),\n                \"VBAK\".\"ERZET\") AS INTERVAL SECOND)                                      AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                               AS \"MANDANT\",\n            'BillingBlock'                                                               AS \"BlockType\",\n            'Block to ' || \"VBAK\".\"FAKSK\"                                                AS \"ValueType\",\n            \"VBAK\".\"FAKSK\"                                                               AS \"VALUE_NEW\",\n            NULL                                                                         AS \"VALUE_OLD\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"                                     AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                          AS \"BlockExecutionType\",\n            NULL                                                                         AS \"BlockOperationType\",\n            '-1'                                                                         AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"SalesOrderID\"\n        FROM \"VBAK\" AS \"VBAK\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"Block\"\n            ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"Releases\".\"ReleasesID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"Changes\".\"ID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"Block\".\"BlockID\", '') IS NULL\n            AND NULLIF(\"Changes\".\"ID\", '') IS NULL\n            AND NULLIF(\"Releases\".\"ReleasesID\", '') IS NULL\n            AND NULLIF(\"VBAK\".\"FAKSK\", '') IS NOT NULL\n    ),\n/* Recreated Information: Indicating the earliest timestamp when a billing block\nwas set for a given record (CDPOS.TABKEY) , split per ObjectID.  */\n    \"CTE_FirstAction\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"        AS \"BlockID\",\n            MIN(\"JoinTable\".\"JoinTime\") AS \"BlockTime\",\n            'BillingBlock'              AS \"BlockType\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        GROUP BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    ),\n/* Recreated Information: identifies an active billing block from a sales order's creation.\nIt links the earliest block times (from CTE_FirstAction) with sales order details and\nchecks for matching initial change or release records to define these \"implicit\" block activations.\n\nThe CTE assumes that if a block type identified in CTE_FirstAction exists for a sales order,\nand there isn't a specific change or release event recorded at the BlockTime from CTE_FirstAction,\nthen the block was implicitly active from the moment the sales order was created. */\n    \"CTE_ImplicitInactiveBlock\" AS (\n        SELECT\n            \"FirstAction\".\"BlockID\"                                                        AS \"BlockID\",\n            CAST(\"VBAK\".\"ERDAT\" AS DATE) + CAST(TIMESTAMPDIFF(SECOND, CAST(\"VBAK\".\"ERZET\" AS DATE),\n                \"VBAK\".\"ERZET\") AS INTERVAL SECOND)                                        AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                                 AS \"MANDANT\",\n            \"FirstAction\".\"BlockType\"                                                      AS \"BlockType\",\n            'Block to '\n                ||\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"ValueType\", -- Checks for a change event first, if non-existant checks for release event\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"VALUE_NEW\",\n            NULL                                                                           AS \"VALUE_OLD\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"                                       AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                            AS \"BlockExecutionType\",\n            NULL                                                                           AS \"BlockOperationType\",\n            '-1'                                                                           AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                       AS \"SalesOrderID\"\n        FROM \"CTE_FirstAction\" AS \"FirstAction\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"FirstAction\".\"BlockID\" = \"Changes\".\"ID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Changes\".\"ChangeTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Changes\".\"ChangeType\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"FirstAction\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Releases\".\"ReleaseTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Releases\".\"ReleaseType\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"FirstAction\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND (NULLIF(\"Changes\".\"ID\", '') IS NOT NULL\n            OR NULLIF(\"Releases\".\"ReleasesID\", '') IS NOT NULL)\n    ),\n/* Recreated Information: CTE_ImplicitDuplicates identifies block events that appear in both CTE_ImplicitInactiveBlock\nand CTE_ImplicitActiveBlock (based on BlockID, BlockTime, and BlockType), effectively finding duplicate records of the same block event.\n*/\n    \"CTE_ImplicitDuplicates\" AS (\n        SELECT\n            \"Inactive\".\"BlockID\",\n            \"Inactive\".\"BlockTime\",\n            \"Inactive\".\"BlockType\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"Inactive\"\n        LEFT JOIN \"CTE_ImplicitActiveBlock\" AS \"Active\"\n            ON \"Inactive\".\"BlockID\" = \"Active\".\"BlockID\"\n                AND \"Inactive\".\"BlockTime\" = \"Active\".\"BlockTime\"\n                AND \"Inactive\".\"BlockType\" = \"Active\".\"BlockType\"\n        WHERE NULLIF(\"Active\".\"BlockID\", '') IS NOT NULL\n    ),\n/* Recreated Information: CTE_ImplicitActiveBlockNoDuplicates selects active implicit block records\nfrom CTE_ImplicitActiveBlock, excluding any records that are also found in CTE_ImplicitDuplicates.\nThis results in a set of unique active implicit block events.\n\nThis CTE removes duplicates between the ImplicitBlock CTEs from ActiveBlocks.\n*/\n    \"CTE_ImplicitActiveBlockNoDuplicates\" AS (\n        SELECT\n            \"Active\".*\n        FROM \"CTE_ImplicitActiveBlock\" AS \"Active\"\n        LEFT JOIN \"CTE_ImplicitDuplicates\" AS \"Duplicates\"\n            ON \"Active\".\"BlockID\" = \"Duplicates\".\"BlockID\"\n                AND \"Active\".\"BlockTime\" = \"Duplicates\".\"BlockTime\"\n                AND \"Active\".\"BlockType\" = \"Duplicates\".\"BlockType\"\n        WHERE NULLIF(\"Duplicates\".\"BlockID\", '') IS NULL\n    ),\n/* Recreated Information: Combines all entries with sales orders which currently have a billing block , sales orders implicitly blocked\n(blocked since moment of creation), and the log of all recorded Block sets (except the ones during creation)   */\n    \"CTE_BlockNoRN\" AS (\n        SELECT\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitActiveBlockNoDuplicates\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitActiveBlockNoDuplicates\" AS \"ImplicitActiveBlockNoDuplicates\"\n        UNION\n        SELECT\n            \"ImplicitInactiveBlock\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitInactiveBlock\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitInactiveBlock\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitInactiveBlock\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitInactiveBlock\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitInactiveBlock\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitInactiveBlock\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitInactiveBlock\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitInactiveBlock\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitInactiveBlock\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitInactiveBlock\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitInactiveBlock\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"ImplicitInactiveBlock\"\n        UNION\n        SELECT\n            \"CTE_BlockFromChangelog\".\"BlockID\"            AS \"BlockID\",\n            \"CTE_BlockFromChangelog\".\"BlockTime\"          AS \"BlockTime\",\n            \"CTE_BlockFromChangelog\".\"MANDANT\"            AS \"MANDANT\",\n            \"CTE_BlockFromChangelog\".\"BlockType\"          AS \"BlockType\",\n            \"CTE_BlockFromChangelog\".\"ValueType\"          AS \"ValueType\",\n            \"CTE_BlockFromChangelog\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"CTE_BlockFromChangelog\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"CTE_BlockFromChangelog\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"CTE_BlockFromChangelog\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"CTE_BlockFromChangelog\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"CTE_BlockFromChangelog\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"CTE_BlockFromChangelog\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_BlockFromChangelog\"\n    ),\n    \"CTE_Block\" AS (\n        SELECT\n            *,\n            ROW_NUMBER()\n            OVER (PARTITION BY \"CTE_BlockNoRN\".\"BlockID\", \"CTE_BlockNoRN\".\"BlockType\" ORDER BY \"CTE_BlockNoRN\".\"BlockTime\" ASC) AS \"BlockRN\"\n        FROM \"CTE_BlockNoRN\"\n    )\n/* Actual attribute mapping for object */\nSELECT\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockID\" \n        || '::' || \"Block\".\"SystemBlockNumber\" \n        || '::' || \"Block\".\"BlockType\"                           AS \"ID\",\n    \"Block\".\"BlockTime\"                                          AS \"CreationTime\",\n    COALESCE(\"Block\".\"BlockType\", \"Releases\".\"ReleaseType\")      AS \"BlockType\",\n    \"Block\".\"VALUE_NEW\"                                          AS \"FirstBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'BillingBlock'\n            THEN COALESCE(\"VBAK\".\"FAKSK\", 'Data cut - no entry in VBAK')\n    END                                                          AS \"LatestBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'BillingBlock'\n            THEN \"TVFST\".\"VTEXT\"\n    END                                                          AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockedBy\"             AS \"BlockedBy\",\n    \"Block\".\"BlockExecutionType\"                                 AS \"BlockExecutionType\",\n    CASE WHEN \"Block\".\"SystemBlockNumber\" = '-1' THEN 'X' END    AS \"BlockFromSalesOrder\",\n    \"Releases\".\"ReleaseTime\"                                     AS \"ReleaseTime\",\n    \"Releases\".\"ReleaseType\"                                     AS \"ReleaseType\",\n    \"Releases\".\"VALUE_OLD\"                                       AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"Releases\".\"ReleasedBy_ID\"      AS \"ReleasedBy\",\n    \"Releases\".\"ReleaseExecutionType\"                            AS \"ReleaseExecutionType\",\n    <%=sourceSystem%> || '::' || \"Block\".\"SalesOrderID\"          AS \"SalesOrder\",\n    <%=sourceSystem%> || '::' || \"Block\".\"MANDANT\"               AS \"SourceSystemInstance\"\nFROM \"CTE_Block\" AS \"Block\"\nLEFT JOIN \"CTE_Releases\" AS \"Releases\"\n    ON \"Block\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n        AND \"Block\".\"BlockRN\" = \"Releases\".\"ReleaseRN\"\n        AND \"Block\".\"BlockType\" = \"Releases\".\"ReleaseType\"\nLEFT JOIN \"VBAK\" AS \"VBAK\"\n    ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        AND (NULLIF(\"VBAK\".\"FAKSK\", '') IS NOT NULL)\nLEFT JOIN \"TVFST\" AS \"TVFST\"\n    ON \"VBAK\".\"MANDT\" = \"TVFST\".\"MANDT\"\n        AND \"VBAK\".\"FAKSK\" = \"TVFST\".\"FAKSP\"\n        AND \"TVFST\".\"SPRAS\" = <%=LanguageKey%>\n"
                    },
                    {
                        "id": "CreditBlock",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "/*\n1. CTE_Releases: All recorded Release Events (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NULL)\n2. CTE_Changes: All recorded changes of the BlockingField (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NOT NULL)\n3. CTE_BlockFromChangelog: All recorded Block sets (except the ones during creation) (OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL)\n4. CTE_ImplicitActiveBlocks: Block field is NOT NULL (-> we know there is a block) and no entries in BlocksFromChangeLog\n5. CTE_FirstAction: Aggregate Changelog per ObjectID. Keep the earliest entry.\n6. CTE_ImplicitInactiveBlocks: FirstAction for a specific ObjectID is either a Release or a Change -> Implicit Block\n7. CTE_Block: UNION of 3, 4 and 6 */\n/*\nRecreated Information: Joined relevant information from CDPOS (change doc Item) and CDHDR (change doc Header)\nto build a base table with all fields needed to build the CTE tables to capture all relevant changes to block statues.\n */\nWITH \"CTE_JoinTable\" AS (\n    SELECT\n        SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)                        AS \"JoinID\",\n        CAST(\"CDHDR\".\"UDATE\" AS DATE) +\n            COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"CDHDR\".\"UTIME\" AS DATE),\n            \"CDHDR\".\"UTIME\") AS INTERVAL SECOND),\n            INTERVAL '86399' SECOND)                                            AS \"JoinTime\",\n        \"CDHDR\".\"MANDANT\"                                                       AS \"MANDANT\",\n        \"CDHDR\".\"UDATE\"                                                         AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                                         AS \"UTIME\",\n        \"CDPOS\".\"FNAME\"                                                         AS \"FNAME\",\n        \"CDPOS\".\"TABNAME\"                                                       AS \"TABNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                                     AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                                     AS \"VALUE_OLD\",\n        \"CDHDR\".\"MANDANT\" || '::' || \"CDHDR\".\"USERNAME\"                         AS \"JoinUserID\",\n        CASE\n            WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                THEN 'Automatic'\n            ELSE 'Manual'\n        END                                                                     AS \"JoinExecutionType\",\n        \"CDHDR\".\"TCODE\"                                                         AS \"JoinOperationType\",\n        \"CDHDR\".\"CHANGENR\"                                                      AS \"JoinSystemNumber\",\n        \"CDPOS\".\"OBJECTCLAS\"                                                    AS \"OBJECTCLAS\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBUK')\n            AND \"CDPOS\".\"FNAME\" IN ('CMGST')\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n/* Recreated Information : Capture release of blocks (Credit block from VBUK), Condition on scenarios where relevant blocked statuses (NOT A or D in credit block situation),\nor relevant unblocked status (A or D in credit block situation) */\n    \"CTE_DetailedReasons\" AS (\n        SELECT\n            \"VBUK\".\"MANDT\"                                                          AS \"MANDT\",\n            \"VBUK\".\"VBELN\"                                                          AS \"VBELN\",\n            \"VBUK\".\"CMGST\"                                                          AS \"CMGST\",\n            \"VBUK\".\"MANDT\" || '::' || \"VBUK\".\"VBELN\"                                AS \"SalesOrderID\",\n            CASE WHEN \"VBUK\".\"CMPSA\" = 'B' THEN 'Static, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSB\" = 'B' THEN 'DYNA, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSC\" = 'B' THEN 'Value, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSD\" = 'B' THEN 'TPAY, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSE\" = 'B' THEN 'REDA, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSF\" = 'B' THEN 'OpIt, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSG\" = 'B' THEN 'OlIt, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSH\" = 'B' THEN 'Dunn, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSI\" = 'B' THEN 'FDoc, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSJ\" = 'B' THEN 'ECI, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSK\" = 'B' THEN 'PaCa, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSL\" = 'B' THEN 'RES4, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPS0\" = 'B' THEN 'CuR1, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPS1\" = 'B' THEN 'CuR2, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPS2\" = 'B' THEN 'CuR3, ' ELSE '' END             AS \"BlockReason\",\n            CASE WHEN \"VBUK\".\"CMPSA\" = 'B' THEN 'Static Credit Limit, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSB\" = 'B' THEN 'Dynamic Credit Limit in the Credit Horizon, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSC\" = 'B' THEN 'Maximum Document Value, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSD\" = 'B' THEN 'Terms of Payment, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSE\" = 'B' THEN 'Customer Review Date, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSF\" = 'B' THEN 'Open Items Due, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSG\" = 'B' THEN 'Oldest Open Items, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSH\" = 'B' THEN 'Highest Dunning Level, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSI\" = 'B' THEN 'Financial Document, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSJ\" = 'B' THEN 'Export Credit Insurance, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSK\" = 'B' THEN 'Payment Card Authorization, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPSL\" = 'B' THEN 'Reserves 4, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPS0\" = 'B' THEN 'Customer Reserve 1, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPS1\" = 'B' THEN 'Customer Reserve 2, ' ELSE '' END ||\n            CASE WHEN \"VBUK\".\"CMPS2\" = 'B' THEN 'Customer Reserve 3, ' ELSE '' END\n                                                                                    AS \"BlockReasonText\"\n        FROM \"VBUK\"\n    ),\n    \"CTE_DetailedReasonsNoComma\" AS (\n        SELECT\n            \"DetailedReasons\".\"MANDT\"                                                           AS \"MANDT\",\n            \"DetailedReasons\".\"VBELN\"                                                           AS \"VBELN\",\n            \"DetailedReasons\".\"CMGST\"                                                           AS \"CMGST\",\n            \"DetailedReasons\".\"SalesOrderID\"                                                    AS \"SalesOrderID\",\n            CASE\n                WHEN LENGTH(\"DetailedReasons\".\"BlockReason\") < 2 THEN NULL\n                ELSE SUBSTRING(\"DetailedReasons\".\"BlockReason\", 1, LENGTH(\"DetailedReasons\".\"BlockReason\") - 2)\n            END                                                                                 AS \"BlockReason\",\n            CASE\n                WHEN LENGTH(\"DetailedReasons\".\"BlockReasonText\") < 2 THEN NULL\n                ELSE SUBSTRING(\"DetailedReasons\".\"BlockReasonText\", 1, LENGTH(\"DetailedReasons\".\"BlockReasonText\") - 2)\n            END                                                                                 AS \"BlockReasonText\"\n        FROM \"CTE_DetailedReasons\" AS \"DetailedReasons\"\n    ),\n    \"CTE_DetailedChangeReasons\" AS (\n        SELECT\n            \"CDPOS\".\"CHANGENR\" AS \"SystemChangeNumber\",\n            LISTAGG(\n                CASE\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSA' THEN 'Static'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSB' THEN 'DYNA'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSC' THEN 'Value'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSD' THEN 'TPAY'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSE' THEN 'REDA'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSF' THEN 'OpIt'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSG' THEN 'OlIt'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSH' THEN 'Dunn'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSI' THEN 'FDoc'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSJ' THEN 'ECI'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSK' THEN 'PaCa'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSL' THEN 'RES4'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPS0' THEN 'CuR1'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPS1' THEN 'CuR2'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPS2' THEN 'CuR3'\n                END, ', '\n            )                  AS \"BlockReason\",\n            LISTAGG(\n                CASE\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSA' THEN 'Static Credit Limit'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSB' THEN 'Dynamic Credit Limit in the Credit Horizon'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSC' THEN 'Maximum Document Value'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSD' THEN 'Terms of Payment'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSE' THEN 'Customer Review Date'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSF' THEN 'Open Items Due'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSG' THEN 'Oldest Open Items'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSH' THEN 'Highest Dunning Level'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSI' THEN 'Financial Document'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSJ' THEN 'Export Credit Insurance'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSK' THEN 'Payment Card Authorization'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPSL' THEN 'Reserves 4'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPS0' THEN 'Customer Reserve 1'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPS1' THEN 'Customer Reserve 2'\n                    WHEN \"CDPOS\".\"FNAME\" = 'CMPS2' THEN 'Customer Reserve 3'\n                END, ', '\n            )                  AS \"BlockReasonText\"\n        FROM \"CDPOS\"\n        WHERE \"CDPOS\".\"TABNAME\" IN ('VBUK')\n            AND \"CDPOS\".\"FNAME\" IN ('CMPSA', 'CMPSB', 'CMPSC', 'CMPSD', 'CMPSE', 'CMPSF', 'CMPSG', 'CMPSH', 'CMPSI', 'CMPSJ', 'CMPSK', 'CMPSL', 'CMPS0', 'CMPS1', 'CMPS2')\n        GROUP BY \"CDPOS\".\"CHANGENR\"\n    ),\n    \"CTE_ActionRN\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\" AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\" AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\" AS \"MANDANT\",\n            'CreditBlock' AS \"BlockType\",\n            \"JoinTable\".\"JoinSystemNumber\" AS \"JoinSystemNumber\",\n            \"DetailedChangeReasons\".\"BlockReason\" AS \"DetailedBlockReason\",\n            \"DetailedChangeReasons\".\"BlockReasonText\" AS \"DetailedBlockReasonText\",\n            ROW_NUMBER()\n                OVER (PARTITION BY \"JoinTable\".\"JoinID\" ORDER BY \"JoinTable\".\"JoinTime\" ASC) AS \"RNFirst\",\n            ROW_NUMBER()\n                OVER (PARTITION BY \"JoinTable\".\"JoinID\" ORDER BY \"JoinTable\".\"JoinTime\" DESC) AS \"RNLast\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        LEFT JOIN \"CTE_DetailedChangeReasons\" AS \"DetailedChangeReasons\"\n            ON \"JoinTable\".\"JoinSystemNumber\" = \"DetailedChangeReasons\".\"SystemChangeNumber\"\n        WHERE \"JoinTable\".\"TABNAME\" = 'VBUK'\n            AND \"JoinTable\".\"FNAME\" = 'CMGST'\n    ),\n    \"CTE_FirstAction\" AS (\n        SELECT\n            *\n        FROM \"CTE_ActionRN\" AS \"ActionRN\"\n        WHERE \"ActionRN\".\"RNFirst\" = 1\n    ),\n    \"CTE_LastAction\" AS (\n        SELECT\n            *\n        FROM \"CTE_ActionRN\" AS \"ActionRN\"\n        WHERE \"ActionRN\".\"RNLast\" = 1 AND NULLIF(\"DetailedBlockReason\", '') IS NOT NULL\n    ),\n    \"CTE_Releases\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"ReleasesID\",\n            \"JoinTable\".\"JoinTime\"                                                                                                  AS \"ReleaseTime\",\n            \"JoinTable\".\"MANDANT\"                                                                                                   AS \"MANDANT\",\n            'CreditBlock'                                                                                                           AS \"ReleaseType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                                                                                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                                                                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                                                                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                                                                                AS \"ReleasedBy_ID\",\n            \"JoinTable\".\"JoinExecutionType\"                                                                                         AS \"ReleaseExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                                                                                         AS \"ReleaseOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                                                                                          AS \"SystemReleaseNumber\",\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"SalesOrderID\",\n            COALESCE(\"DetailedChangeReasons\".\"BlockReason\", \"LastAction\".\"DetailedBlockReason\")                                     AS \"DetailedReleaseReason\",\n            COALESCE(\"DetailedChangeReasons\".\"BlockReasonText\", \"LastAction\".\"DetailedBlockReasonText\")                             AS \"DetailedReleaseReasonText\",\n            ROW_NUMBER()\n            OVER (PARTITION BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\" ORDER BY \"JoinTable\".\"UDATE\" ASC, \"JoinTable\".\"UTIME\" ASC) AS \"ReleaseRN\" /* assigns a sequential number (\"ReleaseRN\") to each record, \n            ordered chronologically by date and time, but restarts the numbering for every unique combination of \"JoinID\" and \"FNAME\" */\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        LEFT JOIN \"CTE_DetailedChangeReasons\" AS \"DetailedChangeReasons\"\n            ON \"JoinTable\".\"JoinSystemNumber\" = \"DetailedChangeReasons\".\"SystemChangeNumber\"\n        LEFT JOIN \"CTE_LastAction\" AS \"LastAction\"\n            ON \"JoinTable\".\"JoinID\" = \"LastAction\".\"BlockID\"\n        WHERE \"JoinTable\".\"VALUE_OLD\" NOT IN ('A', 'D')\n            AND (\"JoinTable\".\"VALUE_NEW\" IN ('A', 'D') /* Status representation SAP: A - Credit check was executed, document OK , D - Document released by credit representative) */\n            OR NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NULL)\n    ),\n/* Recreated Information : Captures all changes occurring to blocks (Excluding setting of block at creation or at a later stage , and release of block).\nMust meet condition of scenario: VALUE_OLD AND VALUE_NEW IS NOT NULL AND \"VALUE_OLD\" NOT IN ('A', 'D') AND \"VALUE_NEW\" NOT IN ('A', 'D') */\n    \"CTE_Changes\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"ID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"ChangeTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'CreditBlock'                          AS \"ChangeType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"ChangeBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"ChangeExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"ChangeOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"ChangeID\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"VALUE_OLD\" NOT IN ('A', 'D') -- To ensure it does not capture any already released blocks\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND \"JoinTable\".\"VALUE_NEW\" NOT IN ('A', 'D') -- To ensure it does not capture any credit block releases (already captured in CTE_Releases)\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: All recorded Block sets (except the ones during creation)\nMust meet condition of scenario: OLD_VALUE IS NULL OR \"VALUE_OLD\" IN ('A', 'D') AND NEW_VALUE IS NOT NULL AND \"VALUE_NEW\" NOT IN ('A', 'D') */\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                    AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\"                                  AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\"                                   AS \"MANDANT\",\n            'CreditBlock'                                           AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                AS \"BlockedBy\",\n            \"JoinTable\".\"JoinExecutionType\"                         AS \"BlockExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                         AS \"BlockOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                          AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                                    AS \"SalesOrderID\",\n            COALESCE(\"DetailedChangeReasons\".\"BlockReason\",\n                \"DetailedReasons\".\"BlockReason\")                    AS \"DetailedBlockReason\",\n            COALESCE(\"DetailedChangeReasons\".\"BlockReasonText\",\n                \"DetailedReasons\".\"BlockReasonText\")                AS \"DetailedBlockReasonText\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        LEFT JOIN \"CTE_DetailedChangeReasons\" AS \"DetailedChangeReasons\"\n            ON \"JoinTable\".\"JoinSystemNumber\" = \"DetailedChangeReasons\".\"SystemChangeNumber\"\n        LEFT JOIN \"CTE_DetailedReasonsNoComma\" AS \"DetailedReasons\"\n            ON \"JoinTable\".\"JoinID\" = \"DetailedReasons\".\"SalesOrderID\"\n        WHERE (NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL OR \"JoinTable\".\"VALUE_OLD\" IN ('A', 'D'))\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n            AND \"JoinTable\".\"VALUE_NEW\" NOT IN ('A', 'D')\n    ),\n/* Recreated Information: Based on VBUK , captures sales orders which are currently blocked, uses the prior CTE tables to ensure that this sales order\nhas no change entries. Queries each block type seperately, and unions all together.\nMust meet condition of scenario: Block field is NOT NULL (actively blocked) and no entries in BlocksFromChangeLog */\n    \"CTE_ImplicitActiveBlock\" AS (\n        SELECT\n            \"VBUK\".\"MANDT\" || '::' || \"VBUK\".\"VBELN\"                                      AS \"BlockID\",\n            CAST(\"VBAK\".\"ERDAT\" AS DATE) +\n                CAST(TIMESTAMPDIFF(SECOND, CAST(\"VBAK\".\"ERZET\" AS DATE),\n                \"VBAK\".\"ERZET\")\n                AS INTERVAL SECOND)                                                      AS \"BlockTime\",\n            \"VBUK\".\"MANDT\"                                                               AS \"MANDANT\",\n            'CreditBlock'                                                                AS \"BlockType\",\n            'Block to ' || \"VBUK\".\"CMGST\"                                                AS \"ValueType\",\n            \"VBUK\".\"CMGST\"                                                               AS \"VALUE_NEW\",\n            NULL                                                                         AS \"VALUE_OLD\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"                                     AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                          AS \"BlockExecutionType\",\n            NULL                                                                         AS \"BlockOperationType\",\n            '-1'                                                                         AS \"SystemBlockNumber\",\n            \"VBUK\".\"MANDT\" || '::' || \"VBUK\".\"VBELN\"                                     AS \"SalesOrderID\",\n            \"DetailedReasons\".\"BlockReason\"                                              AS \"DetailedBlockReason\",\n            \"DetailedReasons\".\"BlockReasonText\"                                          AS \"DetailedBlockReasonText\"\n        FROM \"VBUK\" AS \"VBUK\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"Block\"\n            ON \"Block\".\"BlockID\" = \"VBUK\".\"MANDT\" || '::' || \"VBUK\".\"VBELN\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"Releases\".\"ReleasesID\" = \"VBUK\".\"MANDT\" || '::' || \"VBUK\".\"VBELN\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"Changes\".\"ID\" = \"VBUK\".\"MANDT\" || '::' || \"VBUK\".\"VBELN\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"VBUK\".\"MANDT\" = \"VBAK\".\"MANDT\"\n                AND \"VBUK\".\"VBELN\" = \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        LEFT JOIN \"CTE_DetailedReasonsNoComma\" AS \"DetailedReasons\"\n            ON \"VBUK\".\"MANDT\" = \"DetailedReasons\".\"MANDT\"\n                AND \"VBUK\".\"VBELN\" = \"DetailedReasons\".\"VBELN\"\n        WHERE NULLIF(\"Block\".\"BlockID\", '') IS NULL\n            AND NULLIF(\"Changes\".\"ID\", '') IS NULL\n            AND NULLIF(\"Releases\".\"ReleasesID\", '') IS NULL\n            AND NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND NULLIF(\"VBUK\".\"CMGST\", '') IS NOT NULL\n            AND \"VBUK\".\"CMGST\" NOT IN ('A', 'D')\n    ),\n/* Recreated Information: Indicating the earliest timestamp when a credit block\nwas set for a given record (CDPOS.TABKEY) , split per ObjectID.  */\n/* Recreated Information: identifies  credit block events active from a sales order's creation.\nIt links the earliest block times (from CTE_FirstAction) with sales order details and\nchecks for matching initial change or release records to define these \"implicit\" block activations.\n\nThe CTE assumes that if a block type identified in CTE_FirstAction exists for a sales order,\nand there isn't a specific change or release event recorded at the BlockTime from CTE_FirstAction,\nthen the block was implicitly active from the moment the sales order was created. */\n    \"CTE_ImplicitInactiveBlock\" AS (\n        SELECT\n            \"FirstAction\".\"BlockID\"                                                        AS \"BlockID\",\n            CAST(\"VBAK\".\"ERDAT\" AS DATE) +\n                CAST(TIMESTAMPDIFF(SECOND, CAST(\"VBAK\".\"ERZET\" AS DATE),\n                \"VBAK\".\"ERZET\") AS INTERVAL SECOND)                                        AS \"BlockTime\",\n            \"FirstAction\".\"MANDANT\"                                                        AS \"MANDANT\",\n            \"FirstAction\".\"BlockType\"                                                      AS \"BlockType\",\n            'Block to '\n                ||\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"ValueType\", -- Checks for a change event first, if non-existant checks for release event\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"VALUE_NEW\",\n            NULL                                                                           AS \"VALUE_OLD\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"                                       AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                            AS \"BlockExecutionType\",\n            NULL                                                                           AS \"BlockOperationType\",\n            '-1'                                                                           AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                       AS \"SalesOrderID\",\n            \"DetailedChangeReasons\".\"BlockReason\"                                          AS \"DetailedReleaseReason\",\n            \"DetailedChangeReasons\".\"BlockReasonText\"                                      AS \"DetailedReleaseReasonText\"\n        FROM \"CTE_FirstAction\" AS \"FirstAction\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"FirstAction\".\"BlockID\" = \"Changes\".\"ID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Changes\".\"ChangeTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Changes\".\"ChangeType\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"FirstAction\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Releases\".\"ReleaseTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Releases\".\"ReleaseType\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"FirstAction\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        LEFT JOIN \"CTE_DetailedChangeReasons\" AS \"DetailedChangeReasons\"\n            ON \"FirstAction\".\"JoinSystemNumber\" = \"DetailedChangeReasons\".\"SystemChangeNumber\"\n        WHERE NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND (NULLIF(\"Changes\".\"ID\", '') IS NOT NULL\n            OR NULLIF(\"Releases\".\"ReleasesID\", '') IS NOT NULL)\n    ),\n/* Recreated Information: CTE_ImplicitDuplicates identifies block events that appear in both CTE_ImplicitInactiveBlock\nand CTE_ImplicitActiveBlock (based on BlockID, BlockTime, and BlockType), effectively finding duplicate records of the same block event.\n*/\n    \"CTE_ImplicitDuplicates\" AS (\n        SELECT\n            \"Inactive\".\"BlockID\",\n            \"Inactive\".\"BlockTime\",\n            \"Inactive\".\"BlockType\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"Inactive\"\n        LEFT JOIN \"CTE_ImplicitActiveBlock\" AS \"Active\"\n            ON \"Inactive\".\"BlockID\" = \"Active\".\"BlockID\"\n                AND \"Inactive\".\"BlockTime\" = \"Active\".\"BlockTime\"\n                AND \"Inactive\".\"BlockType\" = \"Active\".\"BlockType\"\n        WHERE NULLIF(\"Active\".\"BlockID\", '') IS NOT NULL\n    ),\n/* Recreated Information: CTE_ImplicitActiveBlockNoDuplicates selects active implicit block records\nfrom CTE_ImplicitActiveBlock, excluding any records that are also found in CTE_ImplicitDuplicates.\nThis results in a set of unique active implicit block events.\n\nThis CTE removes duplicates between the ImplicitBlock CTEs from ActiveBlocks.\n*/\n    \"CTE_ImplicitActiveBlockNoDuplicates\" AS (\n        SELECT\n            \"Active\".*\n        FROM \"CTE_ImplicitActiveBlock\" AS \"Active\"\n        LEFT JOIN \"CTE_ImplicitDuplicates\" AS \"Duplicates\"\n            ON \"Active\".\"BlockID\" = \"Duplicates\".\"BlockID\"\n                AND \"Active\".\"BlockTime\" = \"Duplicates\".\"BlockTime\"\n                AND \"Active\".\"BlockType\" = \"Duplicates\".\"BlockType\"\n        WHERE NULLIF(\"Duplicates\".\"BlockID\", '') IS NULL\n    ),\n/* Recreated Information: Combines all entries with sales orders which are currently have a credit block , sales orders implicitly blocked\n(blocked since moment of creation), and the log of all recorded Block sets (except the ones during creation)   */\n    \"CTE_BlockNoRN\" AS (\n        SELECT\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockID\"                  AS \"BlockID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockTime\"                AS \"BlockTime\",\n            \"ImplicitActiveBlockNoDuplicates\".\"MANDANT\"                  AS \"MANDANT\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockType\"                AS \"BlockType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"ValueType\"                AS \"ValueType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockedBy\"                AS \"BlockedBy\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockExecutionType\"       AS \"BlockExecutionType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockOperationType\"       AS \"BlockOperationType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SystemBlockNumber\"        AS \"SystemBlockNumber\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SalesOrderID\"             AS \"SalesOrderID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"DetailedBlockReason\"      AS \"DetailedBlockReason\",\n            \"ImplicitActiveBlockNoDuplicates\".\"DetailedBlockReasonText\"  AS \"DetailedBlockReasonText\"\n        FROM \"CTE_ImplicitActiveBlockNoDuplicates\" AS \"ImplicitActiveBlockNoDuplicates\"\n        UNION\n        SELECT\n            \"ImplicitInactiveBlock\".\"BlockID\"                    AS \"BlockID\",\n            \"ImplicitInactiveBlock\".\"BlockTime\"                  AS \"BlockTime\",\n            \"ImplicitInactiveBlock\".\"MANDANT\"                    AS \"MANDANT\",\n            \"ImplicitInactiveBlock\".\"BlockType\"                  AS \"BlockType\",\n            \"ImplicitInactiveBlock\".\"ValueType\"                  AS \"ValueType\",\n            \"ImplicitInactiveBlock\".\"VALUE_NEW\"                  AS \"VALUE_NEW\",\n            \"ImplicitInactiveBlock\".\"VALUE_OLD\"                  AS \"VALUE_OLD\",\n            \"ImplicitInactiveBlock\".\"BlockedBy\"                  AS \"BlockedBy\",\n            \"ImplicitInactiveBlock\".\"BlockExecutionType\"         AS \"BlockExecutionType\",\n            \"ImplicitInactiveBlock\".\"BlockOperationType\"         AS \"BlockOperationType\",\n            \"ImplicitInactiveBlock\".\"SystemBlockNumber\"          AS \"SystemBlockNumber\",\n            \"ImplicitInactiveBlock\".\"SalesOrderID\"               AS \"SalesOrderID\",\n            \"ImplicitInactiveBlock\".\"DetailedReleaseReason\"      AS \"DetailedBlockReason\",\n            \"ImplicitInactiveBlock\".\"DetailedReleaseReasonText\"  AS \"DetailedBlockReasonText\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"ImplicitInactiveBlock\"\n        UNION\n        SELECT\n            \"CTE_BlockFromChangelog\".\"BlockID\"                   AS \"BlockID\",\n            \"CTE_BlockFromChangelog\".\"BlockTime\"                 AS \"BlockTime\",\n            \"CTE_BlockFromChangelog\".\"MANDANT\"                   AS \"MANDANT\",\n            \"CTE_BlockFromChangelog\".\"BlockType\"                 AS \"BlockType\",\n            \"CTE_BlockFromChangelog\".\"ValueType\"                 AS \"ValueType\",\n            \"CTE_BlockFromChangelog\".\"VALUE_NEW\"                 AS \"VALUE_NEW\",\n            \"CTE_BlockFromChangelog\".\"VALUE_OLD\"                 AS \"VALUE_OLD\",\n            \"CTE_BlockFromChangelog\".\"BlockedBy\"                 AS \"BlockedBy\",\n            \"CTE_BlockFromChangelog\".\"BlockExecutionType\"        AS \"BlockExecutionType\",\n            \"CTE_BlockFromChangelog\".\"BlockOperationType\"        AS \"BlockOperationType\",\n            \"CTE_BlockFromChangelog\".\"SystemBlockNumber\"         AS \"SystemBlockNumber\",\n            \"CTE_BlockFromChangelog\".\"SalesOrderID\"              AS \"SalesOrderID\",\n            \"CTE_BlockFromChangelog\".\"DetailedBlockReason\"       AS \"DetailedBlockReason\",\n            \"CTE_BlockFromChangelog\".\"DetailedBlockReasonText\"   AS \"DetailedBlockReasonText\"\n        FROM \"CTE_BlockFromChangelog\"\n    ),\n    \"CTE_Block\" AS (\n        SELECT\n            *,\n            ROW_NUMBER()\n            OVER (PARTITION BY \"CTE_BlockNoRN\".\"BlockID\", \"CTE_BlockNoRN\".\"BlockType\" ORDER BY \"CTE_BlockNoRN\".\"BlockTime\" ASC) AS \"BlockRN\"\n        FROM \"CTE_BlockNoRN\"\n    )\n/* Actual attribute mapping for object */\nSELECT\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockID\" || '::' || \"Block\".\"SystemBlockNumber\" || '::'\n        || \"Block\".\"BlockType\"                                      AS \"ID\",\n    \"Block\".\"BlockTime\"                                             AS \"CreationTime\",\n    COALESCE(\"Block\".\"BlockType\", \"Releases\".\"ReleaseType\")         AS \"BlockType\",\n    COALESCE(\"FirstAction\".\"DetailedBlockReason\", 'Data cut - no entry in CDPOS')\n                                                                    AS \"FirstBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN NULL\n        ELSE COALESCE(\"DetailedReasons\".\"BlockReason\", 'Data cut - no entry in VBUK')\n    END                                                             AS \"LatestBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN NULL\n        ELSE COALESCE(\"DetailedReasons\".\"BlockReasonText\", 'Data cut - no entry in VBUK')\n    END                                                             AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockedBy\"                AS \"BlockedBy\",\n    \"Block\".\"BlockExecutionType\"                                    AS \"BlockExecutionType\",\n    CASE WHEN \"Block\".\"SystemBlockNumber\" = '-1' THEN 'X' END       AS \"BlockFromSalesOrder\",\n    \"Releases\".\"ReleaseTime\"                                        AS \"ReleaseTime\",\n    \"Releases\".\"ReleaseType\"                                        AS \"ReleaseType\",\n    COALESCE(\"Releases\".\"DetailedReleaseReason\",\n    \"Releases\".\"VALUE_OLD\")                                         AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"Releases\".\"ReleasedBy_ID\"         AS \"ReleasedBy\",\n    \"Releases\".\"ReleaseExecutionType\"                               AS \"ReleaseExecutionType\",\n    <%=sourceSystem%> || '::' || \"Block\".\"SalesOrderID\"             AS \"SalesOrder\",\n    <%=sourceSystem%> || '::' || \"Block\".\"MANDANT\"                  AS \"SourceSystemInstance\"\nFROM \"CTE_Block\" AS \"Block\"\nLEFT JOIN \"CTE_Releases\" AS \"Releases\"\n    ON \"Block\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n        AND \"Block\".\"BlockRN\" = \"Releases\".\"ReleaseRN\"\n        AND \"Block\".\"BlockType\" = \"Releases\".\"ReleaseType\"\nLEFT JOIN \"CTE_FirstAction\" AS \"FirstAction\"\n    ON \"Block\".\"BlockID\" = \"FirstAction\".\"BlockID\"\nLEFT JOIN \"VBAK\" AS \"VBAK\"\n    ON \"Block\".\"SalesOrderID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\nLEFT JOIN \"CTE_DetailedReasonsNoComma\" AS \"DetailedReasons\"\n    ON \"Block\".\"BlockID\" = \"DetailedReasons\".\"MANDT\" || '::' || \"DetailedReasons\".\"VBELN\"\n        AND NULLIF(\"DetailedReasons\".\"CMGST\", '') IS NOT NULL"
                    },
                    {
                        "id": "DeliveryBlock",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "/*\n1. CTE_Releases: All recorded Release Events (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NULL)\n2. CTE_Changes: All recorded changes of the BlockingField (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NOT NULL)\n3. CTE_BlockFromChangelog: All recorded Block sets (except the ones during creation) (OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL)\n4. CTE_ImplicitActiveBlocks: Block field is NOT NULL (-> we know there is a block) and no entries in BlocksFromChangeLog\n5. CTE_FirstAction: Aggregate Changelog per ObjectID. Keep the earliest entry.\n6. CTE_ImplicitInactiveBlocks: FirstAction for a specific ObjectID is either a Release or a Change -> Implicit Block\n7. CTE_Block: UNION of 3, 4 and 6 */\n/*\nRecreated Information: Joined relevant information from CDPOS (change doc Item) and CDHDR (change doc Header)\nto build a base table with all fields needed to build the CTE tables to capture all relevant changes to block statues.\n */\nWITH \"CTE_JoinTable\" AS (\n    SELECT\n        SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)                        AS \"JoinID\",\n        CAST(\"CDHDR\".\"UDATE\" AS DATE) +\n            COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"CDHDR\".\"UTIME\" AS DATE),\n            \"CDHDR\".\"UTIME\") AS INTERVAL SECOND),\n            INTERVAL '86399' SECOND)                                            AS \"JoinTime\",\n        \"CDHDR\".\"MANDANT\"                                                       AS \"MANDANT\",\n        \"CDHDR\".\"UDATE\"                                                         AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                                         AS \"UTIME\",\n        \"CDPOS\".\"FNAME\"                                                         AS \"FNAME\",\n        \"CDPOS\".\"TABNAME\"                                                       AS \"TABNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                                     AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                                     AS \"VALUE_OLD\",\n        \"CDHDR\".\"MANDANT\" || '::' || \"CDHDR\".\"USERNAME\"                         AS \"JoinUserID\",\n        CASE\n            WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                THEN 'Automatic'\n            ELSE 'Manual'\n        END                                                                     AS \"JoinExecutionType\",\n        \"CDHDR\".\"TCODE\"                                                         AS \"JoinOperationType\",\n        \"CDHDR\".\"CHANGENR\"                                                      AS \"JoinSystemNumber\",\n        \"CDPOS\".\"OBJECTCLAS\"                                                    AS \"OBJECTCLAS\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK')\n            AND \"CDPOS\".\"FNAME\" IN ('LIFSK')\n            AND \"CDPOS\".\"OBJECTCLAS\" = 'VERKBELEG'\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n/* Recreated Information : Capture release of blocks (Delivery block from VBAK), Condition on scenarios where VALUE_OLD IS NOT NULL ,\nand VALUE_NEW IS NULL */\n    \"CTE_Releases\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"ReleasesID\",\n            \"JoinTable\".\"JoinTime\"                                                                                                  AS \"ReleaseTime\",\n            \"JoinTable\".\"MANDANT\"                                                                                                   AS \"MANDANT\",\n            'DeliveryBlock'                                                                                                         AS \"ReleaseType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                                                                                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                                                                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                                                                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                                                                                AS \"ReleasedBy_ID\",\n            \"JoinTable\".\"JoinExecutionType\"                                                                                         AS \"ReleaseExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                                                                                         AS \"ReleaseOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                                                                                          AS \"SystemReleaseNumber\",\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"SalesOrderID\",\n            ROW_NUMBER()\n            OVER (PARTITION BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\" ORDER BY \"JoinTable\".\"UDATE\" ASC, \"JoinTable\".\"UTIME\" ASC) AS \"ReleaseRN\" /* assigns a sequential number (\"ReleaseRN\") to each record, \n            ordered chronologically by date and time, but restarts the numbering for every unique combination of \"JoinID\" and \"FNAME\" */\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"TABNAME\" = 'VBAK'\n            AND \"JoinTable\".\"FNAME\" IN ('LIFSK')\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NULL\n    ),\n/* Recreated Information : Captures all changes occurring to delivery blocks (Excluding setting of block at creation or at a later stage , and release of block).\nMust meet condition of scenario: VALUE_OLD AND VALUE_NEW IS NOT NULL  */\n    \"CTE_Changes\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"ID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"ChangeTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'DeliveryBlock'                        AS \"ChangeType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"ChangeBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"ChangeExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"ChangeOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"ChangeID\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: All recorded Delivery Block sets (except the ones during creation)\nMust meet condition of scenario: OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL */\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'DeliveryBlock'                        AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"BlockedBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"BlockExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"BlockOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: Based on VBAK , captures sales orders which currently have a delivery block, uses the prior CTE tables to ensure that this sales order\nhas no change entries. Queries each block type seperately, and unions all together.\nMust meet condition of scenario: Block field is NOT NULL (actively blocked) and no entries in BlocksFromChangeLog */\n    \"CTE_ImplicitActiveBlock\" AS (\n        SELECT\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                      AS \"BlockID\",\n            CAST(\"VBAK\".\"ERDAT\" AS DATE) +\n                CAST(TIMESTAMPDIFF(SECOND, CAST(\"VBAK\".\"ERZET\" AS DATE),\n                \"VBAK\".\"ERZET\")\n                AS INTERVAL SECOND)                                                      AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                               AS \"MANDANT\",\n            'DeliveryBlock'                                                              AS \"BlockType\",\n            'Block to ' || \"VBAK\".\"LIFSK\"                                                AS \"ValueType\",\n            \"VBAK\".\"LIFSK\"                                                               AS \"VALUE_NEW\",\n            NULL                                                                         AS \"VALUE_OLD\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"                                     AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                          AS \"BlockExecutionType\",\n            NULL                                                                         AS \"BlockOperationType\",\n            '-1'                                                                         AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"SalesOrderID\"\n        FROM \"VBAK\" AS \"VBAK\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"Block\"\n            ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"Releases\".\"ReleasesID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"Changes\".\"ID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"Block\".\"BlockID\", '') IS NULL\n            AND NULLIF(\"Changes\".\"ID\", '') IS NULL\n            AND NULLIF(\"Releases\".\"ReleasesID\", '') IS NULL\n            AND NULLIF(\"VBAK\".\"LIFSK\", '') IS NOT NULL\n    ),\n/* Recreated Information: Indicating the earliest timestamp when a delivery block was set for a given record (CDPOS.TABKEY) , split per ObjectID.  */\n    \"CTE_FirstAction\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"        AS \"BlockID\",\n            MIN(\"JoinTable\".\"JoinTime\") AS \"BlockTime\",\n            'DeliveryBlock'             AS \"BlockType\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        GROUP BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    ),\n/* Recreated Information: identifies delivery blocks active from a sales order's creation.\nIt links the earliest block times (from CTE_FirstAction) with sales order details and\nchecks for matching initial change or release records to define these \"implicit\" block activations.\n\nThe CTE assumes that if a block type identified in CTE_FirstAction exists for a sales order,\nand there isn't a specific change or release event recorded at the BlockTime from CTE_FirstAction,\nthen the block was implicitly active from the moment the sales order was created. */\n    \"CTE_ImplicitInactiveBlock\" AS (\n        SELECT\n            \"FirstAction\".\"BlockID\"                                                        AS \"BlockID\",\n            CAST(\"VBAK\".\"ERDAT\" AS DATE) +\n                CAST(TIMESTAMPDIFF(SECOND, CAST(\"VBAK\".\"ERZET\" AS DATE),\n                \"VBAK\".\"ERZET\") AS INTERVAL SECOND)                                        AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                                 AS \"MANDANT\",\n            \"FirstAction\".\"BlockType\"                                                      AS \"BlockType\",\n            'Block to '\n                ||\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"ValueType\", -- Checks for a change event first, if non-existant checks for release event\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"VALUE_NEW\",\n            NULL                                                                           AS \"VALUE_OLD\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"                                       AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                            AS \"BlockExecutionType\",\n            NULL                                                                           AS \"BlockOperationType\",\n            '-1'                                                                           AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                       AS \"SalesOrderID\"\n        FROM \"CTE_FirstAction\" AS \"FirstAction\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"FirstAction\".\"BlockID\" = \"Changes\".\"ID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Changes\".\"ChangeTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Changes\".\"ChangeType\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"FirstAction\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Releases\".\"ReleaseTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Releases\".\"ReleaseType\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"FirstAction\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND (NULLIF(\"Changes\".\"ID\", '') IS NOT NULL\n            OR NULLIF(\"Releases\".\"ReleasesID\", '') IS NOT NULL)\n    ),\n/* Recreated Information: CTE_ImplicitDuplicates identifies block events that appear in both CTE_ImplicitInactiveBlock\nand CTE_ImplicitActiveBlock (based on BlockID, BlockTime, and BlockType), effectively finding duplicate records of the same block event.\n*/\n    \"CTE_ImplicitDuplicates\" AS (\n        SELECT\n            \"Inactive\".\"BlockID\",\n            \"Inactive\".\"BlockTime\",\n            \"Inactive\".\"BlockType\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"Inactive\"\n        LEFT JOIN \"CTE_ImplicitActiveBlock\" AS \"Active\"\n            ON \"Inactive\".\"BlockID\" = \"Active\".\"BlockID\"\n                AND \"Inactive\".\"BlockTime\" = \"Active\".\"BlockTime\"\n                AND \"Inactive\".\"BlockType\" = \"Active\".\"BlockType\"\n        WHERE NULLIF(\"Active\".\"BlockID\", '') IS NOT NULL\n    ),\n/* Recreated Information: CTE_ImplicitActiveBlockNoDuplicates selects active implicit block records\nfrom CTE_ImplicitActiveBlock, excluding any records that are also found in CTE_ImplicitDuplicates.\nThis results in a set of unique active implicit block events.\n\nThis CTE removes duplicates between the ImplicitBlock CTEs from ActiveBlocks.\n*/\n    \"CTE_ImplicitActiveBlockNoDuplicates\" AS (\n        SELECT\n            \"Active\".*\n        FROM \"CTE_ImplicitActiveBlock\" AS \"Active\"\n        LEFT JOIN \"CTE_ImplicitDuplicates\" AS \"Duplicates\"\n            ON \"Active\".\"BlockID\" = \"Duplicates\".\"BlockID\"\n                AND \"Active\".\"BlockTime\" = \"Duplicates\".\"BlockTime\"\n                AND \"Active\".\"BlockType\" = \"Duplicates\".\"BlockType\"\n        WHERE NULLIF(\"Duplicates\".\"BlockID\", '') IS NULL\n    ),\n/* Recreated Information: Combines all entries with sales orders which are currently blocked , sales orders implicitly blocked\n(blocked since moment of creation), and the log of all recorded Block sets (except the ones during creation)   */\n    \"CTE_BlockNoRN\" AS (\n        SELECT\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitActiveBlockNoDuplicates\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitActiveBlockNoDuplicates\" AS \"ImplicitActiveBlockNoDuplicates\"\n        UNION\n        SELECT\n            \"ImplicitInactiveBlock\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitInactiveBlock\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitInactiveBlock\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitInactiveBlock\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitInactiveBlock\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitInactiveBlock\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitInactiveBlock\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitInactiveBlock\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitInactiveBlock\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitInactiveBlock\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitInactiveBlock\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitInactiveBlock\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"ImplicitInactiveBlock\"\n        UNION\n        SELECT\n            \"CTE_BlockFromChangelog\".\"BlockID\"            AS \"BlockID\",\n            \"CTE_BlockFromChangelog\".\"BlockTime\"          AS \"BlockTime\",\n            \"CTE_BlockFromChangelog\".\"MANDANT\"            AS \"MANDANT\",\n            \"CTE_BlockFromChangelog\".\"BlockType\"          AS \"BlockType\",\n            \"CTE_BlockFromChangelog\".\"ValueType\"          AS \"ValueType\",\n            \"CTE_BlockFromChangelog\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"CTE_BlockFromChangelog\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"CTE_BlockFromChangelog\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"CTE_BlockFromChangelog\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"CTE_BlockFromChangelog\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"CTE_BlockFromChangelog\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"CTE_BlockFromChangelog\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_BlockFromChangelog\"\n    ),\n    \"CTE_Block\" AS (\n        SELECT\n            *,\n            ROW_NUMBER()\n            OVER (PARTITION BY \"CTE_BlockNoRN\".\"BlockID\", \"CTE_BlockNoRN\".\"BlockType\" ORDER BY \"CTE_BlockNoRN\".\"BlockTime\" ASC) AS \"BlockRN\"\n        FROM \"CTE_BlockNoRN\"\n    )\n/* Actual attribute mapping for object */\nSELECT\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockID\" || '::' || \"Block\".\"SystemBlockNumber\" || '::'\n        || \"Block\".\"BlockType\"                                   AS \"ID\",\n    \"Block\".\"BlockTime\"                                          AS \"CreationTime\",\n    COALESCE(\"Block\".\"BlockType\", \"Releases\".\"ReleaseType\")      AS \"BlockType\",\n    \"Block\".\"VALUE_NEW\"                                          AS \"FirstBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'DeliveryBlock'\n            THEN COALESCE(\"VBAK\".\"LIFSK\", 'Data cut - no entry in VBAK')\n    END                                                          AS \"LatestBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'DeliveryBlock'\n            THEN \"TVLST\".\"VTEXT\"\n    END                                                          AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockedBy\"             AS \"BlockedBy\",\n    \"Block\".\"BlockExecutionType\"                                 AS \"BlockExecutionType\",\n    CASE WHEN \"Block\".\"SystemBlockNumber\" = '-1' THEN 'X' END    AS \"BlockFromSalesOrder\",\n    \"Releases\".\"ReleaseTime\"                                     AS \"ReleaseTime\",\n    \"Releases\".\"ReleaseType\"                                     AS \"ReleaseType\",\n    \"Releases\".\"VALUE_OLD\"                                       AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"Releases\".\"ReleasedBy_ID\"      AS \"ReleasedBy\",\n    \"Releases\".\"ReleaseExecutionType\"                            AS \"ReleaseExecutionType\",\n    <%=sourceSystem%> || '::' || \"Block\".\"SalesOrderID\"          AS \"SalesOrder\",\n    <%=sourceSystem%> || '::' || \"Block\".\"MANDANT\"               AS \"SourceSystemInstance\"\nFROM \"CTE_Block\" AS \"Block\"\nLEFT JOIN \"CTE_Releases\" AS \"Releases\"\n    ON \"Block\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n        AND \"Block\".\"BlockRN\" = \"Releases\".\"ReleaseRN\"\n        AND \"Block\".\"BlockType\" = \"Releases\".\"ReleaseType\"\nLEFT JOIN \"VBAK\" AS \"VBAK\"\n    ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        AND (NULLIF(\"VBAK\".\"LIFSK\", '') IS NOT NULL)\nLEFT JOIN \"TVLST\" AS \"TVLST\"\n    ON \"VBAK\".\"MANDT\" = \"TVLST\".\"MANDT\"\n        AND \"VBAK\".\"LIFSK\" = \"TVLST\".\"LIFSP\"\n        AND \"TVLST\".\"SPRAS\" = <%=LanguageKey%>"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    },
    {
        "change_date": 1762782470542.0,
        "changed_by": {
            "id": "bdec2b77-569a-4c86-86a1-73c0f6bbb6c4",
            "name": "Andi",
            "type_": "USER"
        },
        "created_by": {
            "id": "545b42ca-1ca9-4aca-86de-105246b55399",
            "name": "Alvaro Gomez",
            "type_": "USER"
        },
        "creation_date": 1751375448812.0,
        "data_connection_id": "8939ad05-4472-435c-a065-ed31be1b9fea",
        "description": null,
        "disabled": null,
        "display_name": "SalesOrderBlock - S4HANA",
        "draft": null,
        "factory_id": "15a29478-3b38-4f4d-9d58-ad58c41966b9",
        "factory_validation_status": "VALID",
        "has_user_template": null,
        "local_parameters": [
            {
                "name": "LanguageKey",
                "value": "'E'"
            },
            {
                "name": "sourceSystem",
                "value": "'SAP_S4_HANA'"
            }
        ],
        "namespace": "custom",
        "target": {
            "entity_ref": {
                "name": "SalesOrderBlock",
                "namespace": "custom"
            },
            "kind": "OBJECT"
        },
        "transformations": [
            {
                "change_sql_factory_datasets": [
                    {
                        "id": "CDPOS",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "WITH \"CTE_JoinTable\" AS (\n    SELECT\n        SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)       AS \"JoinID\",\n        \"CDPOS\".\"MANDANT\"                                      AS \"MANDANT\",\n        \"CDPOS\".\"OBJECTCLAS\"                                   AS \"OBJECTCLAS\",\n        \"CDPOS\".\"OBJECTID\"                                     AS \"OBJECTID\",\n        \"CDPOS\".\"FNAME\"                                        AS \"FNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                    AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                    AS \"VALUE_OLD\",\n        \"CDPOS\".\"TABNAME\"                                      AS \"TABNAME\",\n        \"CDHDR\".\"UDATE\"                                        AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                        AS \"UTIME\",\n        \"CDPOS\".\"CHNGIND\"                                      AS \"CHNGIND\",\n        \"CDHDR\".\"USERNAME\"                                     AS \"USERNAME\",\n        \"CDHDR\".\"TCODE\"                                        AS \"TCODE\",\n        \"CDHDR\".\"CHANGENR\"                                     AS \"CHANGENR\",\n        \"USR02\".\"USTYP\"                                        AS \"USTYP\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = 'VERKBELEG'\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK')\n            AND \"CDPOS\".\"FNAME\" IN ('FAKSK', 'LIFSK', 'CMGST')\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                          AS \"BlockID\",\n            CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                INTERVAL '86399' SECOND)                                  AS \"BlockTime\",\n            CASE\n                WHEN \"JoinTable\".\"FNAME\" = 'FAKSK'\n                    THEN 'BillingBlock'\n                WHEN \"JoinTable\".\"FNAME\" = 'LIFSK'\n                    THEN 'DeliveryBlock'\n            END                                                           AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                        AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                       AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                       AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"JoinTable\".\"MANDANT\" \n                || '::' || \"JoinTable\".\"USERNAME\"                         AS \"BlockedBy\",\n            CASE\n                WHEN \"JoinTable\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                           AS \"BlockExecutionType\",\n            \"JoinTable\".\"TCODE\"                                           AS \"BlockOperationType\",\n            \"JoinTable\".\"CHANGENR\"                                        AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                                          AS \"SalesOrderID\",\n            \"JoinTable\".\"MANDANT\"                                         AS \"MANDANT\",\n            \"JoinTable\".\"OBJECTCLAS\"                                      AS \"OBJECTCLAS\",\n            \"JoinTable\".\"OBJECTID\"                                        AS \"OBJECTID\",\n            \"JoinTable\".\"FNAME\"                                           AS \"FNAME\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"CHNGIND\" = 'U'\n            AND \"JoinTable\".\"TABNAME\" = 'VBAK'\n            AND \"JoinTable\".\"FNAME\" IN ('FAKSK', 'LIFSK')\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n        UNION ALL\n        SELECT\n            \"JoinTable\".\"JoinID\"                                          AS \"BlockID\",\n            CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                INTERVAL '86399' SECOND)                                  AS \"BlockTime\",\n            'CreditBlock'                                                 AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                        AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                       AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                       AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"JoinTable\".\"MANDANT\" \n                || '::' || \"JoinTable\".\"USERNAME\"                         AS \"BlockedBy\",\n            CASE\n                WHEN \"JoinTable\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                           AS \"BlockExecutionType\",\n            \"JoinTable\".\"TCODE\"                                           AS \"BlockOperationType\",\n            \"JoinTable\".\"CHANGENR\"                                        AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                                          AS \"SalesOrderID\",\n            \"JoinTable\".\"MANDANT\"                                         AS \"MANDANT\",\n            \"JoinTable\".\"OBJECTCLAS\"                                      AS \"OBJECTCLAS\",\n            \"JoinTable\".\"OBJECTID\"                                        AS \"OBJECTID\",\n            \"JoinTable\".\"FNAME\"                                           AS \"FNAME\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"CHNGIND\" = 'U'\n            AND \"JoinTable\".\"TABNAME\" = 'VBAK'\n            AND \"JoinTable\".\"FNAME\" = 'CMGST'\n            AND (NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL OR \"JoinTable\".\"VALUE_OLD\" IN ('A', 'D'))\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n            AND \"JoinTable\".\"VALUE_NEW\" NOT IN ('A', 'D')\n    ),\n    \"CTE_MinBlock\" AS (\n        SELECT\n            \"JoinTable\".\"CHANGENR\"                                          AS \"CHANGENR\",\n            \"JoinTable\".\"JoinID\"                                            AS \"JoinID\",\n            \"JoinTable\".\"FNAME\"                                             AS \"FNAME\",\n            MIN(TIMESTAMPDIFF(SECOND, \"BlockFromChangelog\".\"BlockTime\",\n                CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                    COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                    \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                    INTERVAL '86399' SECOND)))                               AS \"LatestBlockSelector\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"BlockFromChangelog\"\n            ON \"JoinTable\".\"MANDANT\" = \"BlockFromChangelog\".\"MANDANT\"\n                AND \"JoinTable\".\"OBJECTCLAS\" = \"BlockFromChangelog\".\"OBJECTCLAS\"\n                AND \"JoinTable\".\"OBJECTID\" = \"BlockFromChangelog\".\"OBJECTID\"\n                AND \"JoinTable\".\"JoinID\" = \"BlockFromChangelog\".\"BlockID\"\n                AND CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                    COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                    \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                    INTERVAL '86399' SECOND)\n                    >= \"BlockFromChangelog\".\"BlockTime\"\n                AND \"JoinTable\".\"FNAME\" = \"BlockFromChangelog\".\"FNAME\"\n        GROUP BY \"JoinTable\".\"CHANGENR\", \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    )\nSELECT\n    <%=sourceSystem%>\n        || '::' || \"JoinTable\".\"JoinID\"\n        || '::' || COALESCE(\"BlockFromChangelog\".\"SystemBlockNumber\", '-1')\n        || '::'\n        || CASE\n            WHEN \"JoinTable\".\"FNAME\" = 'FAKSK'\n                THEN 'BillingBlock'\n            WHEN \"JoinTable\".\"FNAME\" = 'LIFSK'\n                THEN 'DeliveryBlock'\n            WHEN \"JoinTable\".\"FNAME\" = 'CMGST'\n                THEN 'CreditBlock'\n            END                                                              AS \"ObjectID\",\n    <%=sourceSystem%> || '::' || \"JoinTable\".\"JoinID\" || '::' || \"JoinTable\".\"TABNAME\" || '::' || \"JoinTable\".\"FNAME\"\n        || '::' || \"JoinTable\".\"CHANGENR\" || '::' || \"JoinTable\".\"CHNGIND\"    AS \"ID\",\n    CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n        CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n        \"JoinTable\".\"UTIME\") AS INTERVAL SECOND)                             AS \"Time\",\n    'LatestBlockReason'                                                      AS \"Attribute\",\n    \"JoinTable\".\"VALUE_OLD\"                                                  AS \"OldValue\",\n    \"JoinTable\".\"VALUE_NEW\"                                                  AS \"NewValue\",\n    <%=sourceSystem%> || '::' || \"JoinTable\".\"MANDANT\" || '::' || \"JoinTable\".\"USERNAME\" AS \"ChangedBy\",\n    \"JoinTable\".\"TCODE\"                                                      AS \"OperationType\",\n    \"JoinTable\".\"CHANGENR\"                                                   AS \"OperationID\",\n    CASE\n        WHEN \"JoinTable\".\"USTYP\" IN ('B', 'C')\n            THEN 'Automatic'\n        ELSE 'Manual'\n        END                                                                  AS \"ExecutionType\"\nFROM \"CTE_JoinTable\" AS \"JoinTable\"\nLEFT JOIN \"CTE_MinBlock\" AS \"MinBlock\"\n    ON \"JoinTable\".\"CHANGENR\" = \"MinBlock\".\"CHANGENR\"\n        AND \"JoinTable\".\"JoinID\" = \"MinBlock\".\"JoinID\"\n        AND \"JoinTable\".\"FNAME\" = \"MinBlock\".\"FNAME\"\nLEFT JOIN \"CTE_BlockFromChangelog\" AS \"BlockFromChangelog\"\n    ON \"JoinTable\".\"MANDANT\" = \"BlockFromChangelog\".\"MANDANT\"\n        AND \"JoinTable\".\"OBJECTCLAS\" = \"BlockFromChangelog\".\"OBJECTCLAS\"\n        AND \"JoinTable\".\"OBJECTID\" = \"BlockFromChangelog\".\"OBJECTID\"\n        AND \"JoinTable\".\"JoinID\" = \"BlockFromChangelog\".\"BlockID\"\n        AND CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n            COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n            \"JoinTable\".\"UTIME\") AS INTERVAL SECOND), INTERVAL '86399' SECOND)\n            >= \"BlockFromChangelog\".\"BlockTime\"\n        AND \"JoinTable\".\"FNAME\" = \"BlockFromChangelog\".\"FNAME\"\n        AND TIMESTAMPDIFF(SECOND, \"BlockFromChangelog\".\"BlockTime\",\n            CAST(\"JoinTable\".\"UDATE\" AS DATE) +\n                COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"JoinTable\".\"UTIME\" AS DATE),\n                \"JoinTable\".\"UTIME\") AS INTERVAL SECOND),\n                INTERVAL '86399' SECOND))\n            = \"MinBlock\".\"LatestBlockSelector\"\nWHERE \"JoinTable\".\"CHNGIND\" = 'U'\n    AND \"JoinTable\".\"TABNAME\" = 'VBAK'\n    AND (\n        \"JoinTable\".\"FNAME\" IN ('FAKSK', 'LIFSK')\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    OR\n        \"JoinTable\".\"FNAME\" = 'CMGST'\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL AND \"JoinTable\".\"VALUE_OLD\" NOT IN ('A', 'D')\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL AND \"JoinTable\".\"VALUE_NEW\" NOT IN ('A', 'D')\n    )"
                    }
                ],
                "foreign_key_names": [
                    "BlockedBy",
                    "ReleasedBy",
                    "SalesOrder"
                ],
                "namespace": "custom",
                "property_names": [
                    "BlockExecutionType",
                    "BlockFromSalesOrder",
                    "BlockType",
                    "CreationTime",
                    "FirstBlockReason",
                    "ID",
                    "LatestBlockReason",
                    "LatestBlockReasonText",
                    "ReleaseExecutionType",
                    "ReleaseReason",
                    "ReleaseTime",
                    "ReleaseType",
                    "SourceSystemInstance"
                ],
                "property_sql_factory_datasets": [
                    {
                        "id": "BillingBlock",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "/* \n1. CTE_Releases: All recorded Release Events (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NULL)\n2. CTE_Changes: All recorded changes of the BlockingField (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NOT NULL)\n3. CTE_BlockFromChangelog: All recorded Block sets (except the ones during creation) (OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL)\n4. CTE_ImplicitActiveBlocks: Block field is NOT NULL (-> we know there is a block) and no entries in BlocksFromChangeLog\n5. CTE_FirstAction: Aggregate Changelog per ObjectID. Keep the earliest entry.\n6. CTE_ImplicitInactiveBlocks: FirstAction for a specific ObjectID is either a Release or a Change -> Implicit Block\n7. CTE_Block: UNION of 3, 4 and 6 */\n/*\nRecreated Information: Joined relevant information from CDPOS (change doc Item) and CDHDR (change doc Header)\nto build a base table with all fields needed to build the CTE tables to capture all relevant changes to block statues.\n */\nWITH \"CTE_JoinTable\" AS (\n    SELECT\n        SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)                               AS \"JoinID\",\n        CAST(\"CDHDR\".\"UDATE\" AS DATE) +\n            COALESCE(CAST(TIMESTAMPDIFF(SECOND, CAST(\"CDHDR\".\"UTIME\" AS DATE),\n            \"CDHDR\".\"UTIME\") AS INTERVAL SECOND),\n            INTERVAL '86399' SECOND)                                                    AS \"JoinTime\",\n        \"CDHDR\".\"MANDANT\"                                                               AS \"MANDANT\",\n        \"CDHDR\".\"UDATE\"                                                                 AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                                                 AS \"UTIME\",\n        \"CDPOS\".\"FNAME\"                                                                 AS \"FNAME\",\n        \"CDPOS\".\"TABNAME\"                                                               AS \"TABNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                                             AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                                             AS \"VALUE_OLD\",\n        \"CDHDR\".\"MANDANT\" || '::' || \"CDHDR\".\"USERNAME\"                                 AS \"JoinUserID\",\n        CASE\n            WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                THEN 'Automatic'\n            ELSE 'Manual'\n        END                                                                             AS \"JoinExecutionType\",\n        \"CDHDR\".\"TCODE\"                                                                 AS \"JoinOperationType\",\n        \"CDHDR\".\"CHANGENR\"                                                              AS \"JoinSystemNumber\",\n        \"CDPOS\".\"OBJECTCLAS\"                                                            AS \"OBJECTCLAS\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK')\n            AND \"CDPOS\".\"FNAME\" IN ('FAKSK')\n            AND \"CDPOS\".\"OBJECTCLAS\" = 'VERKBELEG'\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n/* Recreated Information : Capture release of blocks (Billing block from VBAK, Condition on scenarios where VALUE_OLD IS NOT NULL,\nand VALUE_NEW IS NULL  */\n    \"CTE_Releases\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"ReleasesID\",\n            \"JoinTable\".\"JoinTime\"                                                                                                  AS \"ReleaseTime\",\n            \"JoinTable\".\"MANDANT\"                                                                                                   AS \"MANDANT\",\n            'BillingBlock'                                                                                                          AS \"ReleaseType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                                                                                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                                                                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                                                                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                                                                                AS \"ReleasedBy_ID\",\n            \"JoinTable\".\"JoinExecutionType\"                                                                                         AS \"ReleaseExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                                                                                         AS \"ReleaseOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                                                                                          AS \"SystemReleaseNumber\",\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"SalesOrderID\",\n            ROW_NUMBER()\n            OVER (PARTITION BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\" ORDER BY \"JoinTable\".\"UDATE\" ASC, \"JoinTable\".\"UTIME\" ASC) AS \"ReleaseRN\" /* assigns a sequential number (\"ReleaseRN\") to each record, ordered chronologically by date and time, \n            but restarts the numbering for every unique combination of \"JoinID\" and \"FNAME\" */\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NULL\n    ),\n/* Recreated Information : Captures all changes occurring to blocks (Excluding setting of block at creation or at a later stage , and release of block).\nMust meet condition of scenario: VALUE_OLD AND VALUE_NEW IS NOT NULL  */\n    \"CTE_Changes\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"ID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"ChangeTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'BillingBlock'                         AS \"ChangeType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"ChangeBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"ChangeExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"ChangeOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"ChangeID\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: All recorded Block sets (except the ones during creation)\nMust meet condition of scenario: OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL */\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'BillingBlock'                         AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"BlockedBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"BlockExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"BlockOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: Based on VBAK , captures sales orders which are currently blocked, uses the prior CTE tables to ensure that this sales order\nhas no change entries. Queries each block type seperately, and unions all together.\nMust meet condition of scenario: Block field is NOT NULL (actively blocked) and no entries in BlocksFromChangeLog */\n    \"CTE_ImplicitActiveBlock\" AS (\n        SELECT\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"BlockID\",\n            CAST(CONCAT(CAST(\"VBAK\".\"ERDAT\" AS VARCHAR), SUBSTRING(\n                CAST(\"VBAK\".\"ERZET\" AS VARCHAR), 11, 19)) AS TIMESTAMP)                  AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                               AS \"MANDANT\",\n            'BillingBlock'                                                               AS \"BlockType\",\n            'Block to ' || \"VBAK\".\"FAKSK\"                                                AS \"ValueType\",\n            \"VBAK\".\"FAKSK\"                                                               AS \"VALUE_NEW\",\n            NULL                                                                         AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"        AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                          AS \"BlockExecutionType\",\n            NULL                                                                         AS \"BlockOperationType\",\n            '-1'                                                                         AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"SalesOrderID\"\n        FROM \"VBAK\" AS \"VBAK\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"Block\"\n            ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"Releases\".\"ReleasesID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"Changes\".\"ID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"Block\".\"BlockID\", '') IS NULL\n            AND NULLIF(\"Changes\".\"ID\", '') IS NULL\n            AND NULLIF(\"Releases\".\"ReleasesID\", '') IS NULL\n            AND NULLIF(\"VBAK\".\"FAKSK\", '') IS NOT NULL\n    ),\n/* Recreated Information: Indicating the earliest timestamp when a billing block\nwas set for a given record (CDPOS.TABKEY) , split per ObjectID.  */\n    \"CTE_FirstAction\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"        AS \"BlockID\",\n            MIN(\"JoinTable\".\"JoinTime\") AS \"BlockTime\",\n            'BillingBlock'              AS \"BlockType\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        GROUP BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    ),\n/* Recreated Information: identifies an active billing block from a sales order's creation.\nIt links the earliest block times (from CTE_FirstAction) with sales order details and\nchecks for matching initial change or release records to define these \"implicit\" block activations.\n\nThe CTE assumes that if a block type identified in CTE_FirstAction exists for a sales order,\nand there isn't a specific change or release event recorded at the BlockTime from CTE_FirstAction,\nthen the block was implicitly active from the moment the sales order was created. */\n    \"CTE_ImplicitInactiveBlock\" AS (\n        SELECT\n            \"FirstAction\".\"BlockID\"                                                        AS \"BlockID\",\n            CAST(CONCAT(CAST(\"VBAK\".\"ERDAT\" AS VARCHAR), SUBSTRING(\n              CAST(\"VBAK\".\"ERZET\" AS VARCHAR), 11, 19)) AS TIMESTAMP)                      AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                                 AS \"MANDANT\",\n            \"FirstAction\".\"BlockType\"                                                      AS \"BlockType\",\n            'Block to '\n                ||\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"ValueType\", -- Checks for a change event first, if non-existant checks for release event\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"VALUE_NEW\",\n            NULL                                                                           AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"          AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                            AS \"BlockExecutionType\",\n            NULL                                                                           AS \"BlockOperationType\",\n            '-1'                                                                           AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                       AS \"SalesOrderID\"\n        FROM \"CTE_FirstAction\" AS \"FirstAction\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"FirstAction\".\"BlockID\" = \"Changes\".\"ID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Changes\".\"ChangeTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Changes\".\"ChangeType\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"FirstAction\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Releases\".\"ReleaseTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Releases\".\"ReleaseType\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"FirstAction\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND (NULLIF(\"Changes\".\"ID\", '') IS NOT NULL\n            OR NULLIF(\"Releases\".\"ReleasesID\", '') IS NOT NULL)\n    ),\n/* Recreated Information: CTE_ImplicitDuplicates identifies block events that appear in both CTE_ImplicitInactiveBlock\nand CTE_ImplicitActiveBlock (based on BlockID, BlockTime, and BlockType), effectively finding duplicate records of the same block event.\n*/\n    \"CTE_ImplicitDuplicates\" AS (\n        SELECT\n            \"Inactive\".\"BlockID\",\n            \"Inactive\".\"BlockTime\",\n            \"Inactive\".\"BlockType\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"Inactive\"\n        LEFT JOIN \"CTE_ImplicitActiveBlock\" AS \"Active\"\n            ON \"Inactive\".\"BlockID\" = \"Active\".\"BlockID\"\n                AND \"Inactive\".\"BlockTime\" = \"Active\".\"BlockTime\"\n                AND \"Inactive\".\"BlockType\" = \"Active\".\"BlockType\"\n        WHERE NULLIF(\"Active\".\"BlockID\", '') IS NOT NULL\n    ),\n/* Recreated Information: CTE_ImplicitActiveBlockNoDuplicates selects active implicit block records\nfrom CTE_ImplicitActiveBlock, excluding any records that are also found in CTE_ImplicitDuplicates.\nThis results in a set of unique active implicit block events.\n\nThis CTE removes duplicates between the ImplicitBlock CTEs from ActiveBlocks.\n*/\n    \"CTE_ImplicitActiveBlockNoDuplicates\" AS (\n        SELECT\n            \"Active\".*\n        FROM \"CTE_ImplicitActiveBlock\" AS \"Active\"\n        LEFT JOIN \"CTE_ImplicitDuplicates\" AS \"Duplicates\"\n            ON \"Active\".\"BlockID\" = \"Duplicates\".\"BlockID\"\n                AND \"Active\".\"BlockTime\" = \"Duplicates\".\"BlockTime\"\n                AND \"Active\".\"BlockType\" = \"Duplicates\".\"BlockType\"\n        WHERE NULLIF(\"Duplicates\".\"BlockID\", '') IS NULL\n    ),\n/* Recreated Information: Combines all entries with sales orders which currently have a billing block , sales orders implicitly blocked\n(blocked since moment of creation), and the log of all recorded Block sets (except the ones during creation)   */\n    \"CTE_BlockNoRN\" AS (\n        SELECT\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitActiveBlockNoDuplicates\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitActiveBlockNoDuplicates\" AS \"ImplicitActiveBlockNoDuplicates\"\n        UNION\n        SELECT\n            \"ImplicitInactiveBlock\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitInactiveBlock\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitInactiveBlock\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitInactiveBlock\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitInactiveBlock\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitInactiveBlock\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitInactiveBlock\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitInactiveBlock\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitInactiveBlock\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitInactiveBlock\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitInactiveBlock\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitInactiveBlock\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"ImplicitInactiveBlock\"\n        UNION\n        SELECT\n            \"CTE_BlockFromChangelog\".\"BlockID\"            AS \"BlockID\",\n            \"CTE_BlockFromChangelog\".\"BlockTime\"          AS \"BlockTime\",\n            \"CTE_BlockFromChangelog\".\"MANDANT\"            AS \"MANDANT\",\n            \"CTE_BlockFromChangelog\".\"BlockType\"          AS \"BlockType\",\n            \"CTE_BlockFromChangelog\".\"ValueType\"          AS \"ValueType\",\n            \"CTE_BlockFromChangelog\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"CTE_BlockFromChangelog\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"CTE_BlockFromChangelog\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"CTE_BlockFromChangelog\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"CTE_BlockFromChangelog\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"CTE_BlockFromChangelog\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"CTE_BlockFromChangelog\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_BlockFromChangelog\"\n    ),\n    \"CTE_Block\" AS (\n        SELECT\n            *,\n            ROW_NUMBER()\n            OVER (PARTITION BY \"CTE_BlockNoRN\".\"BlockID\", \"CTE_BlockNoRN\".\"BlockType\" ORDER BY \"CTE_BlockNoRN\".\"BlockTime\" ASC) AS \"BlockRN\"\n        FROM \"CTE_BlockNoRN\"\n    )\n/* Actual attribute mapping for object */\nSELECT\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockID\" \n        || '::' || \"Block\".\"SystemBlockNumber\" \n        || '::' || \"Block\".\"BlockType\"                           AS \"ID\",\n    \"Block\".\"BlockTime\"                                          AS \"CreationTime\",\n    COALESCE(\"Block\".\"BlockType\", \"Releases\".\"ReleaseType\")      AS \"BlockType\",\n    \"Block\".\"VALUE_NEW\"                                          AS \"FirstBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'BillingBlock'\n            THEN COALESCE(\"VBAK\".\"FAKSK\", 'Data cut - no entry in VBAK')\n    END                                                          AS \"LatestBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'BillingBlock'\n            THEN \"TVFST\".\"VTEXT\"\n    END                                                          AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockedBy\"             AS \"BlockedBy\",\n    \"Block\".\"BlockExecutionType\"                                 AS \"BlockExecutionType\",\n    CASE WHEN \"Block\".\"SystemBlockNumber\" = '-1' THEN 'X' END    AS \"BlockFromSalesOrder\",\n    \"Releases\".\"ReleaseTime\"                                     AS \"ReleaseTime\",\n    \"Releases\".\"ReleaseType\"                                     AS \"ReleaseType\",\n    \"Releases\".\"VALUE_OLD\"                                       AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"Releases\".\"ReleasedBy_ID\"      AS \"ReleasedBy\",\n    \"Releases\".\"ReleaseExecutionType\"                            AS \"ReleaseExecutionType\",\n    <%=sourceSystem%> || '::' || \"Block\".\"SalesOrderID\"          AS \"SalesOrder\",\n    <%=sourceSystem%> || '::' || \"Block\".\"MANDANT\"               AS \"SourceSystemInstance\"\nFROM \"CTE_Block\" AS \"Block\"\nLEFT JOIN \"CTE_Releases\" AS \"Releases\"\n    ON \"Block\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n        AND \"Block\".\"BlockRN\" = \"Releases\".\"ReleaseRN\"\n        AND \"Block\".\"BlockType\" = \"Releases\".\"ReleaseType\"\nLEFT JOIN \"VBAK\" AS \"VBAK\"\n    ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        AND (NULLIF(\"VBAK\".\"FAKSK\", '') IS NOT NULL)\nLEFT JOIN \"TVFST\" AS \"TVFST\"\n    ON \"VBAK\".\"MANDT\" = \"TVFST\".\"MANDT\"\n        AND \"VBAK\".\"FAKSK\" = \"TVFST\".\"FAKSP\"\n        AND \"TVFST\".\"SPRAS\" = <%=LanguageKey%>"
                    },
                    {
                        "id": "CreditBlock",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "/* \n1. CTE_Releases: All recorded Release Events (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NULL)\n2. CTE_Changes: All recorded changes of the BlockingField (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NOT NULL)\n3. CTE_BlockFromChangelog: All recorded Block sets (except the ones during creation) (OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL)\n4. CTE_ImplicitActiveBlocks: Block field is NOT NULL (-> we know there is a block) and no entries in BlocksFromChangeLog\n5. CTE_FirstAction: Aggregate Changelog per ObjectID. Keep the earliest entry.\n6. CTE_ImplicitInactiveBlocks: FirstAction for a specific ObjectID is either a Release or a Change -> Implicit Block\n7. CTE_Block: UNION of 3, 4 and 6 */\n/*\nRecreated Information: Joined relevant information from CDPOS (change doc Item) and CDHDR (change doc Header)\nto build a base table with all fields needed to build the CTE tables to capture all relevant changes to block statues.\n */\nWITH \"CTE_JoinTable\" AS (\n    SELECT\n        <%=sourceSystem%>\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)                       AS \"JoinID\",\n        CAST(CONCAT(CAST(\"CDHDR\".\"UDATE\" AS VARCHAR), COALESCE(SUBSTRING(\n            CAST(\"CDHDR\".\"UTIME\" AS VARCHAR), 11, 19),\n            '23:59:59')) AS TIMESTAMP)                                          AS \"JoinTime\",\n        \"CDHDR\".\"MANDANT\"                                                       AS \"MANDANT\",\n        \"CDHDR\".\"UDATE\"                                                         AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                                         AS \"UTIME\",\n        \"CDPOS\".\"FNAME\"                                                         AS \"FNAME\",\n        \"CDPOS\".\"TABNAME\"                                                       AS \"TABNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                                     AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                                     AS \"VALUE_OLD\",\n        \"CDHDR\".\"MANDANT\" || '::' || \"CDHDR\".\"USERNAME\"                         AS \"JoinUserID\",\n        CASE\n            WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                THEN 'Automatic'\n            ELSE 'Manual'\n        END                                                                     AS \"JoinExecutionType\",\n        \"CDHDR\".\"TCODE\"                                                         AS \"JoinOperationType\",\n        \"CDHDR\".\"CHANGENR\"                                                      AS \"JoinSystemNumber\",\n        \"CDPOS\".\"OBJECTCLAS\"                                                    AS \"OBJECTCLAS\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK')\n            AND \"CDPOS\".\"FNAME\" IN ('CMGST')\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n/* Recreated Information : Capture release of blocks (credit block from VBAK, Condition on scenarios where VALUE_OLD IS NOT NULL,\nand VALUE_NEW IS NULL  */\n    \"CTE_Releases\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"ReleasesID\",\n            \"JoinTable\".\"JoinTime\"                                                                                                  AS \"ReleaseTime\",\n            \"JoinTable\".\"MANDANT\"                                                                                                   AS \"MANDANT\",\n            'CreditBlock'                                                                                                           AS \"ReleaseType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                                                                                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                                                                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                                                                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                                                                                AS \"ReleasedBy_ID\",\n            \"JoinTable\".\"JoinExecutionType\"                                                                                         AS \"ReleaseExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                                                                                         AS \"ReleaseOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                                                                                          AS \"SystemReleaseNumber\",\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"SalesOrderID\",\n            ROW_NUMBER()\n            OVER (PARTITION BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\" ORDER BY \"JoinTable\".\"UDATE\" ASC, \"JoinTable\".\"UTIME\" ASC) AS \"ReleaseRN\" /* assigns a sequential number (\"ReleaseRN\") to each record, ordered chronologically by date and time, \n            but restarts the numbering for every unique combination of \"JoinID\" and \"FNAME\" */\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NULL\n    ),\n/* Recreated Information : Captures all changes occurring to blocks (Excluding setting of block at creation or at a later stage , and release of block).\nMust meet condition of scenario: VALUE_OLD AND VALUE_NEW IS NOT NULL  */\n    \"CTE_Changes\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"ID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"ChangeTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'CreditBlock'                          AS \"ChangeType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"ChangeBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"ChangeExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"ChangeOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"ChangeID\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: All recorded Block sets (except the ones during creation)\nMust meet condition of scenario: OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL */\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'CreditBlock'                          AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"BlockedBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"BlockExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"BlockOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: Based on VBAK , captures sales orders which are currently blocked, uses the prior CTE tables to ensure that this sales order\nhas no change entries. Queries each block type seperately, and unions all together.\nMust meet condition of scenario: Block field is NOT NULL (actively blocked) and no entries in BlocksFromChangeLog */\n    \"CTE_ImplicitActiveBlock\" AS (\n        SELECT\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"BlockID\",\n            CAST(CONCAT(CAST(\"VBAK\".\"ERDAT\" AS VARCHAR), SUBSTRING(\n                CAST(\"VBAK\".\"ERZET\" AS VARCHAR), 11, 19)) AS TIMESTAMP)                  AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                               AS \"MANDANT\",\n            'CreditBlock'                                                                AS \"BlockType\",\n            'Block to ' || \"VBAK\".\"CMGST\"                                                AS \"ValueType\",\n            \"VBAK\".\"CMGST\"                                                               AS \"VALUE_NEW\",\n            NULL                                                                         AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"        AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                          AS \"BlockExecutionType\",\n            NULL                                                                         AS \"BlockOperationType\",\n            '-1'                                                                         AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                      AS \"SalesOrderID\"\n        FROM \"VBAK\" AS \"VBAK\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"Block\"\n            ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"Releases\".\"ReleasesID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"Changes\".\"ID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"Block\".\"BlockID\", '') IS NULL\n            AND NULLIF(\"Changes\".\"ID\", '') IS NULL\n            AND NULLIF(\"Releases\".\"ReleasesID\", '') IS NULL\n            AND NULLIF(\"VBAK\".\"CMGST\", '') IS NOT NULL\n    ),\n/* Recreated Information: Indicating the earliest timestamp when a credit block\nwas set for a given record (CDPOS.TABKEY) , split per ObjectID.  */\n    \"CTE_FirstAction\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"        AS \"BlockID\",\n            MIN(\"JoinTable\".\"JoinTime\") AS \"BlockTime\",\n            'CreditBlock'               AS \"BlockType\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        GROUP BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    ),\n/* Recreated Information: identifies an active credit block from a sales order's creation.\nIt links the earliest block times (from CTE_FirstAction) with sales order details and\nchecks for matching initial change or release records to define these \"implicit\" block activations.\n\nThe CTE assumes that if a block type identified in CTE_FirstAction exists for a sales order,\nand there isn't a specific change or release event recorded at the BlockTime from CTE_FirstAction,\nthen the block was implicitly active from the moment the sales order was created. */\n    \"CTE_ImplicitInactiveBlock\" AS (\n        SELECT\n            \"FirstAction\".\"BlockID\"                                                        AS \"BlockID\",\n            CAST(CONCAT(CAST(\"VBAK\".\"ERDAT\" AS VARCHAR), SUBSTRING(\n              CAST(\"VBAK\".\"ERZET\" AS VARCHAR), 11, 19)) AS TIMESTAMP)                      AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                                 AS \"MANDANT\",\n            \"FirstAction\".\"BlockType\"                                                      AS \"BlockType\",\n            'Block to '\n                ||\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"ValueType\", -- Checks for a change event first, if non-existant checks for release event\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"VALUE_NEW\",\n            NULL                                                                           AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"          AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                            AS \"BlockExecutionType\",\n            NULL                                                                           AS \"BlockOperationType\",\n            '-1'                                                                           AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                        AS \"SalesOrderID\"\n        FROM \"CTE_FirstAction\" AS \"FirstAction\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"FirstAction\".\"BlockID\" = \"Changes\".\"ID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Changes\".\"ChangeTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Changes\".\"ChangeType\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"FirstAction\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Releases\".\"ReleaseTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Releases\".\"ReleaseType\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"FirstAction\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND (NULLIF(\"Changes\".\"ID\", '') IS NOT NULL\n            OR NULLIF(\"Releases\".\"ReleasesID\", '') IS NOT NULL)\n    ),\n/* Recreated Information: CTE_ImplicitDuplicates identifies block events that appear in both CTE_ImplicitInactiveBlock\nand CTE_ImplicitActiveBlock (based on BlockID, BlockTime, and BlockType), effectively finding duplicate records of the same block event.\n*/\n    \"CTE_ImplicitDuplicates\" AS (\n        SELECT\n            \"Inactive\".\"BlockID\",\n            \"Inactive\".\"BlockTime\",\n            \"Inactive\".\"BlockType\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"Inactive\"\n        LEFT JOIN \"CTE_ImplicitActiveBlock\" AS \"Active\"\n            ON \"Inactive\".\"BlockID\" = \"Active\".\"BlockID\"\n                AND \"Inactive\".\"BlockTime\" = \"Active\".\"BlockTime\"\n                AND \"Inactive\".\"BlockType\" = \"Active\".\"BlockType\"\n        WHERE NULLIF(\"Active\".\"BlockID\", '') IS NOT NULL\n    ),\n/* Recreated Information: CTE_ImplicitActiveBlockNoDuplicates selects active implicit block records\nfrom CTE_ImplicitActiveBlock, excluding any records that are also found in CTE_ImplicitDuplicates.\nThis results in a set of unique active implicit block events.\n\nThis CTE removes duplicates between the ImplicitBlock CTEs from ActiveBlocks.\n*/\n    \"CTE_ImplicitActiveBlockNoDuplicates\" AS (\n        SELECT\n            \"Active\".*\n        FROM \"CTE_ImplicitActiveBlock\" AS \"Active\"\n        LEFT JOIN \"CTE_ImplicitDuplicates\" AS \"Duplicates\"\n            ON \"Active\".\"BlockID\" = \"Duplicates\".\"BlockID\"\n                AND \"Active\".\"BlockTime\" = \"Duplicates\".\"BlockTime\"\n                AND \"Active\".\"BlockType\" = \"Duplicates\".\"BlockType\"\n        WHERE NULLIF(\"Duplicates\".\"BlockID\", '') IS NULL\n    ),\n/* Recreated Information: Combines all entries with sales orders which currently have a credit block , sales orders implicitly blocked\n(blocked since moment of creation), and the log of all recorded Block sets (except the ones during creation)   */\n    \"CTE_BlockNoRN\" AS (\n        SELECT\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitActiveBlockNoDuplicates\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitActiveBlockNoDuplicates\" AS \"ImplicitActiveBlockNoDuplicates\"\n        UNION\n        SELECT\n            \"ImplicitInactiveBlock\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitInactiveBlock\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitInactiveBlock\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitInactiveBlock\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitInactiveBlock\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitInactiveBlock\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitInactiveBlock\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitInactiveBlock\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitInactiveBlock\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitInactiveBlock\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitInactiveBlock\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitInactiveBlock\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"ImplicitInactiveBlock\"\n        UNION\n        SELECT\n            \"CTE_BlockFromChangelog\".\"BlockID\"            AS \"BlockID\",\n            \"CTE_BlockFromChangelog\".\"BlockTime\"          AS \"BlockTime\",\n            \"CTE_BlockFromChangelog\".\"MANDANT\"            AS \"MANDANT\",\n            \"CTE_BlockFromChangelog\".\"BlockType\"          AS \"BlockType\",\n            \"CTE_BlockFromChangelog\".\"ValueType\"          AS \"ValueType\",\n            \"CTE_BlockFromChangelog\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"CTE_BlockFromChangelog\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"CTE_BlockFromChangelog\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"CTE_BlockFromChangelog\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"CTE_BlockFromChangelog\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"CTE_BlockFromChangelog\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"CTE_BlockFromChangelog\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_BlockFromChangelog\"\n    ),\n    \"CTE_Block\" AS (\n        SELECT\n            *,\n            ROW_NUMBER()\n            OVER (PARTITION BY \"CTE_BlockNoRN\".\"BlockID\", \"CTE_BlockNoRN\".\"BlockType\" ORDER BY \"CTE_BlockNoRN\".\"BlockTime\" ASC) AS \"BlockRN\"\n        FROM \"CTE_BlockNoRN\"\n    )\n/* Actual attribute mapping for object */\nSELECT\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockID\"\n        || '::' || \"Block\".\"SystemBlockNumber\"\n        || '::' || \"Block\".\"BlockType\"                           AS \"ID\",\n    \"Block\".\"BlockTime\"                                          AS \"CreationTime\",\n    COALESCE(\"Block\".\"BlockType\", \"Releases\".\"ReleaseType\")      AS \"BlockType\",\n    \"Block\".\"VALUE_NEW\"                                          AS \"FirstBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'CreditBlock'\n            THEN COALESCE(\"VBAK\".\"CMGST\", 'Data cut - no entry in VBAK')\n    END                                                          AS \"LatestBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n    END                                                          AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockedBy\"             AS \"BlockedBy\",\n    \"Block\".\"BlockExecutionType\"                                 AS \"BlockExecutionType\",\n    CASE WHEN \"Block\".\"SystemBlockNumber\" = '-1' THEN 'X' END    AS \"BlockFromSalesOrder\",\n    \"Releases\".\"ReleaseTime\"                                     AS \"ReleaseTime\",\n    \"Releases\".\"ReleaseType\"                                     AS \"ReleaseType\",\n    \"Releases\".\"VALUE_OLD\"                                       AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"Releases\".\"ReleasedBy_ID\"      AS \"ReleasedBy\",\n    \"Releases\".\"ReleaseExecutionType\"                            AS \"ReleaseExecutionType\",\n    <%=sourceSystem%> || '::' || \"Block\".\"SalesOrderID\"          AS \"SalesOrder\",\n    <%=sourceSystem%> || '::' || \"Block\".\"MANDANT\"               AS \"SourceSystemInstance\"\nFROM \"CTE_Block\" AS \"Block\"\nLEFT JOIN \"CTE_Releases\" AS \"Releases\"\n    ON \"Block\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n        AND \"Block\".\"BlockRN\" = \"Releases\".\"ReleaseRN\"\n        AND \"Block\".\"BlockType\" = \"Releases\".\"ReleaseType\"\nLEFT JOIN \"VBAK\" AS \"VBAK\"\n    ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        AND (NULLIF(\"VBAK\".\"CMGST\", '') IS NOT NULL)\nLEFT JOIN \"TVFST\" AS \"TVFST\"\n    ON \"VBAK\".\"MANDT\" = \"TVFST\".\"MANDT\"\n        AND \"VBAK\".\"CMGST\" = \"TVFST\".\"FAKSP\"\n        AND \"TVFST\".\"SPRAS\" = <%=LanguageKey%>"
                    },
                    {
                        "id": "DeliveryBlock",
                        "type_": "SQL_FACTORY_DATA_SET",
                        "complete_overwrite": false,
                        "disabled": false,
                        "materialise_cte": false,
                        "overwrite": null,
                        "sql": "/* \n1. CTE_Releases: All recorded Release Events (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NULL)\n2. CTE_Changes: All recorded changes of the BlockingField (OLD_VALUE IS NOT NULL AND NEW_VALUE IS NOT NULL)\n3. CTE_BlockFromChangelog: All recorded Block sets (except the ones during creation) (OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL)\n4. CTE_ImplicitActiveBlocks: Block field is NOT NULL (-> we know there is a block) and no entries in BlocksFromChangeLog\n5. CTE_FirstAction: Aggregate Changelog per ObjectID. Keep the earliest entry.\n6. CTE_ImplicitInactiveBlocks: FirstAction for a specific ObjectID is either a Release or a Change -> Implicit Block\n7. CTE_Block: UNION of 3, 4 and 6 */\n/*\nRecreated Information: Joined relevant information from CDPOS (change doc Item) and CDHDR (change doc Header)\nto build a base table with all fields needed to build the CTE tables to capture all relevant changes to block statues.\n */\nWITH \"CTE_JoinTable\" AS (\n    SELECT\n        <%=sourceSystem%>\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 1, 3)\n            || '::' || SUBSTRING(\"CDPOS\".\"TABKEY\", 4, 10)                       AS \"JoinID\",\n        CAST(CONCAT(CAST(\"CDHDR\".\"UDATE\" AS VARCHAR), COALESCE(SUBSTRING(\n            CAST(\"CDHDR\".\"UTIME\" AS VARCHAR), 11, 19),\n            '23:59:59')) AS TIMESTAMP)                                          AS \"JoinTime\",\n        \"CDHDR\".\"MANDANT\"                                                       AS \"MANDANT\",\n        \"CDHDR\".\"UDATE\"                                                         AS \"UDATE\",\n        \"CDHDR\".\"UTIME\"                                                         AS \"UTIME\",\n        \"CDPOS\".\"FNAME\"                                                         AS \"FNAME\",\n        \"CDPOS\".\"TABNAME\"                                                       AS \"TABNAME\",\n        \"CDPOS\".\"VALUE_NEW\"                                                     AS \"VALUE_NEW\",\n        \"CDPOS\".\"VALUE_OLD\"                                                     AS \"VALUE_OLD\",\n        \"CDHDR\".\"MANDANT\" || '::' || \"CDHDR\".\"USERNAME\"                         AS \"JoinUserID\",\n        CASE\n            WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                THEN 'Automatic'\n            ELSE 'Manual'\n        END                                                                     AS \"JoinExecutionType\",\n        \"CDHDR\".\"TCODE\"                                                         AS \"JoinOperationType\",\n        \"CDHDR\".\"CHANGENR\"                                                      AS \"JoinSystemNumber\",\n        \"CDPOS\".\"OBJECTCLAS\"                                                    AS \"OBJECTCLAS\"\n    FROM \"CDPOS\" AS \"CDPOS\"\n    INNER JOIN \"CDHDR\" AS \"CDHDR\"\n        ON \"CDPOS\".\"MANDANT\" = \"CDHDR\".\"MANDANT\"\n            AND \"CDPOS\".\"OBJECTCLAS\" = \"CDHDR\".\"OBJECTCLAS\"\n            AND \"CDPOS\".\"OBJECTID\" = \"CDHDR\".\"OBJECTID\"\n            AND \"CDPOS\".\"CHANGENR\" = \"CDHDR\".\"CHANGENR\"\n            AND \"CDPOS\".\"CHNGIND\" = 'U'\n            AND \"CDPOS\".\"TABNAME\" IN ('VBAK')\n            AND \"CDPOS\".\"FNAME\" IN ('LIFSK')\n            AND \"CDPOS\".\"OBJECTCLAS\" = 'VERKBELEG'\n    LEFT JOIN \"USR02\" AS \"USR02\"\n        ON \"CDHDR\".\"MANDANT\" = \"USR02\".\"MANDT\"\n            AND \"CDHDR\".\"USERNAME\" = \"USR02\".\"BNAME\"\n),\n/* Recreated Information : Capture release of blocks (Delivery block from VBAK), Condition on scenarios where VALUE_OLD IS NOT NULL ,\nand VALUE_NEW IS NULL */\n    \"CTE_Releases\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"ReleasesID\",\n            \"JoinTable\".\"JoinTime\"                                                                                                  AS \"ReleaseTime\",\n            \"JoinTable\".\"MANDANT\"                                                                                                   AS \"MANDANT\",\n            'DeliveryBlock'                                                                                                         AS \"ReleaseType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\"                                                                                  AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                                                                                                 AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                                                                                                 AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"                                                                                                AS \"ReleasedBy_ID\",\n            \"JoinTable\".\"JoinExecutionType\"                                                                                         AS \"ReleaseExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"                                                                                         AS \"ReleaseOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"                                                                                          AS \"SystemReleaseNumber\",\n            \"JoinTable\".\"JoinID\"                                                                                                    AS \"SalesOrderID\",\n            ROW_NUMBER()\n            OVER (PARTITION BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\" ORDER BY \"JoinTable\".\"UDATE\" ASC, \"JoinTable\".\"UTIME\" ASC) AS \"ReleaseRN\" /* assigns a sequential number (\"ReleaseRN\") to each record, \n            ordered chronologically by date and time, but restarts the numbering for every unique combination of \"JoinID\" and \"FNAME\" */\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE \"JoinTable\".\"TABNAME\" = 'VBAK'\n            AND \"JoinTable\".\"FNAME\" IN ('LIFSK')\n            AND NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NULL\n    ),\n/* Recreated Information : Captures all changes occurring to delivery blocks (Excluding setting of block at creation or at a later stage , and release of block).\nMust meet condition of scenario: VALUE_OLD AND VALUE_NEW IS NOT NULL  */\n    \"CTE_Changes\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"ID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"ChangeTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'DeliveryBlock'                        AS \"ChangeType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"ChangeBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"ChangeExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"ChangeOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"ChangeID\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NOT NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: All recorded Delivery Block sets (except the ones during creation)\nMust meet condition of scenario: OLD_VALUE IS NULL AND NEW_VALUE IS NOT NULL */\n    \"CTE_BlockFromChangelog\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"                   AS \"BlockID\",\n            \"JoinTable\".\"JoinTime\"                 AS \"BlockTime\",\n            \"JoinTable\".\"MANDANT\"                  AS \"MANDANT\",\n            'DeliveryBlock'                        AS \"BlockType\",\n            'Block to ' || \"JoinTable\".\"VALUE_NEW\" AS \"ValueType\",\n            \"JoinTable\".\"VALUE_NEW\"                AS \"VALUE_NEW\",\n            \"JoinTable\".\"VALUE_OLD\"                AS \"VALUE_OLD\",\n            \"JoinTable\".\"JoinUserID\"               AS \"BlockedBy\",\n            \"JoinTable\".\"JoinExecutionType\"        AS \"BlockExecutionType\",\n            \"JoinTable\".\"JoinOperationType\"        AS \"BlockOperationType\",\n            \"JoinTable\".\"JoinSystemNumber\"         AS \"SystemBlockNumber\",\n            \"JoinTable\".\"JoinID\"                   AS \"SalesOrderID\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        WHERE NULLIF(\"JoinTable\".\"VALUE_OLD\", '') IS NULL\n            AND NULLIF(\"JoinTable\".\"VALUE_NEW\", '') IS NOT NULL\n    ),\n/* Recreated Information: Based on VBAK , captures sales orders which currently have a delivery block, uses the prior CTE tables to ensure that this sales order\nhas no change entries. Queries each block type seperately, and unions all together.\nMust meet condition of scenario: Block field is NOT NULL (actively blocked) and no entries in BlocksFromChangeLog */\n    \"CTE_ImplicitActiveBlock\" AS (\n        SELECT\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                     AS \"BlockID\",\n            CAST(CONCAT(CAST(\"VBAK\".\"ERDAT\" AS VARCHAR), SUBSTRING(\n                CAST(\"VBAK\".\"ERZET\" AS VARCHAR), 11, 19))\n                AS TIMESTAMP)                                                            AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                               AS \"MANDANT\",\n            'DeliveryBlock'                                                              AS \"BlockType\",\n            'Block to ' || \"VBAK\".\"LIFSK\"                                                AS \"ValueType\",\n            \"VBAK\".\"LIFSK\"                                                               AS \"VALUE_NEW\",\n            NULL                                                                         AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"        AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                          AS \"BlockExecutionType\",\n            NULL                                                                         AS \"BlockOperationType\",\n            '-1'                                                                         AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                      AS \"SalesOrderID\"\n        FROM \"VBAK\" AS \"VBAK\"\n        LEFT JOIN \"CTE_BlockFromChangelog\" AS \"Block\"\n            ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"Releases\".\"ReleasesID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"Changes\".\"ID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"Block\".\"BlockID\", '') IS NULL\n            AND NULLIF(\"Changes\".\"ID\", '') IS NULL\n            AND NULLIF(\"Releases\".\"ReleasesID\", '') IS NULL\n            AND NULLIF(\"VBAK\".\"LIFSK\", '') IS NOT NULL\n    ),\n/* Recreated Information: Indicating the earliest timestamp when a delivery block was set for a given record (CDPOS.TABKEY) , split per ObjectID.  */\n    \"CTE_FirstAction\" AS (\n        SELECT\n            \"JoinTable\".\"JoinID\"        AS \"BlockID\",\n            MIN(\"JoinTable\".\"JoinTime\") AS \"BlockTime\",\n            'DeliveryBlock'             AS \"BlockType\"\n        FROM \"CTE_JoinTable\" AS \"JoinTable\"\n        GROUP BY \"JoinTable\".\"JoinID\", \"JoinTable\".\"FNAME\"\n    ),\n/* Recreated Information: identifies delivery blocks active from a sales order's creation.\nIt links the earliest block times (from CTE_FirstAction) with sales order details and\nchecks for matching initial change or release records to define these \"implicit\" block activations.\n\nThe CTE assumes that if a block type identified in CTE_FirstAction exists for a sales order,\nand there isn't a specific change or release event recorded at the BlockTime from CTE_FirstAction,\nthen the block was implicitly active from the moment the sales order was created. */\n    \"CTE_ImplicitInactiveBlock\" AS (\n        SELECT\n            \"FirstAction\".\"BlockID\"                                                        AS \"BlockID\",\n            CAST(CONCAT(CAST(\"VBAK\".\"ERDAT\" AS VARCHAR), SUBSTRING(\n              CAST(\"VBAK\".\"ERZET\" AS VARCHAR), 11, 19)) AS TIMESTAMP)                      AS \"BlockTime\",\n            \"VBAK\".\"MANDT\"                                                                 AS \"MANDANT\",\n            \"FirstAction\".\"BlockType\"                                                      AS \"BlockType\",\n            'Block to '\n                ||\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"ValueType\", -- Checks for a change event first, if non-existant checks for release event\n            COALESCE(\"Changes\".\"VALUE_OLD\", \"Releases\".\"VALUE_OLD\")                        AS \"VALUE_NEW\",\n            NULL                                                                           AS \"VALUE_OLD\",\n            <%=sourceSystem%> || '::' || \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"ERNAM\"          AS \"BlockedBy\",\n            CASE\n                WHEN \"USR02\".\"USTYP\" IN ('B', 'C')\n                    THEN 'Automatic'\n                ELSE 'Manual'\n            END                                                                            AS \"BlockExecutionType\",\n            NULL                                                                           AS \"BlockOperationType\",\n            '-1'                                                                           AS \"SystemBlockNumber\",\n            \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"                                        AS \"SalesOrderID\"\n        FROM \"CTE_FirstAction\" AS \"FirstAction\"\n        LEFT JOIN \"CTE_Changes\" AS \"Changes\"\n            ON \"FirstAction\".\"BlockID\" = \"Changes\".\"ID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Changes\".\"ChangeTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Changes\".\"ChangeType\"\n        LEFT JOIN \"CTE_Releases\" AS \"Releases\"\n            ON \"FirstAction\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n                AND \"FirstAction\".\"BlockTime\" = \"Releases\".\"ReleaseTime\"\n                AND \"FirstAction\".\"BlockType\" = \"Releases\".\"ReleaseType\"\n        LEFT JOIN \"VBAK\" AS \"VBAK\"\n            ON \"FirstAction\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        LEFT JOIN \"USR02\" AS \"USR02\"\n            ON \"VBAK\".\"MANDT\" = \"USR02\".\"MANDT\"\n                AND \"VBAK\".\"ERNAM\" = \"USR02\".\"BNAME\"\n        WHERE NULLIF(\"VBAK\".\"MANDT\", '') IS NOT NULL\n            AND (NULLIF(\"Changes\".\"ID\", '') IS NOT NULL\n            OR NULLIF(\"Releases\".\"ReleasesID\", '') IS NOT NULL)\n    ),\n/* Recreated Information: CTE_ImplicitDuplicates identifies block events that appear in both CTE_ImplicitInactiveBlock\nand CTE_ImplicitActiveBlock (based on BlockID, BlockTime, and BlockType), effectively finding duplicate records of the same block event.\n*/\n    \"CTE_ImplicitDuplicates\" AS (\n        SELECT\n            \"Inactive\".\"BlockID\",\n            \"Inactive\".\"BlockTime\",\n            \"Inactive\".\"BlockType\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"Inactive\"\n        LEFT JOIN \"CTE_ImplicitActiveBlock\" AS \"Active\"\n            ON \"Inactive\".\"BlockID\" = \"Active\".\"BlockID\"\n                AND \"Inactive\".\"BlockTime\" = \"Active\".\"BlockTime\"\n                AND \"Inactive\".\"BlockType\" = \"Active\".\"BlockType\"\n        WHERE NULLIF(\"Active\".\"BlockID\", '') IS NOT NULL\n    ),\n/* Recreated Information: CTE_ImplicitActiveBlockNoDuplicates selects active implicit block records\nfrom CTE_ImplicitActiveBlock, excluding any records that are also found in CTE_ImplicitDuplicates.\nThis results in a set of unique active implicit block events.\n\nThis CTE removes duplicates between the ImplicitBlock CTEs from ActiveBlocks.\n*/\n    \"CTE_ImplicitActiveBlockNoDuplicates\" AS (\n        SELECT\n            \"Active\".*\n        FROM \"CTE_ImplicitActiveBlock\" AS \"Active\"\n        LEFT JOIN \"CTE_ImplicitDuplicates\" AS \"Duplicates\"\n            ON \"Active\".\"BlockID\" = \"Duplicates\".\"BlockID\"\n                AND \"Active\".\"BlockTime\" = \"Duplicates\".\"BlockTime\"\n                AND \"Active\".\"BlockType\" = \"Duplicates\".\"BlockType\"\n        WHERE NULLIF(\"Duplicates\".\"BlockID\", '') IS NULL\n    ),\n/* Recreated Information: Combines all entries with sales orders which are currently blocked , sales orders implicitly blocked\n(blocked since moment of creation), and the log of all recorded Block sets (except the ones during creation)   */\n    \"CTE_BlockNoRN\" AS (\n        SELECT\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitActiveBlockNoDuplicates\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitActiveBlockNoDuplicates\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitActiveBlockNoDuplicates\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitActiveBlockNoDuplicates\" AS \"ImplicitActiveBlockNoDuplicates\"\n        UNION\n        SELECT\n            \"ImplicitInactiveBlock\".\"BlockID\"            AS \"BlockID\",\n            \"ImplicitInactiveBlock\".\"BlockTime\"          AS \"BlockTime\",\n            \"ImplicitInactiveBlock\".\"MANDANT\"            AS \"MANDANT\",\n            \"ImplicitInactiveBlock\".\"BlockType\"          AS \"BlockType\",\n            \"ImplicitInactiveBlock\".\"ValueType\"          AS \"ValueType\",\n            \"ImplicitInactiveBlock\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"ImplicitInactiveBlock\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"ImplicitInactiveBlock\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"ImplicitInactiveBlock\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"ImplicitInactiveBlock\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"ImplicitInactiveBlock\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"ImplicitInactiveBlock\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_ImplicitInactiveBlock\" AS \"ImplicitInactiveBlock\"\n        UNION\n        SELECT\n            \"CTE_BlockFromChangelog\".\"BlockID\"            AS \"BlockID\",\n            \"CTE_BlockFromChangelog\".\"BlockTime\"          AS \"BlockTime\",\n            \"CTE_BlockFromChangelog\".\"MANDANT\"            AS \"MANDANT\",\n            \"CTE_BlockFromChangelog\".\"BlockType\"          AS \"BlockType\",\n            \"CTE_BlockFromChangelog\".\"ValueType\"          AS \"ValueType\",\n            \"CTE_BlockFromChangelog\".\"VALUE_NEW\"          AS \"VALUE_NEW\",\n            \"CTE_BlockFromChangelog\".\"VALUE_OLD\"          AS \"VALUE_OLD\",\n            \"CTE_BlockFromChangelog\".\"BlockedBy\"          AS \"BlockedBy\",\n            \"CTE_BlockFromChangelog\".\"BlockExecutionType\" AS \"BlockExecutionType\",\n            \"CTE_BlockFromChangelog\".\"BlockOperationType\" AS \"BlockOperationType\",\n            \"CTE_BlockFromChangelog\".\"SystemBlockNumber\"  AS \"SystemBlockNumber\",\n            \"CTE_BlockFromChangelog\".\"SalesOrderID\"       AS \"SalesOrderID\"\n        FROM \"CTE_BlockFromChangelog\"\n    ),\n    \"CTE_Block\" AS (\n        SELECT\n            *,\n            ROW_NUMBER()\n            OVER (PARTITION BY \"CTE_BlockNoRN\".\"BlockID\", \"CTE_BlockNoRN\".\"BlockType\" ORDER BY \"CTE_BlockNoRN\".\"BlockTime\" ASC) AS \"BlockRN\"\n        FROM \"CTE_BlockNoRN\"\n    )\n/* Actual attribute mapping for object */\nSELECT\n    <%=sourceSystem%> || '::'|| \"Block\".\"BlockID\"\n        || '::' || \"Block\".\"SystemBlockNumber\"\n        || '::' || \"Block\".\"BlockType\"                           AS \"ID\",\n    \"Block\".\"BlockTime\"                                          AS \"CreationTime\",\n    COALESCE(\"Block\".\"BlockType\", \"Releases\".\"ReleaseType\")      AS \"BlockType\",\n    \"Block\".\"VALUE_NEW\"                                          AS \"FirstBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'DeliveryBlock'\n            THEN COALESCE(\"VBAK\".\"LIFSK\", 'Data cut - no entry in VBAK')\n    END                                                          AS \"LatestBlockReason\",\n    CASE\n        WHEN NULLIF(\"Releases\".\"ReleaseType\", '') IS NOT NULL\n            THEN \"Releases\".\"VALUE_NEW\"\n        WHEN \"Block\".\"BlockType\" = 'DeliveryBlock'\n            THEN \"TVLST\".\"VTEXT\"\n    END                                                          AS \"LatestBlockReasonText\",\n    <%=sourceSystem%> || '::' || \"Block\".\"BlockedBy\"             AS \"BlockedBy\",\n    \"Block\".\"BlockExecutionType\"                                 AS \"BlockExecutionType\",\n    CASE WHEN \"Block\".\"SystemBlockNumber\" = '-1' THEN 'X' END    AS \"BlockFromSalesOrder\",\n    \"Releases\".\"ReleaseTime\"                                     AS \"ReleaseTime\",\n    \"Releases\".\"ReleaseType\"                                     AS \"ReleaseType\",\n    \"Releases\".\"VALUE_OLD\"                                       AS \"ReleaseReason\",\n    <%=sourceSystem%> || '::' || \"Releases\".\"ReleasedBy_ID\"      AS \"ReleasedBy\",\n    \"Releases\".\"ReleaseExecutionType\"                            AS \"ReleaseExecutionType\",\n    <%=sourceSystem%> || '::' || \"Block\".\"SalesOrderID\"          AS \"SalesOrder\",\n    <%=sourceSystem%> || '::' || \"Block\".\"MANDANT\"               AS \"SourceSystemInstance\"\nFROM \"CTE_Block\" AS \"Block\"\nLEFT JOIN \"CTE_Releases\" AS \"Releases\"\n    ON \"Block\".\"BlockID\" = \"Releases\".\"ReleasesID\"\n        AND \"Block\".\"BlockRN\" = \"Releases\".\"ReleaseRN\"\n        AND \"Block\".\"BlockType\" = \"Releases\".\"ReleaseType\"\nLEFT JOIN \"VBAK\" AS \"VBAK\"\n    ON \"Block\".\"BlockID\" = \"VBAK\".\"MANDT\" || '::' || \"VBAK\".\"VBELN\"\n        AND (NULLIF(\"VBAK\".\"LIFSK\", '') IS NOT NULL)\nLEFT JOIN \"TVLST\" AS \"TVLST\"\n    ON \"VBAK\".\"MANDT\" = \"TVLST\".\"MANDT\"\n        AND \"VBAK\".\"LIFSK\" = \"TVLST\".\"LIFSP\"\n        AND \"TVLST\".\"SPRAS\" = <%=LanguageKey%>"
                    }
                ],
                "relationship_transformations": []
            }
        ]
    }
]